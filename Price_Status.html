<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guild Wars 2 Trading Post Tracker</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; }
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px; justify-content:center; position:relative; }
        .input-group { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:600px; }
        input { padding:12px 15px; border:none; border-radius:5px; background:rgba(255,255,255,0.1); color:white; width:250px; font-size:1rem; border:1px solid #3498db; flex:1; min-width:200px; }
        input::placeholder { color:#95a5a6; }
        button { padding:12px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; }
        .search-results { position:absolute; top:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); border:1px solid #3498db; border-radius:5px; width:90%; max-width:500px; max-height:300px; overflow-y:auto; z-index:10; margin-top:5px; display:none; }
        .search-result-item { padding:10px 15px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
        .search-result-item:last-child { border-bottom:none; }
        .search-result-item:hover { background: rgba(52,152,219,0.15); }
        .search-result-text { flex:1; font-size:.95rem; }
        .search-result-id { color:#95a5a6; font-size:.8rem; }
        .items-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        .item-card { background:rgba(0,0,0,0.4); border-radius:10px; overflow:hidden; transition:transform .3s; display:flex; flex-direction:column; height:100%; position:relative; cursor:grab; }
        .item-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .item-card:active { cursor:grabbing; transform:translateY(-2px); }
        .item-header { position:relative; padding:15px; background:rgba(52,152,219,0.2); display:flex; align-items:center; }
        .item-image { width:60px; height:60px; background:#1c1c1c; border-radius:5px; margin-right:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .item-image img { max-width:100%; max-height:100%; object-fit:contain; }
        .item-info { flex:1; overflow:hidden; }
        .item-name { font-size:1.2rem; font-weight:bold; margin-bottom:5px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; display:flex; align-items:center; }
        .item-id { color:#95a5a6; font-size:.9rem; user-select:text; cursor:text; }
        .item-prices { padding:20px; flex:1; }
        .price-row { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .price-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .price-label { font-weight:bold; }
        .price-value { display:flex; gap:8px; }
        .gold,.silver,.copper{ display:inline-flex; align-items:center; justify-content:center; padding:3px 8px; border-radius:4px; font-weight:bold; min-width:40px; text-align:center; }
        .gold { background:linear-gradient(to bottom,#ffd700,#daa520); color:#000; }
        .silver { background:linear-gradient(to bottom,#c0c0c0,#a9a9c0); color:#000; }
        .copper { background:linear-gradient(to bottom,#b87333,#8b4513); color:#fff; }
        .remove-btn-small { position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:50%; background:rgba(231,76,60,0.7); color:white; border:none; font-weight:bold; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; opacity:.8; transition:opacity .2s, background .2s; z-index:2; }
        .remove-btn-small:hover { opacity:1; background:rgba(231,76,60,1); }
        .loading { text-align:center; padding:20px; font-style:italic; color:#95a5a6; }
        .error { background:rgba(231,76,60,0.2); padding:15px; border-radius:5px; margin:20px 0; text-align:center; }
        .search-hint { text-align:center; color:#95a5a6; margin-top:5px; font-size:.9rem; }
        .spinner { border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top:2px solid white; width:16px; height:16px; animation:spin 1s linear infinite; margin-right:8px; display:inline-block; vertical-align:middle; }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
        .manual-refresh { text-align:center; margin-top:30px; }
        .manual-refresh button {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        .manual-refresh button:hover {
            background: rgba(46, 204, 113, 0.3);
        }

        /* --- Graph Link Styling --- */
        .graph-link {
            color: #3498db;
            text-decoration: none;
            margin-left: 6px;
            font-size: 1.1rem;
            vertical-align: middle;
            opacity: 0.9;
            transition: opacity 0.2s, color 0.2s;
        }
        .graph-link:hover {
            opacity: 1;
            color: #2980b9;
        }

        @media (max-width:768px) { .items-container{grid-template-columns:1fr;} h1{font-size:2rem;} .controls{position:relative;} .search-results{width:95%; left:50%; transform:translateX(-50%);} }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Wars 2 Trading Post Tracker</h1>
            <p class="subtitle">Monitor prices for your favorite items</p>
        </header>

        <div class="controls">
            <div class="input-group">
                <input type="text" id="item-input" placeholder="Enter Item ID, Name, or Partial Name">
                <button id="add-item-btn">Add Item</button>
            </div>
            <p class="search-hint">Examples: "Ectoplasm", "19721", "Gossamer", "Gold to Gems", "Gems to Gold"</p>
            <div id="search-results" class="search-results"></div>
        </div>

        <div id="error-container"></div>

        <div id="items-container" class="items-container">
            <div class="loading">Loading items...</div>
        </div>

        <div class="manual-refresh">
            <button id="refresh-items-btn">Refresh item IDs from server</button>
        </div>
    </div>

    <script>
        const itemInput = document.getElementById('item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items-container');
        const errorContainer = document.getElementById('error-container');
        const searchResultsContainer = document.getElementById('search-results');
        const refreshItemsBtn = document.getElementById('refresh-items-btn');

        const GOLD_TO_GEMS_ID = 9990001;
        const GEMS_TO_GOLD_ID = 9990002;

        // --- Graph Link Configuration ---
        const GRAPH_URL_TEMPLATE = 'https://en.gw2treasures.com/item/{id}';

        const SPECIAL_ITEMS = {
            [GOLD_TO_GEMS_ID]: {
                id: GOLD_TO_GEMS_ID,
                name: 'Gold to Gems',
                icon: 'https://wiki.guildwars2.com/images/8/88/Gem_%28highres%29.png',
                type: 'gold-to-gems'
            },
            [GEMS_TO_GOLD_ID]: {
                id: GEMS_TO_GOLD_ID,
                name: 'Gems to Gold',
                icon: 'https://wiki.guildwars2.com/images/d/d1/Gold_coin.png',
                type: 'gems-to-gold'
            }
        };

        // âœ…âœ…âœ… CONTAINER ITEMS DEFINITION âœ…âœ…âœ…
        // For each container item ID, define its possible outputs.
        // For each output item, provide:
        //   - id: GW2 item ID
        //   - avgQuantity: average number received IF it drops (e.g., 3â€“5 â†’ avg 4)
        //   - dropProb: probability (0.0 to 1.0) that this item type appears when container is used
        //
        // Expected value = sum( child_sell_price * avgQuantity * dropProb )
        const CONTAINER_ITEMS = {
            // Light Crafting Bag (ID 39121)
            // Source: https://wiki.guildwars2.com/wiki/Light_Crafting_Bag
            // "Gives 5 of the following 8 items (each 3â€“5 units)"
            // â†’ Each has 5/8 = 0.625 chance of being selected
            // â†’ Avg quantity per selected item = 4
            39121: {
                items: [
                    { id: 24344, avgQuantity: 3, dropProb: 0.625 }, // Bone
                    { id: 24348, avgQuantity: 3, dropProb: 0.625 }, // Claw
                    { id: 24274, avgQuantity: 3, dropProb: 0.625 }, // Radiant Dust
                    { id: 24354, avgQuantity: 3, dropProb: 0.625 }, // Fang
                    { id: 24286, avgQuantity: 3, dropProb: 0.625 }, // Scale
                    { id: 24280, avgQuantity: 3, dropProb: 0.625 }, // Venom Sac
                    { id: 24298, avgQuantity: 3, dropProb: 0.625 }, // Totem
                    { id: 24292, avgQuantity: 3, dropProb: 0.625 }  // Vial of Blood
                ]
            },

            // ðŸ”¸ ADD MORE CONTAINERS BELOW ðŸ”¸
            // Example: Black Lion Salvage Kit (ID 43319)
            // (Use real data from community sources)
            /*
            43319: {
                items: [
                    { id: 19721, avgQuantity: 1.5, dropProb: 0.70 }, // Ectoplasm: 70% chance, avg 1.5
                    { id: 24277, avgQuantity: 5.0, dropProb: 1.00 }, // Always drops 5 Crystalline Dust
                    { id: 24295, avgQuantity: 1.0, dropProb: 0.40 }  // 40% chance of 1 Glob
                ]
            },
39122: { // Medium Crafting Bag
                items: [
                    { id: 24275, avgQuantity: 3, dropProb: 0.625 }, // Luminous Dust
                    { id: 24345, avgQuantity: 3, dropProb: 0.625 }, // Heavy Bone
                    { id: 24281, avgQuantity: 3, dropProb: 0.625 }, // Full Venom Sac
                    { id: 24349, avgQuantity: 3, dropProb: 0.625 }, // Sharp Claw
                    { id: 24363, avgQuantity: 3, dropProb: 0.625 }, // Engraved Totem
                    { id: 24287, avgQuantity: 3, dropProb: 0.625 }, // Smooth Scale
                    { id: 24355, avgQuantity: 3, dropProb: 0.625 }, // Sharp Fang
                    { id: 24293, avgQuantity: 3, dropProb: 0.625 }  // Vial of Thick Blood
                ]
            },          
            
 39124: {  // Heavy Crafting Bag
                items: [
                    { id: 24295, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24357, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24277, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24289, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24358, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24300, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24351, avgQuantity: 3, dropProb: 0.625 }, 
                    { id: 24283, avgQuantity: 3, dropProb: 0.625 }  
                ]
            },                     
            
            */

            // Another example: Mystic Forge Stone Bag (fictional)
            /*
            98765: {
                items: [
                    { id: 24528, avgQuantity: 10, dropProb: 1.0 },
                    { id: 19924, avgQuantity: 1,  dropProb: 0.25 }
                ]
            }
            */
        };

        // Helper: check if an ID is a container
        function isContainer(id) {
            return CONTAINER_ITEMS.hasOwnProperty(id);
        }

        let trackedItems = [19721];
        let staticItemData = null;
        const DEBOUNCE_DELAY = 300;
        let debounceTimer = null;
        let draggedCard = null;

        // --- IndexedDB Helpers (unchanged) ---
        function getDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('GW2Cache', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files');
                    }
                };
            });
        }

        async function getCachedData(key) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const req = store.get(key);
                return new Promise((resolve) => {
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch (e) {
                console.warn('Failed to read from IndexedDB:', e);
                return null;
            }
        }

        async function setCachedData(key, data) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                store.put(data, key);
                await tx.complete;
            } catch (e) {
                console.warn('Failed to write to IndexedDB:', e);
            }
        }

        // --- Load Tracked Items ---
        function loadTrackedItems() {
            const saved = localStorage.getItem('gw2_tracked_items');
            if (saved) {
                try {
                    trackedItems = JSON.parse(saved).map(id => Number(id));
                } catch {
                    trackedItems = trackedItems.map(id => Number(id));
                }
            }
        }

        function saveTrackedItems() {
            localStorage.setItem('gw2_tracked_items', JSON.stringify(trackedItems));
        }

        // --- Currency Formatting ---
        function formatCurrency(copper) {
            if (copper === null || copper === undefined) return { gold: '-', silver: '-', copper: '-' };
            const gold = Math.floor(copper / 10000);
            const silver = Math.floor((copper % 10000) / 100);
            const copperRemainder = copper % 100;
            return { gold, silver, copper: copperRemainder };
        }

        function createCurrencyElement(copperValue) {
            const { gold, silver, copper } = formatCurrency(copperValue);
            const elem = document.createElement('div');
            elem.className = 'price-value';
            if (gold === '-' && silver === '-' && copper === '-') {
                elem.innerHTML = '<span style="color:#e74c3c;">Not available</span>';
                return elem;
            }
            elem.innerHTML = `
                ${gold > 0 ? `<span class="gold">${gold}</span>` : ''}
                ${silver > 0 || gold > 0 ? `<span class="silver">${silver}</span>` : ''}
                <span class="copper">${copper}</span>
            `;
            return elem;
        }

        // --- Fetch Item Data (API) ---
        async function fetchItemData(itemIds) {
            const resultsMap = new Map();
            const specialIds = itemIds.filter(id => id === GOLD_TO_GEMS_ID || id === GEMS_TO_GOLD_ID);
            const containerIds = itemIds.filter(isContainer);
            const regularIds = itemIds.filter(id => ![GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(id) && !isContainer(id));

            // Fetch regular item details and prices
            if (regularIds.length > 0) {
                try {
                    const itemDetailsResponse = await fetch(`https://api.guildwars2.com/v2/items?ids=${regularIds.join(',')}`);
                    if (!itemDetailsResponse.ok) throw new Error('Failed to fetch item details');
                    const itemDetails = await itemDetailsResponse.json();

                    const commerceResponse = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${regularIds.join(',')}`);
                    const commerceData = commerceResponse.ok ? await commerceResponse.json() : [];

                    for (const item of itemDetails) {
                        const commerceItem = commerceData.find(c => c.id === item.id);
                        resultsMap.set(item.id, {
                            id: item.id,
                            name: item.name,
                            icon: item.icon,
                            buyPrice: commerceItem ? commerceItem.buys.unit_price : null,
                            sellPrice: commerceItem ? commerceItem.sells.unit_price : null
                        });
                    }
                } catch (error) {
                    console.error('Error fetching regular item', error);
                    showError('Failed to fetch item data.');
                }
            }

            // Handle special items (gold/gems)
            for (const sid of specialIds) {
                const def = SPECIAL_ITEMS[sid];
                try {
                    if (sid === GEMS_TO_GOLD_ID) {
                        const res = await fetch('https://api.guildwars2.com/v2/commerce/exchange/gems?quantity=400');
                        if (!res.ok) throw new Error(`Exchange API error: ${res.status}`);
                        const data = await res.json();
                        resultsMap.set(sid, {
                            ...def,
                            returnFor400Gems: data.quantity
                        });
                    } else if (sid === GOLD_TO_GEMS_ID) {
                        const res = await fetch('https://api.guildwars2.com/v2/commerce/exchange/coins?quantity=10000000');
                        if (!res.ok) throw new Error(`Exchange API error: ${res.status}`);
                        const data = await res.json();
                        const gemsFrom1000g = data.quantity;
                        const gemsPerGold = gemsFrom1000g / 1000;
                        const goldFor400 = 400 / gemsPerGold;
                        const copperFor400 = Math.round(goldFor400 * 10000);
                        if (!isFinite(copperFor400) || copperFor400 <= 0) throw new Error('Invalid copper result');
                        resultsMap.set(sid, {
                            ...def,
                            costFor400Gems: copperFor400
                        });
                    }
                } catch (error) {
                    console.error(`Failed to load special item ${sid}:`, error);
                    showError(`Failed to load ${def.name}.`);
                    resultsMap.set(sid, { ...def, costFor400Gems: null, returnFor400Gems: null });
                }
            }

            // Fetch child item prices needed for containers
            const childItemIds = new Set();
            for (const cid of containerIds) {
                const def = CONTAINER_ITEMS[cid];
                for (const drop of def.items) {
                    childItemIds.add(drop.id);
                }
            }

            let childPriceMap = new Map();
            if (childItemIds.size > 0) {
                try {
                    const childIds = Array.from(childItemIds);
                    const childRes = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${childIds.join(',')}`);
                    if (childRes.ok) {
                        const childPrices = await childRes.json();
                        for (const c of childPrices) {
                            childPriceMap.set(c.id, c.sells?.unit_price || null);
                        }
                    }
                } catch (err) {
                    console.warn('Failed to fetch child prices for containers:', err);
                }
            }

            // Resolve container values
            for (const cid of containerIds) {
                const def = CONTAINER_ITEMS[cid];
                let totalValue = 0;
                let valid = true;

                // First fetch container name/icon from API
                let name = 'Unknown Container';
                let icon = null;
                try {
                    const itemRes = await fetch(`https://api.guildwars2.com/v2/items/${cid}`);
                    if (itemRes.ok) {
                        const itemData = await itemRes.json();
                        name = itemData.name;
                        icon = itemData.icon;
                    }
                } catch (e) {
                    console.warn(`Could not fetch container metadata for ${cid}`);
                }

                // Compute expected value
                for (const drop of def.items) {
                    const price = childPriceMap.get(drop.id);
                    if (price == null) {
                        valid = false;
                        break;
                    }
                    totalValue += price * (drop.avgQuantity || 0) * (drop.dropProb || 0);
                }

                resultsMap.set(cid, {
                    id: cid,
                    name: name,
                    icon: icon,
                    buyPrice: null,
                    sellPrice: valid ? Math.round(totalValue) : null,
                    isContainer: true
                });
            }

            // Return results in input order
            const orderedResults = [];
            for (const id of itemIds) {
                if (resultsMap.has(id)) orderedResults.push(resultsMap.get(id));
            }
            return orderedResults;
        }

        async function fetchAndDisplayItems() {
            if (!trackedItems || trackedItems.length === 0) {
                itemsContainer.innerHTML = '<div class="loading">No items tracked. Add an item to get started!</div>';
                return;
            }

            itemsContainer.innerHTML = '<div class="loading">Loading items...</div>';

            try {
                const items = await fetchItemData(trackedItems);
                itemsContainer.innerHTML = '';
                if (items.length === 0) {
                    itemsContainer.innerHTML = '<div class="loading">No items found.</div>';
                    return;
                }
                items.forEach(item => {
                    const card = createItemCard(item);
                    itemsContainer.appendChild(card);
                });
            } catch (error) {
                console.error('Error displaying items:', error);
                showError('An error occurred while loading items.');
            }
        }

        // --- Load Static Item Data with Caching (unchanged) ---
        const CACHE_KEY = 'datawars_items';
        const CACHE_TIMESTAMP_KEY = 'datawars_items_timestamp';
        const CACHE_MAX_AGE = 45 * 24 * 60 * 60 * 1000; // 45 days

        async function loadStaticItemData(forceRefresh = false) {
            if (staticItemData && !forceRefresh) return staticItemData;

            const now = Date.now();
            let useCache = false;
            let cachedData = null;

            if (!forceRefresh) {
                const cachedAt = localStorage.getItem(CACHE_TIMESTAMP_KEY);
                const isStale = !cachedAt || (now - Number(cachedAt) > CACHE_MAX_AGE);
                if (!isStale) {
                    cachedData = await getCachedData(CACHE_KEY);
                    if (cachedData) {
                        useCache = true;
                    }
                }
            }

            if (useCache) {
                staticItemData = cachedData;
                console.log('âœ… Loaded item data from IndexedDB cache');
                return staticItemData;
            }

            console.log(forceRefresh ? 'ðŸ”„ Forced refresh of item data' : 'ðŸ“¥ Fetching fresh item data (cache expired or missing)');
            try {
                const response = await fetch('datawars_items.json?' + now);
                if (!response.ok) throw new Error('Failed to load datawars_items.json');
                staticItemData = await response.json();

                await setCachedData(CACHE_KEY, staticItemData);
                localStorage.setItem(CACHE_TIMESTAMP_KEY, String(now));

                console.log('ðŸ’¾ Cached item data to IndexedDB');
                return staticItemData;
            } catch (error) {
                console.error('Error loading datawars_items.json:', error);
                showError('Failed to load item search data. Ensure "datawars_items.json" is in the same folder.');
                return cachedData || [];
            }
        }

        // --- Search, UI, and other logic (unchanged below) ---

        async function searchItemsByName(query) {
            const lowerQuery = query.toLowerCase().trim();
            const results = [];

            if (
                (lowerQuery.includes('gold') && lowerQuery.includes('gem')) ||
                lowerQuery.includes('gold to gems') ||
                lowerQuery === 'gold to gems'
            ) {
                results.push(SPECIAL_ITEMS[GOLD_TO_GEMS_ID]);
            }
            if (
                (lowerQuery.includes('gem') && lowerQuery.includes('gold')) ||
                lowerQuery.includes('gems to gold') ||
                lowerQuery === 'gems to gold'
            ) {
                results.push(SPECIAL_ITEMS[GEMS_TO_GOLD_ID]);
            }

            await loadStaticItemData();
            if (staticItemData && staticItemData.length > 0) {
                for (const item of staticItemData) {
                    if (item.name && item.name.toLowerCase().includes(lowerQuery)) {
                        results.push({ id: item.id, name: item.name });
                        if (results.length >= 15) break;
                    }
                }
            }

            const seen = new Set();
            return results.filter(item => {
                if (seen.has(item.id)) return false;
                seen.add(item.id);
                return true;
            }).slice(0, 15);
        }

        function showSearchResults(results) {
            if (!results || results.length === 0) {
                searchResultsContainer.style.display = 'none';
                return;
            }

            searchResultsContainer.innerHTML = '';
            results.forEach(item => {
                const div = document.createElement('div');
                div.className = 'search-result-item';
                const idText = ([GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(item.id)) ? 'Special' : `ID: ${item.id}`;
                div.innerHTML = `
                    <div class="search-result-text">
                        <div>${item.name}</div>
                        <div class="search-result-id">${idText}</div>
                    </div>
                `;
                div.addEventListener('click', () => {
                    const numericId = Number(item.id);
                    if (!trackedItems.includes(numericId)) {
                        trackedItems.push(numericId);
                        saveTrackedItems();
                        fetchAndDisplayItems();
                    } else {
                        showError('This item is already being tracked');
                    }
                    itemInput.value = '';
                    searchResultsContainer.style.display = 'none';
                });
                searchResultsContainer.appendChild(div);
            });

            searchResultsContainer.style.display = 'block';
        }

        function hideSearchResults() {
            searchResultsContainer.style.display = 'none';
        }

        async function addItemById(itemId) {
            const numericId = Number(itemId);
            if (trackedItems.includes(numericId)) {
                showError('This item is already being tracked');
                return;
            }

            addItemBtn.disabled = true;
            addItemBtn.innerHTML = '<span class="spinner"></span> Adding...';

            try {
                if ([GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(numericId)) {
                    trackedItems.push(numericId);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                    itemInput.value = '';
                    return;
                }

                const response = await fetch(`https://api.guildwars2.com/v2/items/${numericId}`);
                if (!response.ok) throw new Error('Invalid item ID');
                const item = await response.json();

                trackedItems.push(Number(item.id));
                saveTrackedItems();
                fetchAndDisplayItems();
                itemInput.value = '';
            } catch (error) {
                console.error('Add by ID error:', error);
                showError('Invalid item ID or API error.');
            } finally {
                addItemBtn.disabled = false;
                addItemBtn.textContent = 'Add Item';
            }
        }

        async function handleAdd() {
            const query = itemInput.value.trim();
            if (!query) {
                showError('Please enter an item ID or name');
                return;
            }

            const id = parseInt(query, 10);
            if (!isNaN(id) && id > 0) {
                await addItemById(id);
                return;
            }

            if (query.toLowerCase() === 'gold to gems') {
                if (!trackedItems.includes(GOLD_TO_GEMS_ID)) {
                    trackedItems.push(GOLD_TO_GEMS_ID);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                    itemInput.value = '';
                } else {
                    showError('This item is already being tracked');
                }
                return;
            }
            if (query.toLowerCase() === 'gems to gold') {
                if (!trackedItems.includes(GEMS_TO_GOLD_ID)) {
                    trackedItems.push(GEMS_TO_GOLD_ID);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                    itemInput.value = '';
                } else {
                    showError('This item is already being tracked');
                }
                return;
            }

            addItemBtn.disabled = true;
            addItemBtn.innerHTML = '<span class="spinner"></span> Searching...';

            try {
                const results = await searchItemsByName(query);
                if (results.length === 0) {
                    showError('No items found. Try an item ID.');
                } else {
                    showSearchResults(results);
                }
            } catch (error) {
                console.error('Search error:', error);
                showError('Search failed. Try using an item ID.');
            } finally {
                addItemBtn.disabled = false;
                addItemBtn.textContent = 'Add Item';
            }
        }

        function createItemCard(itemData) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = itemData.id;
            card.draggable = true;

            const isSpecial = [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(itemData.id);
            const isContainer = itemData.isContainer;

            if (isSpecial) {
                const imageElem = `
                    <div class="item-image">
                        <img src="${itemData.icon}" alt="${itemData.name}" 
                             onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#e74c3c;font-size:0.8rem;text-align:center;\\'>Image<br>Unavailable</div>'">
                    </div>
                `;

                let priceLabel, priceValue;
                if (itemData.id === GOLD_TO_GEMS_ID) {
                    priceLabel = 'Cost for 400 Gems:';
                    priceValue = createCurrencyElement(itemData.costFor400Gems);
                } else {
                    priceLabel = 'Return for 400 Gems:';
                    priceValue = createCurrencyElement(itemData.returnFor400Gems);
                }

                card.innerHTML = `
                    <div class="item-header">
                        ${imageElem}
                        <div class="item-info">
                            <div class="item-name">${itemData.name}</div>
                            <div class="item-id">Special</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">Ã—</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row">
                            <div class="price-label">${priceLabel}</div>
                            ${priceValue.outerHTML}
                        </div>
                    </div>
                `;
            } else if (isContainer) {
                const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);
                const imageElem = `
                    <div class="item-image">
                        <img src="${itemData.icon || 'https://wiki.guildwars2.com/images/d/d1/Inventory_icon.png'}" 
                             alt="${itemData.name}"
                             onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#e74c3c;font-size:0.8rem;text-align:center;\\'>Image<br>Unavailable</div>'">
                    </div>
                `;

                card.innerHTML = `
                    <div class="item-header">
                        ${imageElem}
                        <div class="item-info">
                            <div class="item-name">
                                <a href="${graphUrl}" target="_blank" rel="noopener" class="graph-link" title="View price graph">ðŸ“ˆ</a>
                                ${itemData.name} <span style="color:#f39c12; font-size:0.9em;">(Container)</span>
                            </div>
                            <div class="item-id">ID: ${itemData.id} â€¢ Expected Value</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">Ã—</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row">
                            <div class="price-label">Expected Value:</div>
                            ${createCurrencyElement(itemData.sellPrice).outerHTML}
                        </div>
                        <div class="price-row">
                            <div class="price-label">Buy Price:</div>
                            <span style="color:#e74c3c;">Not Tradable</span>
                        </div>
                    </div>
                `;
            } else {
                const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);
                const imageElem = `
                    <div class="item-image">
                        <img src="${itemData.icon}" alt="${itemData.name}" 
                             onerror="this.parentElement.innerHTML='<div style=\\'width:100%;height:100%;display:flex;align-items:center;justify-content:center;color:#e74c3c;font-size:0.8rem;text-align:center;\\'>Image<br>Unavailable</div>'">
                    </div>
                `;

                card.innerHTML = `
                    <div class="item-header">
                        ${imageElem}
                        <div class="item-info">
                            <div class="item-name">
                                <a href="${graphUrl}" target="_blank" rel="noopener" class="graph-link" title="View price graph">ðŸ“ˆ</a>
                                ${itemData.name}
                            </div>
                            <div class="item-id">ID: ${itemData.id}</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">Ã—</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row">
                            <div class="price-label">Buy Price:</div>
                            ${createCurrencyElement(itemData.buyPrice).outerHTML}
                        </div>
                        <div class="price-row">
                            <div class="price-label">Sell Price:</div>
                            ${createCurrencyElement(itemData.sellPrice).outerHTML}
                        </div>
                    </div>
                `;
            }

            const removeBtn = card.querySelector('.remove-btn-small');
            removeBtn.addEventListener('click', e => {
                e.stopPropagation();
                const itemId = Number(e.target.dataset.itemId);
                removeItem(itemId);
            });

            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);

            return card;
        }

        function removeItem(itemId) {
            trackedItems = trackedItems.filter(id => id !== Number(itemId));
            saveTrackedItems();
            fetchAndDisplayItems();
        }

        function showError(message) {
            errorContainer.innerHTML = `<div class="error">${message}</div>`;
            setTimeout(() => { errorContainer.innerHTML = ''; }, 5000);
        }

        function handleDragStart(e) {
            draggedCard = this;
            e.dataTransfer.effectAllowed = 'move';
            this.style.opacity = '0.5';
            this.style.cursor = 'grabbing';
        }

        function handleDragOver(e) {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            return false;
        }

        function handleDragEnd(e) {
            this.style.opacity = '1';
            this.style.cursor = 'grab';
            draggedCard = null;
        }

        function handleDrop(e) {
            e.stopPropagation();
            e.preventDefault();
            if (draggedCard && draggedCard !== this) {
                const draggedId = Number(draggedCard.dataset.itemId);
                const targetId = Number(this.dataset.itemId);

                const currentIndex = trackedItems.indexOf(draggedId);
                const targetIndex = trackedItems.indexOf(targetId);

                if (currentIndex !== -1 && targetIndex !== -1 && currentIndex !== targetIndex) {
                    const [removed] = trackedItems.splice(currentIndex, 1);
                    trackedItems.splice(targetIndex, 0, removed);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                }
            }
            return false;
        }

        async function handleManualRefresh() {
            refreshItemsBtn.disabled = true;
            refreshItemsBtn.textContent = 'Refreshing...';

            staticItemData = null;
            localStorage.removeItem(CACHE_TIMESTAMP_KEY);
            await loadStaticItemData(true);

            refreshItemsBtn.disabled = false;
            refreshItemsBtn.textContent = 'Refresh item IDs from server';
            showError('Item ID database refreshed from server.');
        }

        function init() {
            loadTrackedItems();
            fetchAndDisplayItems();

            addItemBtn.addEventListener('click', handleAdd);
            refreshItemsBtn.addEventListener('click', handleManualRefresh);

            itemInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') handleAdd();
            });

            document.addEventListener('click', (e) => {
                if (!e.target.closest('.controls')) hideSearchResults();
            });

            itemInput.addEventListener('input', () => {
                const query = itemInput.value.trim();
                if (!query || /^\d+$/.test(query)) {
                    hideSearchResults();
                    return;
                }

                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    if (itemInput.value.trim() === query) {
                        const results = await searchItemsByName(query);
                        showSearchResults(results);
                    }
                }, DEBOUNCE_DELAY);
            });
        }

        init();
    </script>

    <p></p>
    <a href="https://gartkb.github.io/Garts-Great-Tools/" style="color: yellow; text-decoration: underline;">Gart's Great Tools</a>
</body>
</html>
