<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="./images/icons/gw2_price_status.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guild Wars 2 Trading Post Tracker</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; }
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }
        
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:20px; display:flex; flex-direction:column; align-items:center; gap:10px; position:relative; }
        
        .input-wrapper { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:700px; align-items: flex-start; }
        .input-col { display: flex; flex-direction: column; flex: 1; min-width: 200px; position: relative; }

        input[type="text"] { padding:12px 15px; border:none; border-radius:5px; background:rgba(255,255,255,0.1); color:white; width:100%; font-size:1rem; border:1px solid #3498db; }
        input::placeholder { color:#95a5a6; }
        
        button { padding:12px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; height: 46px; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; }
        
        .api-link {
            font-size: 0.7rem;
            color: #7f8c8d;
            text-decoration: none;
            cursor: pointer;
            margin-top: 4px;
            margin-left: 2px;
            text-align: left;
            align-self: flex-start;
            transition: color 0.3s;
        }
        .api-link:hover { color: #bdc3c7; text-decoration: underline; }

        /* --- TABS STYLING --- */
        .tabs-container { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid rgba(52, 152, 219, 0.3); align-items: flex-end; }
        .tab-btn { background: rgba(0,0,0,0.2); border: 1px solid transparent; border-bottom: none; padding: 8px 15px; border-radius: 8px 8px 0 0; color: #95a5a6; cursor: pointer; font-size: 1rem; transition: all 0.2s; white-space: nowrap; position: relative; height: 42px; display: flex; align-items: center; gap: 8px; min-width: 80px; justify-content: center; }
        .tab-btn:hover { background: rgba(52, 152, 219, 0.1); color: white; }
        .tab-btn.active { background: rgba(52, 152, 219, 0.2); color: #3498db; border-color: rgba(52, 152, 219, 0.5); font-weight: bold; }
        .tab-btn.drag-over { background: rgba(46, 204, 113, 0.3); color: #2ecc71; border-color: #2ecc71; transform: translateY(-2px); }
        .tab-text-wrapper { pointer-events: none; }
        .tab-name-span { pointer-events: auto; }
        .tab-edit-input { background: #2c3e50; border: 1px solid #3498db; color: white; font-size: 0.9rem; padding: 2px 5px; width: 100px; height: 26px; border-radius: 3px; }
        .tab-close-btn { width: 18px; height: 18px; border-radius: 50%; background: rgba(231, 76, 60, 0.8); color: white; font-size: 12px; line-height: 18px; text-align: center; display: none; align-items: center; justify-content: center; transition: background 0.2s; }
        .tab-btn:hover .tab-close-btn { display: flex; }
        .tab-close-btn:hover { background: #e74c3c; transform: scale(1.1); }
        .add-tab-btn { padding: 0 15px; font-size: 1.5rem; background: rgba(0,0,0,0.2); color: #2ecc71; justify-content: center; }
        .add-tab-btn:hover { background: rgba(46, 204, 113, 0.2); }

        #delivery-btn { background: #7f8c8d; opacity: 0.4; transition: all 0.5s ease; display: flex; align-items: center; gap: 8px; }
        #delivery-btn.has-delivery { background: linear-gradient(135deg, #f1c40f, #e67e22); color: #2c3e50; opacity: 1; box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); animation: pulse-glow 2s infinite; }
        @keyframes pulse-glow { 0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); } 100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); } }

        .search-results { position:absolute; top:100%; left:0; width: 100%; background:rgba(0,0,0,0.95); border:1px solid #3498db; border-radius:5px; max-height:300px; overflow-y:auto; z-index:100; margin-top:5px; display:none; }
        .search-result-item { padding:10px 15px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
        .search-result-item:last-child { border-bottom:none; }
        .search-result-item:hover { background: rgba(52,152,219,0.25); }
        
        .items-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        
        .item-card { background:rgba(0,0,0,0.4); border-radius:10px; overflow: visible; transition:transform .3s; display:flex; flex-direction:column; height:100%; position:relative; cursor:grab; }
        .item-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .item-card:active { cursor:grabbing; transform:translateY(-2px); }
        
        .item-header { position:relative; padding:15px; background:rgba(52,152,219,0.2); display:flex; align-items:center; border-radius: 10px 10px 0 0; }
        .item-image { width:60px; height:60px; background:#1c1c1c; border-radius:5px; margin-right:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .item-image img { max-width:100%; max-height:100%; object-fit:contain; }
        
        .item-info { flex: 1; overflow: hidden; min-width: 0; margin-right: 45px; } 
        .item-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; white-space: nowrap; display: block; overflow: hidden; text-overflow: ellipsis; }
        .item-name a, .item-name span { vertical-align: middle; display: inline-block; }

        .item-id { color:#95a5a6; font-size:.9rem; display:flex; align-items:center; gap: 10px; min-height: 24px; }
        
        .order-icon { cursor: pointer; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; padding: 0 2px; }
        .order-icon:hover { transform: scale(1.2); background: rgba(255,255,255,0.1); }
        .icon-buy { filter: drop-shadow(0 0 2px rgba(46, 204, 113, 0.5)); border-bottom: 2px solid #2ecc71; }
        .icon-sell { filter: drop-shadow(0 0 2px rgba(231, 76, 60, 0.5)); border-bottom: 2px solid #e74c3c; }
        .icon-inv { filter: drop-shadow(0 0 2px rgba(241, 196, 15, 0.5)); border-bottom: 2px solid #f1c40f; }
        .icon-warn { border-bottom-style: dashed !important; opacity: 0.8; }

        .item-prices { padding:20px; flex:1; }
        .price-row { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .price-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .price-label { font-weight:bold; }
        .price-value { display:flex; gap:8px; }
        .gold,.silver,.copper{ display:inline-flex; align-items:center; justify-content:center; padding:3px 8px; border-radius:4px; font-weight:bold; min-width:40px; text-align:center; }
        .gold { background:linear-gradient(to bottom,#ffd700,#daa520); color:#000; }
        .silver { background:linear-gradient(to bottom,#c0c0c0,#a9a9c0); color:#000; }
        .copper { background:linear-gradient(to bottom,#b87333,#8b4513); color:#fff; }
        
        .card-actions { position:absolute; top:8px; right:8px; display:flex; gap: 5px; z-index: 2;}
        .card-btn { width:24px; height:24px; border-radius:50%; color:white; border:none; font-weight:bold; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; opacity:.7; transition:all .2s; }
        .card-btn:hover { opacity:1; transform: scale(1.1); }
        .remove-btn { background:rgba(231,76,60,0.7); }
        .remove-btn:hover { background:rgba(231,76,60,1); }

        .loading { text-align:center; padding:20px; font-style:italic; color:#95a5a6; }
        .error { background:rgba(231,76,60,0.2); padding:15px; border-radius:5px; margin:20px 0; text-align:center; }
        .search-hint { text-align:center; color:#95a5a6; margin-top:5px; font-size:.9rem; }
        .manual-refresh { text-align:center; margin-top:30px; }
        .manual-refresh button { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71; padding: 8px 16px; font-size: 0.9rem; }
        .manual-refresh button:hover { background: rgba(46, 204, 113, 0.3); }
        .graph-link { color: #3498db; text-decoration: none; margin-left: 6px; font-size: 1.1rem; vertical-align: middle; opacity: 0.9; transition: opacity 0.2s, color 0.2s; }
        .graph-link:hover { opacity: 1; color: #2980b9; }

        /* --- MODAL STYLES --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: #2c3e50; border: 1px solid #3498db; border-radius: 8px; width: 95%; max-width: 900px; padding: 20px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { font-size: 1.5rem; color: #3498db; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: #ecf0f1; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-close:hover { color: #e74c3c; transform: none; background: none; }
        .modal-body { overflow-y: auto; flex: 1; }
        
        .api-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .api-list { display: flex; flex-direction: column; gap: 10px; }
        .api-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .api-name { font-weight: bold; color: #3498db; }
        .api-key-mask { color: #95a5a6; font-family: monospace; font-size: 0.8rem; margin-left: 10px; }
        .delete-key-btn { background: #e74c3c; padding: 5px 10px; font-size: 0.8rem; }

        .global-toggle { margin-bottom: 20px; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 5px; display:flex; align-items: center; border: 1px solid rgba(46, 204, 113, 0.3); }
        .global-toggle label { cursor: pointer; font-weight: bold; color: #2ecc71; margin-left: 10px; font-size: 1.05rem; }

        .guild-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .guild-item { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 4px; }
        .guild-item label { flex: 1; margin-left: 10px; cursor: pointer; color: #ecf0f1; display: flex; justify-content: space-between; }
        .guild-tag { color: #f39c12; font-weight: bold; margin-left: 5px; }
        .section-title { color: #3498db; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; margin-top: 20px; }

        /* Table Styles */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th { text-align: left; color: #95a5a6; padding: 8px; border-bottom: 1px solid #3498db; }
        .data-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
        .col-account { font-weight: bold; color: #2ecc71; }
        .col-guild { font-weight: bold; color: #e67e22; } 
        .col-qty { color: #f1c40f; font-weight: bold; }
        .col-date { font-size: 0.8rem; color: #bdc3c7; }
        
        .inv-owner-header { background: rgba(52, 152, 219, 0.1); color: #3498db; font-weight: bold; padding: 8px; }
        .inv-total-row { background: rgba(241, 196, 15, 0.1); font-weight: bold; }
        .delivery-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; border-radius: 3px; }
        .delivery-item-name { vertical-align: middle; }

        @media (max-width:768px) { 
            .items-container{grid-template-columns:1fr;} 
            h1{font-size:2rem;} 
            .controls{position:relative;} 
            .search-results{width:100%; left:0; }
            .data-table { font-size: 0.8rem; }
            .input-wrapper { flex-direction: column; align-items: stretch; }
            .input-col { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Wars 2 Trading Post Tracker</h1>
            <p class="subtitle">Monitor prices for your favorite items</p>
        </header>
        <div class="controls">
            <div class="input-wrapper">
                <div class="input-col">
                    <input type="text" id="item-input" placeholder="Enter Item ID, Name, or Partial Name">
                    <a id="api-settings-link" class="api-link">Manage API Keys</a>
                    <div id="search-results" class="search-results"></div>
                </div>
                <button id="add-item-btn">Add Item</button>
                <button id="delivery-btn" title="Check Delivery Box">
                    <span>ðŸ“¦</span> Delivery Box
                </button>
            </div>
            <p class="search-hint">Examples: "Ectoplasm", "19721", "Gossamer", "Heavy Crafting Bag", "Gold to Gems"</p>
        </div>
        
        <div id="tabs-container" class="tabs-container">
            <!-- Tabs Generated JS -->
        </div>

        <div id="error-container"></div>
        <div id="items-container" class="items-container">
            <div class="loading">Loading items...</div>
        </div>
        <div class="manual-refresh">
            <button id="refresh-items-btn">Refresh item IDs from server</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Manage API Keys</span>
                <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="global-toggle">
                    <input type="checkbox" id="enable-inventory-chk" checked>
                    <label for="enable-inventory-chk">Scan Inventories & Characters</label>
                </div>

                <div class="section-title" style="margin-top:0;">API Keys</div>
                <div class="api-input-row">
                    <input type="text" id="new-api-key" placeholder="Paste API Key" style="flex:2">
                    <input type="text" id="new-api-name" placeholder="Nickname" style="flex:1">
                    <button onclick="addApiKey()">Add</button>
                </div>
                <div id="api-key-list" class="api-list"></div>
                <p style="margin-top:10px; font-size:0.8rem; color:#95a5a6;">
                    Required scopes: <em>tradingpost, inventories, characters, guilds</em>.
                </p>

                <div class="section-title">Monitored Guilds</div>
                <div style="font-size:0.85rem; color:#bdc3c7; margin-bottom: 5px;">Only accessible guilds (Leader permission) appear here. Uncheck to disable polling.</div>
                <div id="guild-list-container" class="guild-list">
                    <div style="color:#95a5a6; font-style:italic;">Accessible guilds will appear here after data is loaded.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Order Viewer Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="order-modal-title">Orders</span>
                <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-content"></div>
            </div>
        </div>
    </div>

    <!-- Inventory Viewer Modal -->
    <div id="inventory-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="inventory-modal-title">Inventory Locations</span>
                <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="inventory-content"></div>
            </div>
        </div>
    </div>

    <!-- Container Content Modal -->
    <div id="container-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="container-modal-title">Container Contents</span>
                <button class="modal-close" onclick="closeModal('container-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="container-content"></div>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="delivery-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Delivery Box Content</span>
                <button class="modal-close" onclick="closeModal('delivery-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="delivery-content"></div>
            </div>
        </div>
    </div>

    <script>
        const itemInput = document.getElementById('item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items-container');
        const errorContainer = document.getElementById('error-container');
        const searchResultsContainer = document.getElementById('search-results');
        const refreshItemsBtn = document.getElementById('refresh-items-btn');
        const apiSettingsLink = document.getElementById('api-settings-link');
        const deliveryBtn = document.getElementById('delivery-btn');
        const tabsContainer = document.getElementById('tabs-container');
        
        const GOLD_TO_GEMS_ID = 9990001;
        const GEMS_TO_GOLD_ID = 9990002;
        const GRAPH_URL_TEMPLATE = 'https://en.gw2treasures.com/item/{id}';
        
        const SPECIAL_ITEMS = {
            [GOLD_TO_GEMS_ID]: { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems', icon: 'https://wiki.guildwars2.com/images/8/88/Gem_%28highres%29.png', type: 'gold-to-gems' },
            [GEMS_TO_GOLD_ID]: { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold', icon: 'https://wiki.guildwars2.com/images/d/d1/Gold_coin.png', type: 'gems-to-gold' }
        };

        const CONTAINER_ITEMS = {
            39121: { items: [{ id: 24344, avgQuantity: 3, dropProb: 0.625 }, { id: 24348, avgQuantity: 3, dropProb: 0.625 }, { id: 24274, avgQuantity: 3, dropProb: 0.625 }, { id: 24354, avgQuantity: 3, dropProb: 0.625 }, { id: 24286, avgQuantity: 3, dropProb: 0.625 }, { id: 24280, avgQuantity: 3, dropProb: 0.625 }, { id: 24298, avgQuantity: 3, dropProb: 0.625 }, { id: 24292, avgQuantity: 3, dropProb: 0.625 }] },
            39122: { items: [{ id: 24275, avgQuantity: 3, dropProb: 0.625 }, { id: 24345, avgQuantity: 3, dropProb: 0.625 }, { id: 24281, avgQuantity: 3, dropProb: 0.625 }, { id: 24349, avgQuantity: 3, dropProb: 0.625 }, { id: 24363, avgQuantity: 3, dropProb: 0.625 }, { id: 24287, avgQuantity: 3, dropProb: 0.625 }, { id: 24355, avgQuantity: 3, dropProb: 0.625 }, { id: 24293, avgQuantity: 3, dropProb: 0.625 }] },          
            39124: { items: [{ id: 24295, avgQuantity: 1, dropProb: 0.375 }, { id: 24357, avgQuantity: 1, dropProb: 0.375 }, { id: 24277, avgQuantity: 1, dropProb: 0.375 }, { id: 24289, avgQuantity: 1, dropProb: 0.375 }, { id: 24358, avgQuantity: 1, dropProb: 0.375 }, { id: 24300, avgQuantity: 1, dropProb: 0.375 }, { id: 24351, avgQuantity: 1, dropProb: 0.375 }, { id: 24283, avgQuantity: 1, dropProb: 0.375 }] }
        };
        
        const CUSTOM_SEARCHABLE_ITEMS = [
            { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems' },
            { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold' },
            { id: 39121, name: 'Light Crafting Bag' },
            { id: 39122, name: 'Medium Crafting Bag' },
            { id: 39124, name: 'Heavy Crafting Bag' }
        ];

        function isContainer(id) { return CONTAINER_ITEMS.hasOwnProperty(id); }

        // --- GLOBAL STATE ---
        let itemTabs = [{ id: 'default', name: 'Main', items: [19721] }];
        let activeTabIndex = 0;

        let staticItemData = null;
        let apiKeys = []; 
        let accountOrdersMap = new Map(); 
        let globalInventoryMap = new Map(); 
        let deliveryData = []; 
        let globalItemData = new Map(); 
        
        // Settings
        let enableInventory = true;
        let disabledGuilds = new Set();
        let knownGuilds = {}; // Map: guildId -> { name, tag }

        const DEBOUNCE_DELAY = 300;
        let debounceTimer = null;
        let draggedCard = null;

        // --- TABS LOGIC ---
        function loadTabs() {
            const savedTabs = localStorage.getItem('gw2_item_tabs');
            if (savedTabs) {
                try {
                    itemTabs = JSON.parse(savedTabs);
                    if(!itemTabs.length) itemTabs = [{ id: 'default', name: 'Main', items: [] }];
                } catch { itemTabs = [{ id: 'default', name: 'Main', items: [] }]; }
            } else {
                const oldItems = localStorage.getItem('gw2_tracked_items');
                if(oldItems) {
                    try {
                        const items = JSON.parse(oldItems).map(Number).filter(n => !isNaN(n));
                        itemTabs[0].items = items;
                        saveTabs();
                    } catch {}
                }
            }
            renderTabs();
        }

        function saveTabs() {
            localStorage.setItem('gw2_item_tabs', JSON.stringify(itemTabs));
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            itemTabs.forEach((tab, index) => {
                const btn = document.createElement('div');
                btn.className = `tab-btn ${index === activeTabIndex ? 'active' : ''}`;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'tab-name-span';
                nameSpan.textContent = tab.name;
                nameSpan.title = "Double click to rename";
                const nameInput = document.createElement('input');
                nameInput.className = 'tab-edit-input';
                nameInput.value = tab.name;
                nameInput.style.display = 'none';
                
                nameSpan.ondblclick = (e) => {
                    e.stopPropagation();
                    nameSpan.style.display = 'none';
                    nameInput.style.display = 'block';
                    nameInput.focus();
                };
                
                const saveName = () => {
                    const newName = nameInput.value.trim();
                    if(newName) {
                        tab.name = newName;
                        saveTabs();
                        renderTabs();
                    } else {
                        nameInput.value = tab.name;
                        nameInput.style.display = 'none';
                        nameSpan.style.display = 'inline';
                    }
                };
                nameInput.onblur = saveName;
                nameInput.onkeydown = (e) => { if(e.key === 'Enter') saveName(); };

                let closeBtn = null;
                if(index !== 0) {
                    closeBtn = document.createElement('span');
                    closeBtn.className = 'tab-close-btn';
                    closeBtn.textContent = 'Ã—';
                    closeBtn.title = 'Delete Tab';
                    closeBtn.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm(`Delete tab "${tab.name}"? Items will be moved to Main.`)) {
                            itemTabs[0].items.push(...tab.items);
                            itemTabs.splice(index, 1);
                            activeTabIndex = 0;
                            saveTabs();
                            renderTabs();
                            renderActiveTab();
                        }
                    };
                }

                btn.appendChild(nameSpan);
                btn.appendChild(nameInput);
                if(closeBtn) btn.appendChild(closeBtn);

                btn.onclick = (e) => {
                    if(e.target !== nameInput) {
                        activeTabIndex = index;
                        renderTabs();
                        renderActiveTab();
                    }
                };

                btn.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    if(index !== activeTabIndex) btn.classList.add('drag-over');
                });
                btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
                btn.addEventListener('drop', (e) => {
                    e.preventDefault();
                    btn.classList.remove('drag-over');
                    if (draggedCard && index !== activeTabIndex) {
                        const itemId = Number(draggedCard.dataset.itemId);
                        moveItemToTab(itemId, index);
                    }
                });

                tabsContainer.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'tab-btn add-tab-btn';
            addBtn.textContent = '+';
            addBtn.onclick = addNewTab;
            tabsContainer.appendChild(addBtn);
        }

        function addNewTab() {
            const name = prompt("Enter name for new tab:");
            if(name) {
                itemTabs.push({
                    id: 'tab-' + Date.now(),
                    name: name.trim(),
                    items: []
                });
                activeTabIndex = itemTabs.length - 1;
                saveTabs();
                renderTabs();
                renderActiveTab();
            }
        }

        async function addToActiveTab(id) {
            if(!itemTabs[activeTabIndex].items.includes(id)) {
                itemTabs[activeTabIndex].items.push(id);
                saveTabs();
                
                if (globalItemData.has(id)) {
                    renderActiveTab();
                } else {
                    try {
                        const newItems = await fetchItemData([id]);
                        newItems.forEach(i => globalItemData.set(i.id, i));
                        renderActiveTab();
                    } catch (e) {
                        console.error("Failed to fetch new item", e);
                    }
                }
            }
        }

        function removeFromActiveTab(id) {
            itemTabs[activeTabIndex].items = itemTabs[activeTabIndex].items.filter(x => x !== id);
            saveTabs();
            renderActiveTab();
        }

        function moveItemToTab(itemId, targetTabIndex) {
            itemTabs[activeTabIndex].items = itemTabs[activeTabIndex].items.filter(x => x !== itemId);
            if(!itemTabs[targetTabIndex].items.includes(itemId)) {
                itemTabs[targetTabIndex].items.push(itemId);
            }
            saveTabs();
            renderActiveTab();
        }

        // --- API & Settings Management ---
        function loadApiKeys() {
            const stored = localStorage.getItem('gw2_api_keys');
            if (stored) {
                try { apiKeys = JSON.parse(stored); } catch (e) { apiKeys = []; }
            }
            renderApiKeys();
        }
        function saveApiKeys() {
            localStorage.setItem('gw2_api_keys', JSON.stringify(apiKeys));
            renderApiKeys();
        }

        function loadSettings() {
            const invSetting = localStorage.getItem('gw2_enable_inventory');
            if(invSetting !== null) enableInventory = invSetting === 'true';
            document.getElementById('enable-inventory-chk').checked = enableInventory;

            const disabled = localStorage.getItem('gw2_disabled_guilds');
            if(disabled) {
                try { disabledGuilds = new Set(JSON.parse(disabled)); } catch {}
            }
            const known = localStorage.getItem('gw2_known_guilds');
            if(known) {
                try { knownGuilds = JSON.parse(known); } catch {}
            }
            renderGuildSettings();
        }

        function saveSettings() {
            localStorage.setItem('gw2_enable_inventory', enableInventory);
            localStorage.setItem('gw2_disabled_guilds', JSON.stringify([...disabledGuilds]));
            localStorage.setItem('gw2_known_guilds', JSON.stringify(knownGuilds));
        }

        function addApiKey() {
            const keyInput = document.getElementById('new-api-key');
            const nameInput = document.getElementById('new-api-name');
            const key = keyInput.value.trim();
            const name = nameInput.value.trim() || 'Account ' + (apiKeys.length + 1);
            if (!key) { alert('Please enter an API Key'); return; }
            apiKeys.push({ key, name });
            saveApiKeys();
            keyInput.value = ''; nameInput.value = '';
            fetchGlobalData(); // Also triggers guild discovery
        }
        function removeApiKey(index) {
            if(confirm('Remove this API key?')) {
                apiKeys.splice(index, 1);
                saveApiKeys();
                fetchGlobalData(); 
            }
        }
        function renderApiKeys() {
            const list = document.getElementById('api-key-list');
            list.innerHTML = '';
            if(apiKeys.length === 0) {
                list.innerHTML = '<div style="color:#95a5a6; text-align:center;">No API keys configured.</div>';
            } else {
                apiKeys.forEach((k, i) => {
                    const div = document.createElement('div');
                    div.className = 'api-item';
                    div.innerHTML = `<div><span class="api-name">${k.name}</span><span class="api-key-mask">${k.key.substring(0,8)}...</span></div><button class="delete-key-btn" onclick="removeApiKey(${i})">Delete</button>`;
                    list.appendChild(div);
                });
            }
        }

        function renderGuildSettings() {
            const container = document.getElementById('guild-list-container');
            container.innerHTML = '';
            const guildIds = Object.keys(knownGuilds);
            
            if(guildIds.length === 0) {
                container.innerHTML = '<div style="color:#95a5a6; font-style:italic; text-align:center;">Accessible guilds will appear here after data is loaded.</div>';
                return;
            }

            guildIds.forEach(gid => {
                const g = knownGuilds[gid];
                const div = document.createElement('div');
                div.className = 'guild-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !disabledGuilds.has(gid);
                checkbox.onchange = () => {
                    if(checkbox.checked) disabledGuilds.delete(gid);
                    else disabledGuilds.add(gid);
                    saveSettings();
                };
                
                const label = document.createElement('label');
                label.innerHTML = `<span>${g.name} <span class="guild-tag">[${g.tag}]</span></span>`;
                label.onclick = () => checkbox.click();

                div.appendChild(checkbox);
                div.appendChild(label);
                container.appendChild(div);
            });
        }

        // --- GUILD DISCOVERY (Lightweight) ---
        async function discoverGuilds() {
            if(apiKeys.length === 0) return;
            let newGuildsFound = false;
            const currentValidGuilds = new Set();

            const promises = apiKeys.map(async (account) => {
                try {
                    const accRes = await fetch(`https://api.guildwars2.com/v2/account?access_token=${account.key}`);
                    if(!accRes.ok) return;
                    const accInfo = await accRes.json();
                    
                    if(accInfo.guild_leader && Array.isArray(accInfo.guild_leader)) {
                        for (const guildId of accInfo.guild_leader) {
                            currentValidGuilds.add(guildId);
                            
                            if(!knownGuilds[guildId]) {
                                try {
                                    const gRes = await fetch(`https://api.guildwars2.com/v2/guild/${guildId}`);
                                    if(gRes.ok) {
                                        const gInfo = await gRes.json();
                                        knownGuilds[guildId] = { name: gInfo.name, tag: gInfo.tag };
                                        newGuildsFound = true;
                                    }
                                } catch(e) {}
                            }
                        }
                    }
                } catch(e) {}
            });

            await Promise.all(promises);

            // Clean up old/removed guilds from list
            Object.keys(knownGuilds).forEach(gid => {
                if(!currentValidGuilds.has(gid)) {
                    delete knownGuilds[gid];
                    disabledGuilds.delete(gid);
                    newGuildsFound = true;
                }
            });

            if(newGuildsFound) {
                saveSettings();
                renderGuildSettings();
            }
        }

        // --- DATA FETCHING LOGIC ---

        async function fetchGlobalData() {
            itemsContainer.innerHTML = '<div class="loading">Loading all tracked items...</div>';
            
            discoverGuilds();

            const allIds = [...new Set(itemTabs.flatMap(t => t.items))];
            
            const promises = [
                fetchItemData(allIds),
                fetchAccountData()
            ];

            if(enableInventory) {
                itemsContainer.innerHTML = '<div class="loading">Loading items and scanning inventories...</div>';
                promises.push(fetchAccountInventories());
            } else {
                globalInventoryMap.clear(); 
            }
            
            try {
                const results = await Promise.all(promises);
                const itemResults = results[0];

                globalItemData.clear();
                itemResults.forEach(item => {
                    globalItemData.set(item.id, item);
                });

                renderActiveTab();
                if(enableInventory) renderGuildSettings(); 

            } catch (e) {
                console.error(e);
                itemsContainer.innerHTML = '<div class="error">Error loading items.</div>';
            }
        }

        function renderActiveTab() {
            itemsContainer.innerHTML = '';
            const activeIds = itemTabs[activeTabIndex].items;

            if (activeIds.length === 0) {
                itemsContainer.innerHTML = '<div class="loading">No items in this tab. Drop items here or add new ones.</div>';
                return;
            }

            activeIds.forEach(id => {
                const data = globalItemData.get(id);
                if (data) {
                    try {
                        itemsContainer.appendChild(createItemCard(data));
                    } catch (e) { console.error(e); }
                }
            });
        }

        async function fetchAccountData() {
            accountOrdersMap.clear();
            deliveryData = [];
            if(apiKeys.length === 0) return;

            const promises = apiKeys.flatMap(account => [
                fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/buys?access_token=${account.key}`).then(r => r.ok ? r.json() : []).then(d => ({ type: 'buys', data: d, account: account.name })),
                fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/sells?access_token=${account.key}`).then(r => r.ok ? r.json() : []).then(d => ({ type: 'sells', data: d, account: account.name })),
                fetch(`https://api.guildwars2.com/v2/commerce/delivery?access_token=${account.key}`).then(r => r.ok ? r.json() : null).then(d => ({ type: 'delivery', data: d, account: account.name }))
            ]);

            try {
                const results = await Promise.all(promises);
                
                results.filter(r => r.type !== 'delivery').forEach(res => {
                    res.data.forEach(order => {
                        if(!accountOrdersMap.has(order.item_id)) accountOrdersMap.set(order.item_id, { buys: [], sells: [] });
                        const entry = accountOrdersMap.get(order.item_id);
                        const cleanOrder = { ...order, accountName: res.account };
                        if(res.type === 'buys') entry.buys.push(cleanOrder);
                        else entry.sells.push(cleanOrder);
                    });
                });

                const deliveryResults = results.filter(r => r.type === 'delivery' && r.data);
                let hasDeliveryItems = false;
                const deliveryItemIds = new Set();
                
                deliveryResults.forEach(res => {
                    if (res.data.items && res.data.items.length > 0) {
                        res.data.items.forEach(i => deliveryItemIds.add(i.id));

                        // Add delivery items to the global inventory map
                        if (enableInventory) {
                            res.data.items.forEach(item => {
                                if (!globalInventoryMap.has(item.id)) globalInventoryMap.set(item.id, []);
                                globalInventoryMap.get(item.id).push({
                                    owner: res.account,
                                    source: 'Delivery Box',
                                    count: item.count,
                                    isGuild: false
                                });
                            });
                        }
                    }
                });

                const deliveryNameMap = new Map();
                if (deliveryItemIds.size > 0) {
                    const idsToFetch = Array.from(deliveryItemIds);
                    if (!staticItemData) await loadStaticItemData();
                    const fromCache = (staticItemData || []).filter(i => idsToFetch.includes(i.id));
                    fromCache.forEach(i => deliveryNameMap.set(i.id, { name: i.name, icon: i.icon }));

                    const missingIds = idsToFetch.filter(id => !deliveryNameMap.has(id));
                    if (missingIds.length > 0) {
                        try {
                            const apiItems = await fetch(`https://api.guildwars2.com/v2/items?ids=${missingIds.join(',')}`).then(r=>r.json());
                            apiItems.forEach(i => deliveryNameMap.set(i.id, { name: i.name, icon: i.icon }));
                        } catch(e) {}
                    }
                }

                deliveryResults.forEach(res => {
                    if (res.data.coins > 0 || res.data.items.length > 0) {
                        hasDeliveryItems = true;
                        const enrichedItems = res.data.items.map(i => {
                            const info = deliveryNameMap.get(i.id) || { name: `Item ${i.id}`, icon: '' };
                            return { ...i, ...info };
                        });
                        deliveryData.push({
                            accountName: res.account,
                            coins: res.data.coins,
                            items: enrichedItems
                        });
                    }
                });

                if (hasDeliveryItems) {
                    deliveryBtn.classList.add('has-delivery');
                    deliveryBtn.style.opacity = '1';
                } else {
                    deliveryBtn.classList.remove('has-delivery');
                    deliveryBtn.style.opacity = '0.4';
                }

            } catch (e) {
                console.error("Error fetching account data", e);
            }
        }

        // --- INVENTORY FETCHING ---
        async function fetchAccountInventories() {
            globalInventoryMap.clear();
            if(apiKeys.length === 0 || !enableInventory) return;

            const processedGuilds = new Set();
            const UPGRADE_MAP = { 58: 'Guild Stash', 377: 'Treasure Trove', 59: 'Deep Cave' };

            // Helper to add to map
            const addItemToMap = (id, count, owner, source, isGuild = false) => {
                if (id && count > 0) {
                    if (!globalInventoryMap.has(id)) globalInventoryMap.set(id, []);
                    globalInventoryMap.get(id).push({ owner, source, count, isGuild });
                }
            };

            const promises = apiKeys.map(async (account) => {
                try {
                    // 1. Material Storage
                    try {
                        const mats = await fetch(`https://api.guildwars2.com/v2/account/materials?access_token=${account.key}`).then(r=>r.json());
                        if(Array.isArray(mats)) {
                            mats.forEach(m => addItemToMap(m.id, m.count, account.name, 'Material Storage'));
                        }
                    } catch(e) {}

                    // 2. Bank (Vault)
                    try {
                        const bank = await fetch(`https://api.guildwars2.com/v2/account/bank?access_token=${account.key}`).then(r=>r.json());
                        if(Array.isArray(bank)) {
                            bank.forEach(item => {
                                if(item) addItemToMap(item.id, item.count, account.name, 'Bank Vault');
                            });
                        }
                    } catch(e) {}

                    // 3. Shared Inventory
                    try {
                        const shared = await fetch(`https://api.guildwars2.com/v2/account/inventory?access_token=${account.key}`).then(r=>r.json());
                        if(Array.isArray(shared)) {
                            shared.forEach(item => {
                                if(item) addItemToMap(item.id, item.count, account.name, 'Shared Slot');
                            });
                        }
                    } catch(e) {}

                    // 4. Characters
                    try {
                        const chars = await fetch(`https://api.guildwars2.com/v2/characters?ids=all&access_token=${account.key}`).then(r=>r.json());
                        if(Array.isArray(chars)) {
                            chars.forEach(char => {
                                if (char.bags) {
                                    char.bags.forEach(bag => {
                                        if (bag && bag.inventory) {
                                            bag.inventory.forEach(item => {
                                                if (item) addItemToMap(item.id, item.count, account.name, `Char: ${char.name}`);
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    } catch(e) {}

                    // 5. Guild Stashes (Strict Access Check)
                    try {
                        const accInfo = await fetch(`https://api.guildwars2.com/v2/account?access_token=${account.key}`).then(r=>r.json());
                        if(accInfo.guild_leader && Array.isArray(accInfo.guild_leader)) {
                            for (const guildId of accInfo.guild_leader) {
                                if(processedGuilds.has(guildId)) continue;
                                processedGuilds.add(guildId);

                                if(disabledGuilds.has(guildId)) continue;
                                
                                try {
                                    const stash = await fetch(`https://api.guildwars2.com/v2/guild/${guildId}/stash?access_token=${account.key}`).then(res => {
                                        if (!res.ok) throw new Error('No permission');
                                        return res.json();
                                    });

                                    const guildDetails = knownGuilds[guildId] || { name: 'Unknown Guild', tag: '???' };
                                    const guildName = `Guild: ${guildDetails.name} [${guildDetails.tag}]`;

                                    stash.forEach(tab => {
                                        if(tab.inventory) {
                                            const tabName = UPGRADE_MAP[tab.upgrade_id] || 'Vault Section';
                                            tab.inventory.forEach(item => {
                                                if(item) addItemToMap(item.id, item.count, guildName, tabName, true);
                                            });
                                        }
                                    });
                                } catch (permErr) {
                                    // Silent fail
                                }
                            }
                        }
                    } catch(e) {}

                } catch (err) {
                    console.warn(`Inventory check failed for ${account.name}`);
                }
            });

            await Promise.all(promises);
        }

        function openInventoryModal(itemId, itemName) {
            const modal = document.getElementById('inventory-modal');
            const content = document.getElementById('inventory-content');
            const title = document.getElementById('inventory-modal-title');
            
            title.textContent = `Inventory Locations for ${itemName}`;
            modal.style.display = 'flex';
            
            const items = globalInventoryMap.get(itemId) || [];
            
            if(items.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:20px;">None found.</div>';
                return;
            }
            
            const groups = {};
            let grandTotal = 0;

            items.forEach(i => {
                if (!groups[i.owner]) groups[i.owner] = { isGuild: i.isGuild, total: 0, sources: {} };
                
                if (!groups[i.owner].sources[i.source]) {
                    groups[i.owner].sources[i.source] = 0;
                }
                groups[i.owner].sources[i.source] += i.count;
                groups[i.owner].total += i.count;
                grandTotal += i.count;
            });
            
            const owners = Object.keys(groups).sort((a, b) => {
                const ga = groups[a], gb = groups[b];
                if (ga.isGuild !== gb.isGuild) return ga.isGuild ? 1 : -1; 
                return a.localeCompare(b);
            });
            
            let html = `<table class="data-table"><thead><tr><th style="width:60%">Location</th><th>Count</th></tr></thead><tbody>`;
            
            owners.forEach(ownerName => {
                const group = groups[ownerName];
                const ownerClass = group.isGuild ? 'col-guild' : 'col-account';
                
                html += `<tr class="inv-owner-header"><td class="${ownerClass}">${ownerName}</td><td style="font-weight:bold;">Total: ${group.total}</td></tr>`;
                
                const sources = Object.keys(group.sources).sort();
                
                sources.forEach(src => {
                    html += `<tr>
                        <td style="padding-left: 20px;">- ${src}</td>
                        <td class="col-qty">${group.sources[src]}</td>
                    </tr>`;
                });
            });
            
            html += `<tr style="border-top: 2px solid #3498db; background: rgba(255,255,255,0.05);"><td style="text-align:right; font-weight:bold;">Grand Total:</td><td class="col-qty" style="font-size:1.1em;">${grandTotal}</td></tr>`;
            html += `</tbody></table>`;
            
            content.innerHTML = html;
        }

        function openOrderModal(type, itemId, itemName) {
            const modalTitle = document.getElementById('order-modal-title');
            const content = document.getElementById('order-content');
            const modal = document.getElementById('order-modal');
            const itemData = globalItemData.get(itemId);
            
            const orders = accountOrdersMap.get(itemId)?.[type] || [];

            modalTitle.textContent = `${type === 'buys' ? 'Buy' : 'Sell'} Orders for ${itemName}`;
            modal.style.display = 'flex';
            
            if (orders.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:20px;">No active orders found.</div>';
                return;
            }

            orders.sort((a, b) => type === 'buys' ? b.price - a.price : a.price - b.price);
            
            let html = `
            <table class="data-table">
                <thead><tr><th>Account</th><th>Qty</th><th>Unit Price</th><th>Total Value</th><th>Date Placed</th></tr></thead>
                <tbody>`;
            
            orders.forEach(order => {
                const totalVal = order.quantity * order.price;
                const dateStr = new Date(order.created).toLocaleString();
                
                let warningHtml = '';
                if (itemData) {
                    if (type === 'buys' && itemData.buyPrice && order.price < itemData.buyPrice) {
                        warningHtml = ' <span title="Outbid by current market">âš ï¸</span>';
                    } else if (type === 'sells' && itemData.sellPrice && order.price > itemData.sellPrice) {
                        warningHtml = ' <span title="Undercut by current market">âš ï¸</span>';
                    }
                }

                html += `<tr>
                    <td class="col-account">${order.accountName}</td>
                    <td class="col-qty">${order.quantity}</td>
                    <td>${createCurrencyElement(order.price).outerHTML}${warningHtml}</td>
                    <td>${createCurrencyElement(totalVal).outerHTML}</td>
                    <td class="col-date">${dateStr}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        function openContainerModal(itemId) {
            const modal = document.getElementById('container-modal');
            const content = document.getElementById('container-content');
            const title = document.getElementById('container-modal-title');
            const itemData = globalItemData.get(itemId);

            if (!itemData || !itemData.isContainer) return;

            title.textContent = `Container: ${itemData.name}`;
            modal.style.display = 'flex';

            let html = `<table class="data-table"><thead><tr><th>Item Name</th><th>Chance / Qty</th><th>Expected Value</th></tr></thead><tbody>`;

            itemData.containerContents.forEach(c => {
                const probText = `${c.avgQty}x (${(c.prob*100).toFixed(0)}%)`;
                let valueHtml = '<span style="color:#7f8c8d;">N/A</span>';
                
                if (c.expectedCopper !== null) {
                    valueHtml = createCurrencyElement(c.expectedCopper).outerHTML;
                }

                html += `<tr>
                    <td>${c.name}</td>
                    <td>${probText}</td>
                    <td>${valueHtml}</td>
                </tr>`;
            });

            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        function openDeliveryModal() {
            const content = document.getElementById('delivery-content');
            const modal = document.getElementById('delivery-modal');
            modal.style.display = 'flex';

            if (deliveryData.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:20px;">No items or coins waiting for pickup.</div>';
                return;
            }

            let html = `<table class="data-table"><thead><tr><th>Account</th><th>Coins</th><th>Items</th></tr></thead><tbody>`;
            
            deliveryData.forEach(d => {
                let itemsHtml = '';
                if (d.items.length > 0) {
                    d.items.forEach(item => {
                        itemsHtml += `<div style="margin-bottom:4px;">
                            ${item.icon ? `<img src="${item.icon}" class="delivery-icon">` : ''}
                            <span class="delivery-item-name">${item.name}</span> 
                            <span class="col-qty">x${item.count}</span>
                        </div>`;
                    });
                } else {
                    itemsHtml = '<span style="color:#7f8c8d;">None</span>';
                }

                const coinsHtml = d.coins > 0 ? createCurrencyElement(d.coins).outerHTML : '<span style="color:#7f8c8d;">-</span>';

                html += `<tr>
                    <td class="col-account">${d.accountName}</td>
                    <td>${coinsHtml}</td>
                    <td>${itemsHtml}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        // --- IndexedDB & General Helpers ---
        function getDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('GW2Cache', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                };
            });
        }
        async function getCachedData(key) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const req = store.get(key);
                return new Promise(resolve => {
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }
        async function setCachedData(key, data) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                store.put(data, key);
                await tx.complete;
            } catch (e) { console.warn('DB Write Error', e); }
        }

        function formatCurrency(copper) {
            if (copper === null || copper === undefined || isNaN(copper)) return { gold: '-', silver: '-', copper: '-' };
            const gold = Math.floor(copper / 10000);
            const silver = Math.floor((copper % 10000) / 100);
            const copperRemainder = copper % 100;
            return { gold, silver, copper: copperRemainder };
        }
        function createCurrencyElement(copperValue) {
            const { gold, silver, copper } = formatCurrency(copperValue);
            const elem = document.createElement('div');
            elem.className = 'price-value';
            if (gold === '-' && silver === '-' && copper === '-') {
                elem.innerHTML = '<span style="color:#e74c3c;">N/A</span>';
                return elem;
            }
            elem.innerHTML = `
                ${gold > 0 ? `<span class="gold">${gold}</span>` : ''}
                ${silver > 0 || gold > 0 ? `<span class="silver">${silver}</span>` : ''}
                <span class="copper">${copper}</span>
            `;
            return elem;
        }

        async function fetchItemData(itemIds) {
            if (itemIds.length === 0) return [];
            const resultsMap = new Map();
            const specialIds = itemIds.filter(id => [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(id));
            const containerIds = itemIds.filter(isContainer);
            const regularIds = itemIds.filter(id => !specialIds.includes(id) && !containerIds.includes(id));

            if (regularIds.length > 0) {
                try {
                    const [details, commerce] = await Promise.all([
                        fetch(`https://api.guildwars2.com/v2/items?ids=${regularIds.join(',')}`).then(r => r.json()),
                        fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${regularIds.join(',')}`).then(r => r.ok ? r.json() : [])
                    ]);
                    for (const item of details) {
                        const p = commerce.find(c => c.id === item.id);
                        resultsMap.set(item.id, {
                            id: item.id, name: item.name, icon: item.icon,
                            buyPrice: p ? p.buys.unit_price : null, sellPrice: p ? p.sells.unit_price : null
                        });
                    }
                } catch (e) { console.error('Regular item fetch error', e); }
            }
            for (const sid of specialIds) {
                const def = SPECIAL_ITEMS[sid];
                try {
                    if (sid === GEMS_TO_GOLD_ID) {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/gems?quantity=400').then(r => r.json());
                        resultsMap.set(sid, { ...def, returnFor400Gems: d.quantity });
                    } else {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/coins?quantity=10000000').then(r => r.json());
                        const gemsPerGold = d.quantity / 1000;
                        resultsMap.set(sid, { ...def, costFor400Gems: Math.round((400 / gemsPerGold) * 10000) });
                    }
                } catch (e) { resultsMap.set(sid, { ...def, costFor400Gems: null, returnFor400Gems: null }); }
            }
            const childSet = new Set();
            containerIds.forEach(cid => CONTAINER_ITEMS[cid].items.forEach(i => childSet.add(i.id)));
            const childMap = new Map();
            if (childSet.size > 0) {
                try {
                    const prices = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    prices.forEach(p => childMap.set(p.id, p.sells?.unit_price));
                } catch (e) {}
            }
            const childNameMap = new Map();
            if (childSet.size > 0) {
                try {
                    const names = await fetch(`https://api.guildwars2.com/v2/items?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    names.forEach(n => childNameMap.set(n.id, n.name));
                } catch (e) {}
            }
            for (const cid of containerIds) {
                let meta = { name: 'Container', icon: '' };
                try { meta = await fetch(`https://api.guildwars2.com/v2/items/${cid}`).then(r => r.json()); } catch {}
                let total = 0;
                const breakdown = [];
                CONTAINER_ITEMS[cid].items.forEach(d => {
                    const p = childMap.get(d.id);
                    const name = childNameMap.get(d.id) || `Item ${d.id}`;
                    if (p) {
                        const val = p * d.avgQuantity * d.dropProb;
                        total += val;
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: Math.round(val) });
                    } else {
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: null });
                    }
                });
                resultsMap.set(cid, {
                    id: cid, name: meta.name, icon: meta.icon,
                    buyPrice: null, 
                    sellPrice: Math.round(total), isContainer: true, containerContents: breakdown
                });
            }
            return itemIds.map(id => resultsMap.get(id)).filter(Boolean);
        }

        function createItemCard(itemData) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = itemData.id;
            card.draggable = true;
            
            const isSpecial = [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(itemData.id);
            const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);
            const safeName = itemData.name.replace(/'/g, "\\'");
            const orders = accountOrdersMap.get(itemData.id) || { buys: [], sells: [] };
            const inventory = globalInventoryMap.get(itemData.id) || [];
            
            // Logic for warnings
            let buyClass = '';
            let buyTitle = 'You have active Buy Orders';
            if (orders.buys.length > 0 && itemData.buyPrice) {
                const maxUserPrice = Math.max(...orders.buys.map(o => o.price));
                if (maxUserPrice < itemData.buyPrice) {
                    buyClass = ' icon-warn';
                    buyTitle = 'Your Buy Orders are outbid';
                }
            }

            let sellClass = '';
            let sellTitle = 'You have active Sell Orders';
            if (orders.sells.length > 0 && itemData.sellPrice) {
                const minUserPrice = Math.min(...orders.sells.map(o => o.price));
                if (minUserPrice > itemData.sellPrice) {
                    sellClass = ' icon-warn';
                    sellTitle = 'Your Sell Listings are underbid';
                }
            }

            let emojisHtml = '';
            if (orders.buys.length > 0) emojisHtml += `<span class="order-icon icon-buy${buyClass}" onclick="openOrderModal('buys', ${itemData.id}, '${safeName}')" title="${buyTitle}">ðŸ›’</span>`;
            if (orders.sells.length > 0) emojisHtml += `<span class="order-icon icon-sell${sellClass}" onclick="openOrderModal('sells', ${itemData.id}, '${safeName}')" title="${sellTitle}">ðŸ·ï¸</span>`;
            if (inventory.length > 0) emojisHtml += `<span class="order-icon icon-inv" onclick="openInventoryModal(${itemData.id}, '${safeName}')" title="You possess this item">ðŸ‘œ</span>`;

            let containerEmoji = '';
            if (itemData.isContainer) {
                containerEmoji = `<span class="order-icon icon-info" onclick="openContainerModal(${itemData.id})" title="View Contents">â„¹ï¸</span>`;
            }

            const idHtml = isSpecial ? 'Special' : `ID: ${itemData.id} ${emojisHtml} ${containerEmoji}`;
            
            const actionBtns = `
                <div class="card-actions">
                    <button class="card-btn remove-btn" data-item-id="${itemData.id}" title="Remove Item">Ã—</button>
                </div>
            `;

            let mainContent = '';

            if (isSpecial) {
                let label = itemData.id === GOLD_TO_GEMS_ID ? 'Cost for 400 Gems:' : 'Return for 400 Gems:';
                let val = itemData.id === GOLD_TO_GEMS_ID ? itemData.costFor400Gems : itemData.returnFor400Gems;
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name">${itemData.name}</div>
                            <div class="item-id">Special</div>
                        </div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">${label}</div>${createCurrencyElement(val).outerHTML}</div>
                    </div>`;
            } else if (itemData.isContainer) {
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">ðŸ“ˆ</a> ${itemData.name}</div>
                            <div class="item-id">${idHtml} â€¢ Container</div>
                        </div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Expected Value:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Buy Price:</div><span style="color:#e74c3c;">Not Tradable</span></div>
                    </div>`;
            } else {
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">ðŸ“ˆ</a> ${itemData.name}</div>
                            <div class="item-id">${idHtml}</div>
                        </div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Buy Price:</div>${createCurrencyElement(itemData.buyPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Sell Price:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                    </div>`;
            }
            
            card.innerHTML = mainContent;

            const rmBtn = card.querySelector('.remove-btn');
            if(rmBtn) rmBtn.addEventListener('click', e => { e.stopPropagation(); removeFromActiveTab(Number(e.target.dataset.itemId)); });
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        function showError(m) { errorContainer.innerHTML = `<div class="error">${m}</div>`; setTimeout(() => errorContainer.innerHTML='', 4000); }
        function handleDragStart(e) { draggedCard = this; this.style.opacity = '0.5'; }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnd() { this.style.opacity = '1'; draggedCard = null; }
        function handleDrop(e) {
            e.preventDefault();
            if (draggedCard && draggedCard !== this) {
                const from = Number(draggedCard.dataset.itemId);
                const to = Number(this.dataset.itemId);
                
                const currentItems = itemTabs[activeTabIndex].items;
                const i1 = currentItems.indexOf(from);
                const i2 = currentItems.indexOf(to);
                
                if (i1 > -1 && i2 > -1) {
                    currentItems.splice(i1, 1);
                    currentItems.splice(i2, 0, from);
                    saveTabs();
                    renderActiveTab(); 
                }
            }
        }

        async function handleManualRefresh() {
            refreshItemsBtn.disabled = true;
            localStorage.removeItem('datawars_items_timestamp');
            await loadStaticItemData(true);
            await fetchGlobalData();
            refreshItemsBtn.disabled = false;
            showError('Database refreshed.');
        }
        
        const CACHE_KEY = 'datawars_items';
        async function loadStaticItemData(force = false) {
            if (staticItemData && !force) return staticItemData;
            const cache = await getCachedData(CACHE_KEY);
            if (cache && !force) { staticItemData = cache; return cache; }
            try {
                const res = await fetch('datawars_items.json?' + Date.now());
                if(res.ok) {
                    const d = await res.json();
                    await setCachedData(CACHE_KEY, d);
                    staticItemData = d;
                    return d;
                }
            } catch (e) {}
            return [];
        }

        async function searchItemsByName(q) {
            const lowerQ = q.toLowerCase();
            const customMatches = CUSTOM_SEARCHABLE_ITEMS.filter(i => i.name.toLowerCase().includes(lowerQ));
            await loadStaticItemData();
            const staticMatches = (staticItemData||[]).filter(i => i.name && i.name.toLowerCase().includes(lowerQ)).slice(0, 15);
            return [...customMatches, ...staticMatches];
        }

        function showSearchResults(res) {
            searchResultsContainer.innerHTML = '';
            res.forEach(i => {
                const d = document.createElement('div');
                d.className = 'search-result-item';
                d.innerHTML = `<div>${i.name}</div><div style="font-size:0.8em;color:#aaa">ID: ${i.id}</div>`;
                d.onclick = () => { 
                    addToActiveTab(i.id);
                    searchResultsContainer.style.display = 'none'; itemInput.value = ''; 
                };
                searchResultsContainer.appendChild(d);
            });
            searchResultsContainer.style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            loadSettings();
            loadTabs();
            fetchGlobalData(); 

            apiSettingsLink.onclick = () => { document.getElementById('api-modal').style.display = 'flex'; };
            deliveryBtn.onclick = () => { openDeliveryModal(); };

            document.getElementById('enable-inventory-chk').onchange = (e) => {
                enableInventory = e.target.checked;
                saveSettings();
                fetchGlobalData(); // Reload with setting applied
            };

            async function triggerAddItem() {
                const v = itemInput.value.trim();
                if(!v) return;
                const id = parseInt(v);
                if(!isNaN(id)) {
                    addToActiveTab(id);
                    itemInput.value = '';
                } else {
                    const res = await searchItemsByName(v);
                    showSearchResults(res);
                }
                itemInput.value = '';
            }

            addItemBtn.onclick = triggerAddItem;
            
            itemInput.addEventListener('keydown', (e) => {
                if (e.key === 'Enter') {
                    triggerAddItem();
                }
            });
            
            refreshItemsBtn.onclick = handleManualRefresh;
            
            window.onclick = (e) => { 
                if(!e.target.closest('.controls')) searchResultsContainer.style.display='none';
                if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
            };
            
            itemInput.oninput = (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const v = e.target.value.trim();
                    if(v.length > 2 && isNaN(parseInt(v))) showSearchResults(await searchItemsByName(v));
                }, 300);
            };
        });
    </script>
    <p></p>
    <a href="https://gartkb.github.io/Garts-Great-Tools/" style="color: yellow; text-decoration: underline;">Gart's Great Tools</a>
</body>
</html>