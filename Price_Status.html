<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guild Wars 2 Trading Post Tracker</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; }
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }
        
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:30px; display:flex; flex-direction:column; align-items:center; gap:10px; position:relative; }
        
        /* Wrapper for the row of Input + Buttons */
        .input-wrapper { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:700px; align-items: flex-start; }
        
        /* Column to stack Input and the small Link vertically, while keeping buttons to the right */
        .input-col { display: flex; flex-direction: column; flex: 1; min-width: 200px; position: relative; }

        input { padding:12px 15px; border:none; border-radius:5px; background:rgba(255,255,255,0.1); color:white; width:100%; font-size:1rem; border:1px solid #3498db; }
        input::placeholder { color:#95a5a6; }
        
        button { padding:12px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; height: 46px; /* Match input height */ }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; }
        
        /* API Link Styling (Small, Left Aligned under input) */
        .api-link {
            font-size: 0.7rem; /* Quite a bit smaller */
            color: #7f8c8d;
            text-decoration: none;
            cursor: pointer;
            margin-top: 4px;
            margin-left: 2px;
            text-align: left;
            align-self: flex-start;
            transition: color 0.3s;
        }
        .api-link:hover {
            color: #bdc3c7;
            text-decoration: underline;
        }

        /* --- DELIVERY BOX STYLES --- */
        #delivery-btn {
            background: #7f8c8d;
            opacity: 0.4; /* Unobtrusive by default */
            transition: all 0.5s ease;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        #delivery-btn.has-delivery {
            background: linear-gradient(135deg, #f1c40f, #e67e22);
            color: #2c3e50;
            opacity: 1;
            box-shadow: 0 0 15px rgba(241, 196, 15, 0.6);
            animation: pulse-glow 2s infinite;
        }
        @keyframes pulse-glow {
            0% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0.4); }
            70% { box-shadow: 0 0 0 10px rgba(241, 196, 15, 0); }
            100% { box-shadow: 0 0 0 0 rgba(241, 196, 15, 0); }
        }

        /* Search Results - Positioned relative to input-col now */
        .search-results { position:absolute; top:100%; left:0; width: 100%; background:rgba(0,0,0,0.95); border:1px solid #3498db; border-radius:5px; max-height:300px; overflow-y:auto; z-index:100; margin-top:5px; display:none; }
        .search-result-item { padding:10px 15px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
        .search-result-item:last-child { border-bottom:none; }
        .search-result-item:hover { background: rgba(52,152,219,0.25); }
        
        .items-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        
        /* Item Card Styling */
        .item-card { 
            background:rgba(0,0,0,0.4); 
            border-radius:10px; 
            overflow: visible; 
            transition:transform .3s; 
            display:flex; 
            flex-direction:column; 
            height:100%; 
            position:relative; 
            cursor:grab; 
        }
        .item-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .item-card:active { cursor:grabbing; transform:translateY(-2px); }
        
        .item-header { 
            position:relative; 
            padding:15px; 
            background:rgba(52,152,219,0.2); 
            display:flex; 
            align-items:center; 
            border-radius: 10px 10px 0 0;
        }
        
        .item-image { width:60px; height:60px; background:#1c1c1c; border-radius:5px; margin-right:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .item-image img { max-width:100%; max-height:100%; object-fit:contain; }
        .item-info { flex:1; overflow:visible; } 
        .item-name { font-size:1.2rem; font-weight:bold; margin-bottom:5px; white-space:nowrap; display:flex; align-items:center; }
        
        .item-id { color:#95a5a6; font-size:.9rem; display:flex; align-items:center; gap: 10px; min-height: 24px; }
        
        /* Specific Order Emojis */
        .order-icon { 
            cursor: pointer; 
            font-size: 1.2rem; 
            transition: transform 0.2s; 
            display: inline-flex;
            align-items: center;
            justify-content: center;
            border-radius: 4px;
            padding: 0 2px;
        }
        .order-icon:hover { transform: scale(1.2); background: rgba(255,255,255,0.1); }
        .icon-buy { filter: drop-shadow(0 0 2px rgba(46, 204, 113, 0.5)); border-bottom: 2px solid #2ecc71; }
        .icon-sell { filter: drop-shadow(0 0 2px rgba(231, 76, 60, 0.5)); border-bottom: 2px solid #e74c3c; }

        .item-prices { padding:20px; flex:1; }
        .price-row { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .price-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .price-label { font-weight:bold; }
        .price-value { display:flex; gap:8px; }
        .gold,.silver,.copper{ display:inline-flex; align-items:center; justify-content:center; padding:3px 8px; border-radius:4px; font-weight:bold; min-width:40px; text-align:center; }
        .gold { background:linear-gradient(to bottom,#ffd700,#daa520); color:#000; }
        .silver { background:linear-gradient(to bottom,#c0c0c0,#a9a9c0); color:#000; }
        .copper { background:linear-gradient(to bottom,#b87333,#8b4513); color:#fff; }
        .remove-btn-small { position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:50%; background:rgba(231,76,60,0.7); color:white; border:none; font-weight:bold; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; opacity:.8; transition:opacity .2s, background .2s; z-index:2; }
        .remove-btn-small:hover { opacity:1; background:rgba(231,76,60,1); }
        .loading { text-align:center; padding:20px; font-style:italic; color:#95a5a6; }
        .error { background:rgba(231,76,60,0.2); padding:15px; border-radius:5px; margin:20px 0; text-align:center; }
        .search-hint { text-align:center; color:#95a5a6; margin-top:5px; font-size:.9rem; }
        .manual-refresh { text-align:center; margin-top:30px; }
        .manual-refresh button { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71; padding: 8px 16px; font-size: 0.9rem; }
        .manual-refresh button:hover { background: rgba(46, 204, 113, 0.3); }
        .graph-link { color: #3498db; text-decoration: none; margin-left: 6px; font-size: 1.1rem; vertical-align: middle; opacity: 0.9; transition: opacity 0.2s, color 0.2s; }
        .graph-link:hover { opacity: 1; color: #2980b9; }

        .info-icon-wrapper { display: inline-block; position: relative; cursor: help; margin-left: 8px; font-size: 1.2rem; line-height: 1; }
        .container-tooltip { display: none; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: rgba(0, 0, 0, 0.95); border: 1px solid #3498db; border-radius: 6px; padding: 10px; width: 280px; z-index: 1000; font-size: 0.85rem; box-shadow: 0 4px 15px rgba(0,0,0,0.6); text-align: left; pointer-events: none; white-space: normal; }
        .info-icon-wrapper:hover .container-tooltip { display: block; }
        .tooltip-title { font-weight: bold; color: #3498db; margin-bottom: 6px; font-size: 0.9rem; border-bottom: 1px solid rgba(52,152,219,0.3); padding-bottom: 4px; }
        .tooltip-line { margin: 4px 0; color: #ecf0f1; display: flex; justify-content: space-between; }

        /* --- MODAL STYLES --- */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(3px);
        }
        .modal-content {
            background: #2c3e50;
            border: 1px solid #3498db;
            border-radius: 8px;
            width: 95%;
            max-width: 900px;
            padding: 20px;
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.5);
            max-height: 90vh;
            display: flex;
            flex-direction: column;
        }
        .modal-header { font-size: 1.5rem; color: #3498db; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: #ecf0f1; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-close:hover { color: #e74c3c; transform: none; background: none; }
        .modal-body { overflow-y: auto; flex: 1; }
        
        .api-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .api-list { display: flex; flex-direction: column; gap: 10px; }
        .api-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .api-name { font-weight: bold; color: #3498db; }
        .api-key-mask { color: #95a5a6; font-family: monospace; font-size: 0.8rem; margin-left: 10px; }
        .delete-key-btn { background: #e74c3c; padding: 5px 10px; font-size: 0.8rem; }

        /* Table Styles (Orders & Delivery) */
        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th { text-align: left; color: #95a5a6; padding: 8px; border-bottom: 1px solid #3498db; }
        .data-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
        .col-account { font-weight: bold; color: #2ecc71; }
        .col-qty { color: #f1c40f; font-weight: bold; }
        .col-date { font-size: 0.8rem; color: #bdc3c7; }
        .delivery-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; border-radius: 3px; }
        .delivery-item-name { vertical-align: middle; }

        @media (max-width:768px) { 
            .items-container{grid-template-columns:1fr;} 
            h1{font-size:2rem;} 
            .controls{position:relative;} 
            .search-results{width:100%; left:0; }
            .data-table { font-size: 0.8rem; }
            .input-wrapper { flex-direction: column; align-items: stretch; }
            .input-col { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Wars 2 Trading Post Tracker</h1>
            <p class="subtitle">Monitor prices for your favorite items</p>
        </header>
        <div class="controls">
            <div class="input-wrapper">
                <div class="input-col">
                    <input type="text" id="item-input" placeholder="Enter Item ID, Name, or Partial Name">
                    <a id="api-settings-link" class="api-link">Manage API Keys</a>
                    <div id="search-results" class="search-results"></div>
                </div>
                <button id="add-item-btn">Add Item</button>
                <button id="delivery-btn" title="Check Delivery Box">
                    <span>üì¶</span> Delivery Box
                </button>
            </div>
            <p class="search-hint">Examples: "Ectoplasm", "19721", "Gossamer", "Gold to Gems", "Gems to Gold"</p>
        </div>
        <div id="error-container"></div>
        <div id="items-container" class="items-container">
            <div class="loading">Loading items...</div>
        </div>
        <div class="manual-refresh">
            <button id="refresh-items-btn">Refresh item IDs from server</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Manage API Keys</span>
                <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="api-input-row">
                    <input type="text" id="new-api-key" placeholder="Paste API Key (needs 'tradingpost' scope)" style="flex:2">
                    <input type="text" id="new-api-name" placeholder="Nickname" style="flex:1">
                    <button onclick="addApiKey()">Add</button>
                </div>
                <div id="api-key-list" class="api-list"></div>
                <p style="margin-top:15px; font-size:0.8rem; color:#95a5a6;">
                    Keys are saved in your browser's Local Storage.
                </p>
            </div>
        </div>
    </div>

    <!-- Order Viewer Modal -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="order-modal-title">Orders</span>
                <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-content"></div>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="delivery-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Delivery Box Content</span>
                <button class="modal-close" onclick="closeModal('delivery-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="delivery-content"></div>
            </div>
        </div>
    </div>

    <script>
        const itemInput = document.getElementById('item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items-container');
        const errorContainer = document.getElementById('error-container');
        const searchResultsContainer = document.getElementById('search-results');
        const refreshItemsBtn = document.getElementById('refresh-items-btn');
        const apiSettingsLink = document.getElementById('api-settings-link');
        const deliveryBtn = document.getElementById('delivery-btn');
        
        const GOLD_TO_GEMS_ID = 9990001;
        const GEMS_TO_GOLD_ID = 9990002;
        const GRAPH_URL_TEMPLATE = 'https://en.gw2treasures.com/item/{id}';
        
        const SPECIAL_ITEMS = {
            [GOLD_TO_GEMS_ID]: { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems', icon: 'https://wiki.guildwars2.com/images/8/88/Gem_%28highres%29.png', type: 'gold-to-gems' },
            [GEMS_TO_GOLD_ID]: { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold', icon: 'https://wiki.guildwars2.com/images/d/d1/Gold_coin.png', type: 'gems-to-gold' }
        };

        // Container Definitions
        const CONTAINER_ITEMS = {
            39121: { items: [{ id: 24344, avgQuantity: 3, dropProb: 0.625 }, { id: 24348, avgQuantity: 3, dropProb: 0.625 }, { id: 24274, avgQuantity: 3, dropProb: 0.625 }, { id: 24354, avgQuantity: 3, dropProb: 0.625 }, { id: 24286, avgQuantity: 3, dropProb: 0.625 }, { id: 24280, avgQuantity: 3, dropProb: 0.625 }, { id: 24298, avgQuantity: 3, dropProb: 0.625 }, { id: 24292, avgQuantity: 3, dropProb: 0.625 }] },
            39122: { items: [{ id: 24275, avgQuantity: 3, dropProb: 0.625 }, { id: 24345, avgQuantity: 3, dropProb: 0.625 }, { id: 24281, avgQuantity: 3, dropProb: 0.625 }, { id: 24349, avgQuantity: 3, dropProb: 0.625 }, { id: 24363, avgQuantity: 3, dropProb: 0.625 }, { id: 24287, avgQuantity: 3, dropProb: 0.625 }, { id: 24355, avgQuantity: 3, dropProb: 0.625 }, { id: 24293, avgQuantity: 3, dropProb: 0.625 }] },          
            39124: { items: [{ id: 24295, avgQuantity: 1, dropProb: 0.375 }, { id: 24357, avgQuantity: 1, dropProb: 0.375 }, { id: 24277, avgQuantity: 1, dropProb: 0.375 }, { id: 24289, avgQuantity: 1, dropProb: 0.375 }, { id: 24358, avgQuantity: 1, dropProb: 0.375 }, { id: 24300, avgQuantity: 1, dropProb: 0.375 }, { id: 24351, avgQuantity: 1, dropProb: 0.375 }, { id: 24283, avgQuantity: 1, dropProb: 0.375 }] }
        };
        
        // Manually defined items for search (Ensures Containers and Specials show up)
        const CUSTOM_SEARCHABLE_ITEMS = [
            { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems' },
            { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold' },
            { id: 39121, name: 'Light Crafting Bag' },
            { id: 39122, name: 'Medium Crafting Bag' },
            { id: 39124, name: 'Heavy Crafting Bag' }
        ];

        function isContainer(id) { return CONTAINER_ITEMS.hasOwnProperty(id); }

        let trackedItems = [19721];
        let staticItemData = null;
        let apiKeys = []; 
        let accountOrdersMap = new Map(); 
        let deliveryData = []; 
        const DEBOUNCE_DELAY = 300;
        let debounceTimer = null;
        let draggedCard = null;

        // --- API Key Management ---
        function loadApiKeys() {
            const stored = localStorage.getItem('gw2_api_keys');
            if (stored) {
                try { apiKeys = JSON.parse(stored); } catch (e) { apiKeys = []; }
            }
            renderApiKeys();
        }
        function saveApiKeys() {
            localStorage.setItem('gw2_api_keys', JSON.stringify(apiKeys));
            renderApiKeys();
        }
        function addApiKey() {
            const keyInput = document.getElementById('new-api-key');
            const nameInput = document.getElementById('new-api-name');
            const key = keyInput.value.trim();
            const name = nameInput.value.trim() || 'Account ' + (apiKeys.length + 1);
            if (!key) { alert('Please enter an API Key'); return; }
            apiKeys.push({ key, name });
            saveApiKeys();
            keyInput.value = ''; nameInput.value = '';
            fetchAndDisplayItems(); 
        }
        function removeApiKey(index) {
            if(confirm('Remove this API key?')) {
                apiKeys.splice(index, 1);
                saveApiKeys();
                fetchAndDisplayItems(); 
            }
        }
        function renderApiKeys() {
            const list = document.getElementById('api-key-list');
            list.innerHTML = '';
            if(apiKeys.length === 0) {
                list.innerHTML = '<div style="color:#95a5a6; text-align:center;">No API keys configured.</div>';
                return;
            }
            apiKeys.forEach((k, i) => {
                const div = document.createElement('div');
                div.className = 'api-item';
                div.innerHTML = `<div><span class="api-name">${k.name}</span><span class="api-key-mask">${k.key.substring(0,8)}...</span></div><button class="delete-key-btn" onclick="removeApiKey(${i})">Delete</button>`;
                list.appendChild(div);
            });
        }

        // --- DATA FETCHING LOGIC ---

        async function fetchAccountData() {
            accountOrdersMap.clear();
            deliveryData = [];
            if(apiKeys.length === 0) return;

            const promises = apiKeys.flatMap(account => [
                fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/buys?access_token=${account.key}`).then(r => r.ok ? r.json() : []).then(d => ({ type: 'buys', data: d, account: account.name })),
                fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/sells?access_token=${account.key}`).then(r => r.ok ? r.json() : []).then(d => ({ type: 'sells', data: d, account: account.name })),
                fetch(`https://api.guildwars2.com/v2/commerce/delivery?access_token=${account.key}`).then(r => r.ok ? r.json() : null).then(d => ({ type: 'delivery', data: d, account: account.name }))
            ]);

            try {
                const results = await Promise.all(promises);
                
                results.filter(r => r.type !== 'delivery').forEach(res => {
                    res.data.forEach(order => {
                        if(!accountOrdersMap.has(order.item_id)) accountOrdersMap.set(order.item_id, { buys: [], sells: [] });
                        const entry = accountOrdersMap.get(order.item_id);
                        const cleanOrder = { ...order, accountName: res.account };
                        if(res.type === 'buys') entry.buys.push(cleanOrder);
                        else entry.sells.push(cleanOrder);
                    });
                });

                const deliveryResults = results.filter(r => r.type === 'delivery' && r.data);
                let hasDeliveryItems = false;
                const deliveryItemIds = new Set();
                deliveryResults.forEach(res => {
                    if (res.data.items && res.data.items.length > 0) res.data.items.forEach(i => deliveryItemIds.add(i.id));
                });

                const deliveryNameMap = new Map();
                if (deliveryItemIds.size > 0) {
                    const idsToFetch = Array.from(deliveryItemIds);
                    if (!staticItemData) await loadStaticItemData();
                    const fromCache = (staticItemData || []).filter(i => idsToFetch.includes(i.id));
                    fromCache.forEach(i => deliveryNameMap.set(i.id, { name: i.name, icon: i.icon }));

                    const missingIds = idsToFetch.filter(id => !deliveryNameMap.has(id));
                    if (missingIds.length > 0) {
                        try {
                            const apiItems = await fetch(`https://api.guildwars2.com/v2/items?ids=${missingIds.join(',')}`).then(r=>r.json());
                            apiItems.forEach(i => deliveryNameMap.set(i.id, { name: i.name, icon: i.icon }));
                        } catch(e) {}
                    }
                }

                deliveryResults.forEach(res => {
                    if (res.data.coins > 0 || res.data.items.length > 0) {
                        hasDeliveryItems = true;
                        const enrichedItems = res.data.items.map(i => {
                            const info = deliveryNameMap.get(i.id) || { name: `Item ${i.id}`, icon: '' };
                            return { ...i, ...info };
                        });
                        deliveryData.push({
                            accountName: res.account,
                            coins: res.data.coins,
                            items: enrichedItems
                        });
                    }
                });

                if (hasDeliveryItems) {
                    deliveryBtn.classList.add('has-delivery');
                    deliveryBtn.style.opacity = '1';
                } else {
                    deliveryBtn.classList.remove('has-delivery');
                    deliveryBtn.style.opacity = '0.4';
                }

            } catch (e) {
                console.error("Error fetching account data", e);
            }
        }

        function openOrderModal(type, itemId, itemName) {
            const modalTitle = document.getElementById('order-modal-title');
            const content = document.getElementById('order-content');
            const modal = document.getElementById('order-modal');
            const orders = accountOrdersMap.get(itemId)?.[type] || [];

            modalTitle.textContent = `${type === 'buys' ? 'Buy' : 'Sell'} Orders for ${itemName}`;
            modal.style.display = 'flex';
            
            if (orders.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:20px;">No active orders found.</div>';
                return;
            }

            orders.sort((a, b) => type === 'buys' ? b.price - a.price : a.price - b.price);
            
            let html = `
            <table class="data-table">
                <thead><tr><th>Account</th><th>Qty</th><th>Unit Price</th><th>Total Value</th><th>Date Placed</th></tr></thead>
                <tbody>`;
            
            orders.forEach(order => {
                const totalVal = order.quantity * order.price;
                const dateStr = new Date(order.created).toLocaleString();
                html += `<tr>
                    <td class="col-account">${order.accountName}</td>
                    <td class="col-qty">${order.quantity}</td>
                    <td>${createCurrencyElement(order.price).outerHTML}</td>
                    <td>${createCurrencyElement(totalVal).outerHTML}</td>
                    <td class="col-date">${dateStr}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        function openDeliveryModal() {
            const content = document.getElementById('delivery-content');
            const modal = document.getElementById('delivery-modal');
            modal.style.display = 'flex';

            if (deliveryData.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:20px;">No items or coins waiting for pickup.</div>';
                return;
            }

            let html = `<table class="data-table"><thead><tr><th>Account</th><th>Coins</th><th>Items</th></tr></thead><tbody>`;
            
            deliveryData.forEach(d => {
                let itemsHtml = '';
                if (d.items.length > 0) {
                    d.items.forEach(item => {
                        itemsHtml += `<div style="margin-bottom:4px;">
                            ${item.icon ? `<img src="${item.icon}" class="delivery-icon">` : ''}
                            <span class="delivery-item-name">${item.name}</span> 
                            <span class="col-qty">x${item.count}</span>
                        </div>`;
                    });
                } else {
                    itemsHtml = '<span style="color:#7f8c8d;">None</span>';
                }

                const coinsHtml = d.coins > 0 ? createCurrencyElement(d.coins).outerHTML : '<span style="color:#7f8c8d;">-</span>';

                html += `<tr>
                    <td class="col-account">${d.accountName}</td>
                    <td>${coinsHtml}</td>
                    <td>${itemsHtml}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        // --- IndexedDB & General Helpers ---
        function getDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('GW2Cache', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                };
            });
        }
        async function getCachedData(key) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const req = store.get(key);
                return new Promise(resolve => {
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }
        async function setCachedData(key, data) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                store.put(data, key);
                await tx.complete;
            } catch (e) { console.warn('DB Write Error', e); }
        }
        function loadTrackedItems() {
            const saved = localStorage.getItem('gw2_tracked_items');
            if (saved) {
                try { trackedItems = JSON.parse(saved).map(id => Number(id)).filter(n => !isNaN(n)); } 
                catch { trackedItems = []; }
            }
        }
        function saveTrackedItems() { localStorage.setItem('gw2_tracked_items', JSON.stringify(trackedItems)); }

        function formatCurrency(copper) {
            if (copper === null || copper === undefined || isNaN(copper)) return { gold: '-', silver: '-', copper: '-' };
            const gold = Math.floor(copper / 10000);
            const silver = Math.floor((copper % 10000) / 100);
            const copperRemainder = copper % 100;
            return { gold, silver, copper: copperRemainder };
        }
        function createCurrencyElement(copperValue) {
            const { gold, silver, copper } = formatCurrency(copperValue);
            const elem = document.createElement('div');
            elem.className = 'price-value';
            if (gold === '-' && silver === '-' && copper === '-') {
                elem.innerHTML = '<span style="color:#e74c3c;">N/A</span>';
                return elem;
            }
            elem.innerHTML = `
                ${gold > 0 ? `<span class="gold">${gold}</span>` : ''}
                ${silver > 0 || gold > 0 ? `<span class="silver">${silver}</span>` : ''}
                <span class="copper">${copper}</span>
            `;
            return elem;
        }

        async function fetchItemData(itemIds) {
            const resultsMap = new Map();
            const specialIds = itemIds.filter(id => [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(id));
            const containerIds = itemIds.filter(isContainer);
            const regularIds = itemIds.filter(id => !specialIds.includes(id) && !containerIds.includes(id));

            if (regularIds.length > 0) {
                try {
                    const [details, commerce] = await Promise.all([
                        fetch(`https://api.guildwars2.com/v2/items?ids=${regularIds.join(',')}`).then(r => r.json()),
                        fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${regularIds.join(',')}`).then(r => r.ok ? r.json() : [])
                    ]);
                    for (const item of details) {
                        const p = commerce.find(c => c.id === item.id);
                        resultsMap.set(item.id, {
                            id: item.id, name: item.name, icon: item.icon,
                            buyPrice: p ? p.buys.unit_price : null, sellPrice: p ? p.sells.unit_price : null
                        });
                    }
                } catch (e) { console.error('Regular item fetch error', e); }
            }
            for (const sid of specialIds) {
                const def = SPECIAL_ITEMS[sid];
                try {
                    if (sid === GEMS_TO_GOLD_ID) {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/gems?quantity=400').then(r => r.json());
                        resultsMap.set(sid, { ...def, returnFor400Gems: d.quantity });
                    } else {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/coins?quantity=10000000').then(r => r.json());
                        const gemsPerGold = d.quantity / 1000;
                        resultsMap.set(sid, { ...def, costFor400Gems: Math.round((400 / gemsPerGold) * 10000) });
                    }
                } catch (e) { resultsMap.set(sid, { ...def, costFor400Gems: null, returnFor400Gems: null }); }
            }
            const childSet = new Set();
            containerIds.forEach(cid => CONTAINER_ITEMS[cid].items.forEach(i => childSet.add(i.id)));
            const childMap = new Map();
            if (childSet.size > 0) {
                try {
                    const prices = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    prices.forEach(p => childMap.set(p.id, p.sells?.unit_price));
                } catch (e) {}
            }
            const childNameMap = new Map();
            if (childSet.size > 0) {
                try {
                    const names = await fetch(`https://api.guildwars2.com/v2/items?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    names.forEach(n => childNameMap.set(n.id, n.name));
                } catch (e) {}
            }
            for (const cid of containerIds) {
                let meta = { name: 'Container', icon: '' };
                try { meta = await fetch(`https://api.guildwars2.com/v2/items/${cid}`).then(r => r.json()); } catch {}
                let total = 0;
                const breakdown = [];
                CONTAINER_ITEMS[cid].items.forEach(d => {
                    const p = childMap.get(d.id);
                    const name = childNameMap.get(d.id) || `Item ${d.id}`;
                    if (p) {
                        const val = p * d.avgQuantity * d.dropProb;
                        total += val;
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: Math.round(val) });
                    } else {
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: null });
                    }
                });
                resultsMap.set(cid, {
                    id: cid, name: meta.name, icon: meta.icon,
                    buyPrice: null, 
                    sellPrice: Math.round(total), isContainer: true, containerContents: breakdown
                });
            }
            return itemIds.map(id => resultsMap.get(id)).filter(Boolean);
        }

        async function fetchAndDisplayItems() {
            itemsContainer.innerHTML = '<div class="loading">Loading items and checking orders...</div>';
            try {
                const [items, _] = await Promise.all([
                    fetchItemData(trackedItems),
                    fetchAccountData()
                ]);

                itemsContainer.innerHTML = '';
                if (!items.length) { itemsContainer.innerHTML = '<div class="loading">No items tracked.</div>'; return; }
                
                items.forEach(i => {
                    try {
                        itemsContainer.appendChild(createItemCard(i));
                    } catch (cardError) {
                        console.error("Error creating card for", i.id, cardError);
                    }
                });
            } catch (e) {
                console.error(e);
                itemsContainer.innerHTML = '<div class="error">Error loading items.</div>';
            }
        }

        function createItemCard(itemData) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = itemData.id;
            card.draggable = true;
            
            const isSpecial = [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(itemData.id);
            const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);
            const safeName = itemData.name.replace(/'/g, "\\'");
            const orders = accountOrdersMap.get(itemData.id) || { buys: [], sells: [] };
            
            let emojisHtml = '';
            if (orders.buys.length > 0) emojisHtml += `<span class="order-icon icon-buy" onclick="openOrderModal('buys', ${itemData.id}, '${safeName}')" title="You have active Buy Orders">üõí</span>`;
            if (orders.sells.length > 0) emojisHtml += `<span class="order-icon icon-sell" onclick="openOrderModal('sells', ${itemData.id}, '${safeName}')" title="You have active Sell Orders">üè∑Ô∏è</span>`;

            const idHtml = isSpecial ? 'Special' : `ID: ${itemData.id} ${emojisHtml}`;

            if (isSpecial) {
                let label = itemData.id === GOLD_TO_GEMS_ID ? 'Cost for 400 Gems:' : 'Return for 400 Gems:';
                let val = itemData.id === GOLD_TO_GEMS_ID ? itemData.costFor400Gems : itemData.returnFor400Gems;
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name">${itemData.name}</div>
                            <div class="item-id">Special</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">${label}</div>${createCurrencyElement(val).outerHTML}</div>
                    </div>`;
            } else if (itemData.isContainer) {
                const content = itemData.containerContents.map(c => {
                    const probText = `${c.avgQty}x (${(c.prob*100).toFixed(0)}%)`;
                    if (c.expectedCopper === null) return `<div class="tooltip-line"><span>${c.name}</span><span>N/A</span></div>`;
                    const { gold, silver, copper } = formatCurrency(c.expectedCopper);
                    const pHtml = `${gold>0?gold+'g ':''}${silver>0?silver+'s ':''}${copper}c`;
                    return `<div class="tooltip-line"><span class="child-name">${c.name} (${probText})</span><span style="color:#f1c40f">${pHtml}</span></div>`;
                }).join('');
                const infoEmoji = `<span class="info-icon-wrapper">‚ÑπÔ∏è<div class="container-tooltip"><div class="tooltip-title">Expected Value Breakdown</div>${content}</div></span>`;
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">üìà</a> ${itemData.name} ${infoEmoji}</div>
                            <div class="item-id">${idHtml} ‚Ä¢ Container</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Expected Value:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Buy Price:</div><span style="color:#e74c3c;">Not Tradable</span></div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">üìà</a> ${itemData.name}</div>
                            <div class="item-id">${idHtml}</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Buy Price:</div>${createCurrencyElement(itemData.buyPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Sell Price:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                    </div>`;
            }

            const btn = card.querySelector('.remove-btn-small');
            if(btn) btn.addEventListener('click', e => { e.stopPropagation(); removeItem(Number(e.target.dataset.itemId)); });
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        // --- Standard Utils ---
        function removeItem(id) { trackedItems = trackedItems.filter(x => x !== id); saveTrackedItems(); fetchAndDisplayItems(); }
        function showError(m) { errorContainer.innerHTML = `<div class="error">${m}</div>`; setTimeout(() => errorContainer.innerHTML='', 4000); }
        function handleDragStart(e) { draggedCard = this; this.style.opacity = '0.5'; }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnd() { this.style.opacity = '1'; draggedCard = null; }
        function handleDrop(e) {
            e.preventDefault();
            if (draggedCard && draggedCard !== this) {
                const from = Number(draggedCard.dataset.itemId);
                const to = Number(this.dataset.itemId);
                const i1 = trackedItems.indexOf(from), i2 = trackedItems.indexOf(to);
                if (i1 > -1 && i2 > -1) {
                    trackedItems.splice(i1, 1);
                    trackedItems.splice(i2, 0, from);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                }
            }
        }

        async function handleManualRefresh() {
            refreshItemsBtn.disabled = true;
            localStorage.removeItem('datawars_items_timestamp');
            await loadStaticItemData(true);
            refreshItemsBtn.disabled = false;
            showError('Database refreshed.');
        }
        
        const CACHE_KEY = 'datawars_items';
        async function loadStaticItemData(force = false) {
            if (staticItemData && !force) return staticItemData;
            const cache = await getCachedData(CACHE_KEY);
            if (cache && !force) { staticItemData = cache; return cache; }
            try {
                const res = await fetch('datawars_items.json?' + Date.now());
                if(res.ok) {
                    const d = await res.json();
                    await setCachedData(CACHE_KEY, d);
                    staticItemData = d;
                    return d;
                }
            } catch (e) {}
            return [];
        }

        // UPDATED Search function to include Custom Items
        async function searchItemsByName(q) {
            const lowerQ = q.toLowerCase();
            const customMatches = CUSTOM_SEARCHABLE_ITEMS.filter(i => i.name.toLowerCase().includes(lowerQ));
            await loadStaticItemData();
            const staticMatches = (staticItemData||[]).filter(i => i.name && i.name.toLowerCase().includes(lowerQ)).slice(0, 15);
            return [...customMatches, ...staticMatches];
        }

        function showSearchResults(res) {
            searchResultsContainer.innerHTML = '';
            res.forEach(i => {
                const d = document.createElement('div');
                d.className = 'search-result-item';
                d.innerHTML = `<div>${i.name}</div><div style="font-size:0.8em;color:#aaa">ID: ${i.id}</div>`;
                d.onclick = () => { 
                    if(!trackedItems.includes(i.id)) { trackedItems.push(i.id); saveTrackedItems(); fetchAndDisplayItems(); }
                    searchResultsContainer.style.display = 'none'; itemInput.value = ''; 
                };
                searchResultsContainer.appendChild(d);
            });
            searchResultsContainer.style.display = 'block';
        }

        function closeModal(id) {
            document.getElementById(id).style.display = 'none';
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            loadTrackedItems();
            fetchAndDisplayItems();

            apiSettingsLink.onclick = () => { document.getElementById('api-modal').style.display = 'flex'; };
            deliveryBtn.onclick = () => { openDeliveryModal(); };

            addItemBtn.onclick = async () => {
                const v = itemInput.value.trim();
                if(!v) return;
                const id = parseInt(v);
                if(!isNaN(id)) {
                    if(!trackedItems.includes(id)) { trackedItems.push(id); saveTrackedItems(); fetchAndDisplayItems(); }
                } else {
                    const res = await searchItemsByName(v);
                    showSearchResults(res);
                }
                itemInput.value = '';
            };
            
            refreshItemsBtn.onclick = handleManualRefresh;
            
            window.onclick = (e) => { 
                if(!e.target.closest('.controls')) searchResultsContainer.style.display='none';
                if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
            };
            
            itemInput.oninput = (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const v = e.target.value.trim();
                    if(v.length > 2 && isNaN(parseInt(v))) showSearchResults(await searchItemsByName(v));
                }, 300);
            };
        });
    </script>
    <p></p>
    <a href="https://gartkb.github.io/Garts-Great-Tools/" style="color: yellow; text-decoration: underline;">Gart's Great Tools</a>
</body>
</html>
