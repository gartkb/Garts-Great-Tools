<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guild Wars 2 Trading Post Tracker</title>
    <style>
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; }
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:30px; display:flex; flex-wrap:wrap; gap:15px; justify-content:center; position:relative; }
        .input-group { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:600px; }
        input { padding:12px 15px; border:none; border-radius:5px; background:rgba(255,255,255,0.1); color:white; width:250px; font-size:1rem; border:1px solid #3498db; flex:1; min-width:200px; }
        input::placeholder { color:#95a5a6; }
        button { padding:12px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; }
        .search-results { position:absolute; top:100%; left:50%; transform:translateX(-50%); background:rgba(0,0,0,0.85); border:1px solid #3498db; border-radius:5px; width:90%; max-width:500px; max-height:300px; overflow-y:auto; z-index:10; margin-top:5px; display:none; }
        .search-result-item { padding:10px 15px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
        .search-result-item:last-child { border-bottom:none; }
        .search-result-item:hover { background: rgba(52,152,219,0.15); }
        .search-result-text { flex:1; font-size:.95rem; }
        .search-result-id { color:#95a5a6; font-size:.8rem; }
        .items-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        
        /* Item Card Styling */
        .item-card { 
            background:rgba(0,0,0,0.4); 
            border-radius:10px; 
            overflow: visible; /* Critical for tooltips */
            transition:transform .3s; 
            display:flex; 
            flex-direction:column; 
            height:100%; 
            position:relative; 
            cursor:grab; 
        }
        .item-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .item-card:active { cursor:grabbing; transform:translateY(-2px); }
        
        .item-header { 
            position:relative; 
            padding:15px; 
            background:rgba(52,152,219,0.2); 
            display:flex; 
            align-items:center; 
            border-radius: 10px 10px 0 0;
        }
        
        .item-image { width:60px; height:60px; background:#1c1c1c; border-radius:5px; margin-right:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .item-image img { max-width:100%; max-height:100%; object-fit:contain; }
        .item-info { flex:1; overflow:visible; } 
        .item-name { font-size:1.2rem; font-weight:bold; margin-bottom:5px; white-space:nowrap; display:flex; align-items:center; }
        .item-id { color:#95a5a6; font-size:.9rem; user-select:text; cursor:text; }
        .item-prices { padding:20px; flex:1; }
        .price-row { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .price-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .price-label { font-weight:bold; }
        .price-value { display:flex; gap:8px; }
        .gold,.silver,.copper{ display:inline-flex; align-items:center; justify-content:center; padding:3px 8px; border-radius:4px; font-weight:bold; min-width:40px; text-align:center; }
        .gold { background:linear-gradient(to bottom,#ffd700,#daa520); color:#000; }
        .silver { background:linear-gradient(to bottom,#c0c0c0,#a9a9c0); color:#000; }
        .copper { background:linear-gradient(to bottom,#b87333,#8b4513); color:#fff; }
        .remove-btn-small { position:absolute; top:8px; right:8px; width:24px; height:24px; border-radius:50%; background:rgba(231,76,60,0.7); color:white; border:none; font-weight:bold; font-size:16px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; opacity:.8; transition:opacity .2s, background .2s; z-index:2; }
        .remove-btn-small:hover { opacity:1; background:rgba(231,76,60,1); }
        .loading { text-align:center; padding:20px; font-style:italic; color:#95a5a6; }
        .error { background:rgba(231,76,60,0.2); padding:15px; border-radius:5px; margin:20px 0; text-align:center; }
        .search-hint { text-align:center; color:#95a5a6; margin-top:5px; font-size:.9rem; }
        .spinner { border:2px solid rgba(255,255,255,0.3); border-radius:50%; border-top:2px solid white; width:16px; height:16px; animation:spin 1s linear infinite; margin-right:8px; display:inline-block; vertical-align:middle; }
        @keyframes spin { 0%{transform:rotate(0deg);}100%{transform:rotate(360deg);} }
        .manual-refresh { text-align:center; margin-top:30px; }
        .manual-refresh button {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid #2ecc71;
            color: #2ecc71;
            padding: 8px 16px;
            font-size: 0.9rem;
        }
        .manual-refresh button:hover {
            background: rgba(46, 204, 113, 0.3);
        }
        .graph-link {
            color: #3498db;
            text-decoration: none;
            margin-left: 6px;
            font-size: 1.1rem;
            vertical-align: middle;
            opacity: 0.9;
            transition: opacity 0.2s, color 0.2s;
        }
        .graph-link:hover { opacity: 1; color: #2980b9; }

        /* --- INFO EMOJI & TOOLTIP STYLES --- */
        .info-icon-wrapper {
            display: inline-block;
            position: relative;
            cursor: help;
            margin-left: 8px;
            font-size: 1.2rem;
            line-height: 1;
        }
        
        /* Tooltip styling */
        .container-tooltip {
            display: none;
            position: absolute;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.95);
            border: 1px solid #3498db;
            border-radius: 6px;
            padding: 10px;
            width: 280px;
            z-index: 1000;
            font-size: 0.85rem;
            box-shadow: 0 4px 15px rgba(0,0,0,0.6);
            text-align: left;
            pointer-events: none;
            white-space: normal;
        }
        
        .info-icon-wrapper:hover .container-tooltip {
            display: block;
        }

        .tooltip-title {
            font-weight: bold;
            color: #3498db;
            margin-bottom: 6px;
            font-size: 0.9rem;
            border-bottom: 1px solid rgba(52,152,219,0.3);
            padding-bottom: 4px;
        }
        .tooltip-line {
            margin: 4px 0;
            color: #ecf0f1;
            display: flex;
            justify-content: space-between;
        }
        @media (max-width:768px) { .items-container{grid-template-columns:1fr;} h1{font-size:2rem;} .controls{position:relative;} .search-results{width:95%; left:50%; transform:translateX(-50%);} }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Wars 2 Trading Post Tracker</h1>
            <p class="subtitle">Monitor prices for your favorite items</p>
        </header>
        <div class="controls">
            <div class="input-group">
                <input type="text" id="item-input" placeholder="Enter Item ID, Name, or Partial Name">
                <button id="add-item-btn">Add Item</button>
            </div>
            <p class="search-hint">Examples: "Ectoplasm", "19721", "Gossamer", "Gold to Gems", "Gems to Gold"</p>
            <div id="search-results" class="search-results"></div>
        </div>
        <div id="error-container"></div>
        <div id="items-container" class="items-container">
            <div class="loading">Loading items...</div>
        </div>
        <div class="manual-refresh">
            <button id="refresh-items-btn">Refresh item IDs from server</button>
        </div>
    </div>
    <script>
        const itemInput = document.getElementById('item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items-container');
        const errorContainer = document.getElementById('error-container');
        const searchResultsContainer = document.getElementById('search-results');
        const refreshItemsBtn = document.getElementById('refresh-items-btn');
        const GOLD_TO_GEMS_ID = 9990001;
        const GEMS_TO_GOLD_ID = 9990002;
        const GRAPH_URL_TEMPLATE = 'https://en.gw2treasures.com/item/{id}';
        
        const SPECIAL_ITEMS = {
            [GOLD_TO_GEMS_ID]: {
                id: GOLD_TO_GEMS_ID,
                name: 'Gold to Gems',
                icon: 'https://wiki.guildwars2.com/images/8/88/Gem_%28highres%29.png',
                type: 'gold-to-gems'
            },
            [GEMS_TO_GOLD_ID]: {
                id: GEMS_TO_GOLD_ID,
                name: 'Gems to Gold',
                icon: 'https://wiki.guildwars2.com/images/d/d1/Gold_coin.png',
                type: 'gems-to-gold'
            }
        };

        // ‚úÖ‚úÖ‚úÖ CONTAINER ITEMS DEFINITION ‚úÖ‚úÖ‚úÖ
        const CONTAINER_ITEMS = {
            39121: { // Light Crafting Bag
                items: [
                    { id: 24344, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24348, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24274, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24354, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24286, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24280, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24298, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24292, avgQuantity: 3, dropProb: 0.625 }
                ]
            },
            39122: { // Medium Crafting Bag
                items: [
                    { id: 24275, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24345, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24281, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24349, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24363, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24287, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24355, avgQuantity: 3, dropProb: 0.625 },
                    { id: 24293, avgQuantity: 3, dropProb: 0.625 }
                ]
            },          
            39124: {  // Heavy Crafting Bag
                items: [
                    { id: 24295, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24357, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24277, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24289, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24358, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24300, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24351, avgQuantity: 1, dropProb: 0.375 }, 
                    { id: 24283, avgQuantity: 1, dropProb: 0.375 }  
                ]
            }
        };

        function isContainer(id) { return CONTAINER_ITEMS.hasOwnProperty(id); }

        let trackedItems = [19721];
        let staticItemData = null;
        const DEBOUNCE_DELAY = 300;
        let debounceTimer = null;
        let draggedCard = null;

        // --- IndexedDB Helpers ---
        function getDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('GW2Cache', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                };
            });
        }
        async function getCachedData(key) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readonly');
                const store = tx.objectStore('files');
                const req = store.get(key);
                return new Promise(resolve => {
                    req.onsuccess = () => resolve(req.result || null);
                    req.onerror = () => resolve(null);
                });
            } catch (e) { return null; }
        }
        async function setCachedData(key, data) {
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readwrite');
                const store = tx.objectStore('files');
                store.put(data, key);
                await tx.complete;
            } catch (e) { console.warn('DB Write Error', e); }
        }

        // --- Logic ---
        function loadTrackedItems() {
            const saved = localStorage.getItem('gw2_tracked_items');
            if (saved) {
                try { trackedItems = JSON.parse(saved).map(id => Number(id)).filter(n => !isNaN(n)); } 
                catch { trackedItems = []; }
            }
        }
        function saveTrackedItems() {
            localStorage.setItem('gw2_tracked_items', JSON.stringify(trackedItems));
        }

        function formatCurrency(copper) {
            if (copper === null || copper === undefined || isNaN(copper)) return { gold: '-', silver: '-', copper: '-' };
            const gold = Math.floor(copper / 10000);
            const silver = Math.floor((copper % 10000) / 100);
            const copperRemainder = copper % 100;
            return { gold, silver, copper: copperRemainder };
        }
        function createCurrencyElement(copperValue) {
            const { gold, silver, copper } = formatCurrency(copperValue);
            const elem = document.createElement('div');
            elem.className = 'price-value';
            if (gold === '-' && silver === '-' && copper === '-') {
                elem.innerHTML = '<span style="color:#e74c3c;">N/A</span>';
                return elem;
            }
            elem.innerHTML = `
                ${gold > 0 ? `<span class="gold">${gold}</span>` : ''}
                ${silver > 0 || gold > 0 ? `<span class="silver">${silver}</span>` : ''}
                <span class="copper">${copper}</span>
            `;
            return elem;
        }

        async function fetchItemData(itemIds) {
            const resultsMap = new Map();
            const specialIds = itemIds.filter(id => [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(id));
            const containerIds = itemIds.filter(isContainer);
            const regularIds = itemIds.filter(id => !specialIds.includes(id) && !containerIds.includes(id));

            if (regularIds.length > 0) {
                try {
                    const [details, commerce] = await Promise.all([
                        fetch(`https://api.guildwars2.com/v2/items?ids=${regularIds.join(',')}`).then(r => r.json()),
                        fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${regularIds.join(',')}`).then(r => r.ok ? r.json() : [])
                    ]);
                    for (const item of details) {
                        const p = commerce.find(c => c.id === item.id);
                        resultsMap.set(item.id, {
                            id: item.id, name: item.name, icon: item.icon,
                            buyPrice: p ? p.buys.unit_price : null, sellPrice: p ? p.sells.unit_price : null
                        });
                    }
                } catch (e) { console.error('Regular item fetch error', e); }
            }

            for (const sid of specialIds) {
                const def = SPECIAL_ITEMS[sid];
                try {
                    if (sid === GEMS_TO_GOLD_ID) {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/gems?quantity=400').then(r => r.json());
                        resultsMap.set(sid, { ...def, returnFor400Gems: d.quantity });
                    } else {
                        const d = await fetch('https://api.guildwars2.com/v2/commerce/exchange/coins?quantity=10000000').then(r => r.json());
                        const gemsPerGold = d.quantity / 1000;
                        resultsMap.set(sid, { ...def, costFor400Gems: Math.round((400 / gemsPerGold) * 10000) });
                    }
                } catch (e) { resultsMap.set(sid, { ...def, costFor400Gems: null, returnFor400Gems: null }); }
            }

            // Containers
            const childSet = new Set();
            containerIds.forEach(cid => CONTAINER_ITEMS[cid].items.forEach(i => childSet.add(i.id)));
            const childMap = new Map();
            if (childSet.size > 0) {
                try {
                    const prices = await fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    prices.forEach(p => childMap.set(p.id, p.sells?.unit_price));
                } catch (e) {}
            }

            const childNameMap = new Map();
            if (childSet.size > 0) {
                try {
                    const names = await fetch(`https://api.guildwars2.com/v2/items?ids=${Array.from(childSet).join(',')}`).then(r => r.ok ? r.json() : []);
                    names.forEach(n => childNameMap.set(n.id, n.name));
                } catch (e) {}
            }

            for (const cid of containerIds) {
                let meta = { name: 'Container', icon: '' };
                try { meta = await fetch(`https://api.guildwars2.com/v2/items/${cid}`).then(r => r.json()); } catch {}
                
                let total = 0;
                const breakdown = [];
                CONTAINER_ITEMS[cid].items.forEach(d => {
                    const p = childMap.get(d.id);
                    const name = childNameMap.get(d.id) || `Item ${d.id}`;
                    if (p) {
                        const val = p * d.avgQuantity * d.dropProb;
                        total += val;
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: Math.round(val) });
                    } else {
                        breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: null });
                    }
                });

                resultsMap.set(cid, {
                    id: cid, name: meta.name, icon: meta.icon,
                    buyPrice: null, 
                    sellPrice: Math.round(total), isContainer: true, containerContents: breakdown
                });
            }

            return itemIds.map(id => resultsMap.get(id)).filter(Boolean);
        }

        async function fetchAndDisplayItems() {
            itemsContainer.innerHTML = '<div class="loading">Loading items...</div>';
            try {
                const items = await fetchItemData(trackedItems);
                itemsContainer.innerHTML = '';
                if (!items.length) { itemsContainer.innerHTML = '<div class="loading">No items tracked.</div>'; return; }
                
                // Safer iteration with Try/Catch per card
                items.forEach(i => {
                    try {
                        itemsContainer.appendChild(createItemCard(i));
                    } catch (cardError) {
                        console.error("Error creating card for", i.id, cardError);
                    }
                });
            } catch (e) {
                console.error(e);
                itemsContainer.innerHTML = '<div class="error">Error loading items.</div>';
            }
        }

        function createItemCard(itemData) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = itemData.id;
            card.draggable = true;
            
            const isSpecial = [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(itemData.id);
            const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);

            if (isSpecial) {
                let label = itemData.id === GOLD_TO_GEMS_ID ? 'Cost for 400 Gems:' : 'Return for 400 Gems:';
                let val = itemData.id === GOLD_TO_GEMS_ID ? itemData.costFor400Gems : itemData.returnFor400Gems;
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name">${itemData.name}</div>
                            <div class="item-id">Special</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">${label}</div>${createCurrencyElement(val).outerHTML}</div>
                    </div>`;
            } else if (itemData.isContainer) {
                const content = itemData.containerContents.map(c => {
                    const probText = `${c.avgQty}x (${(c.prob*100).toFixed(0)}%)`;
                    if (c.expectedCopper === null) return `<div class="tooltip-line"><span>${c.name}</span><span>N/A</span></div>`;
                    const { gold, silver, copper } = formatCurrency(c.expectedCopper);
                    const pHtml = `${gold>0?gold+'g ':''}${silver>0?silver+'s ':''}${copper}c`;
                    return `<div class="tooltip-line"><span class="child-name">${c.name} (${probText})</span><span style="color:#f1c40f">${pHtml}</span></div>`;
                }).join('');
                
                const infoEmoji = `
                    <span class="info-icon-wrapper">
                        ‚ÑπÔ∏è
                        <div class="container-tooltip">
                            <div class="tooltip-title">Expected Value Breakdown</div>
                            ${content}
                        </div>
                    </span>
                `;

                // ‚úÖ‚úÖ‚úÖ "Not Tradable" Logic Restored ‚úÖ‚úÖ‚úÖ
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name">
                                <a href="${graphUrl}" target="_blank" class="graph-link">üìà</a>
                                ${itemData.name}
                                ${infoEmoji}
                            </div>
                            <div class="item-id">ID: ${itemData.id} ‚Ä¢ Container</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Expected Value:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Buy Price:</div><span style="color:#e74c3c;">Not Tradable</span></div>
                    </div>`;
            } else {
                card.innerHTML = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info">
                            <div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">üìà</a> ${itemData.name}</div>
                            <div class="item-id">ID: ${itemData.id}</div>
                        </div>
                        <button class="remove-btn-small" data-item-id="${itemData.id}">√ó</button>
                    </div>
                    <div class="item-prices">
                        <div class="price-row"><div class="price-label">Buy Price:</div>${createCurrencyElement(itemData.buyPrice).outerHTML}</div>
                        <div class="price-row"><div class="price-label">Sell Price:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div>
                    </div>`;
            }

            const btn = card.querySelector('.remove-btn-small');
            if(btn) btn.addEventListener('click', e => { e.stopPropagation(); removeItem(Number(e.target.dataset.itemId)); });
            
            card.addEventListener('dragstart', handleDragStart);
            card.addEventListener('dragover', handleDragOver);
            card.addEventListener('drop', handleDrop);
            card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        // --- Standard Utils ---
        function removeItem(id) { trackedItems = trackedItems.filter(x => x !== id); saveTrackedItems(); fetchAndDisplayItems(); }
        function showError(m) { errorContainer.innerHTML = `<div class="error">${m}</div>`; setTimeout(() => errorContainer.innerHTML='', 4000); }
        function handleDragStart(e) { draggedCard = this; this.style.opacity = '0.5'; }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnd() { this.style.opacity = '1'; draggedCard = null; }
        function handleDrop(e) {
            e.preventDefault();
            if (draggedCard && draggedCard !== this) {
                const from = Number(draggedCard.dataset.itemId);
                const to = Number(this.dataset.itemId);
                const i1 = trackedItems.indexOf(from), i2 = trackedItems.indexOf(to);
                if (i1 > -1 && i2 > -1) {
                    trackedItems.splice(i1, 1);
                    trackedItems.splice(i2, 0, from);
                    saveTrackedItems();
                    fetchAndDisplayItems();
                }
            }
        }

        async function handleManualRefresh() {
            refreshItemsBtn.disabled = true;
            localStorage.removeItem('datawars_items_timestamp');
            await loadStaticItemData(true);
            refreshItemsBtn.disabled = false;
            showError('Database refreshed.');
        }
        
        const CACHE_KEY = 'datawars_items';
        async function loadStaticItemData(force = false) {
            if (staticItemData && !force) return staticItemData;
            const cache = await getCachedData(CACHE_KEY);
            if (cache && !force) { staticItemData = cache; return cache; }
            try {
                const res = await fetch('datawars_items.json?' + Date.now());
                if(res.ok) {
                    const d = await res.json();
                    await setCachedData(CACHE_KEY, d);
                    staticItemData = d;
                    return d;
                }
            } catch (e) {}
            return [];
        }
        async function searchItemsByName(q) {
            await loadStaticItemData();
            return (staticItemData||[]).filter(i => i.name && i.name.toLowerCase().includes(q.toLowerCase())).slice(0, 15);
        }
        function showSearchResults(res) {
            searchResultsContainer.innerHTML = '';
            res.forEach(i => {
                const d = document.createElement('div');
                d.className = 'search-result-item';
                d.innerHTML = `<div>${i.name}</div><div style="font-size:0.8em;color:#aaa">ID: ${i.id}</div>`;
                d.onclick = () => { 
                    if(!trackedItems.includes(i.id)) { trackedItems.push(i.id); saveTrackedItems(); fetchAndDisplayItems(); }
                    searchResultsContainer.style.display = 'none'; itemInput.value = ''; 
                };
                searchResultsContainer.appendChild(d);
            });
            searchResultsContainer.style.display = 'block';
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            addItemBtn.onclick = async () => {
                const v = itemInput.value.trim();
                if(!v) return;
                const id = parseInt(v);
                if(!isNaN(id)) {
                    if(!trackedItems.includes(id)) { trackedItems.push(id); saveTrackedItems(); fetchAndDisplayItems(); }
                } else {
                    const res = await searchItemsByName(v);
                    showSearchResults(res);
                }
                itemInput.value = '';
            };
            
            refreshItemsBtn.onclick = handleManualRefresh;
            document.onclick = (e) => { if(!e.target.closest('.controls')) searchResultsContainer.style.display='none'; };
            itemInput.oninput = (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const v = e.target.value.trim();
                    if(v.length > 2 && isNaN(parseInt(v))) showSearchResults(await searchItemsByName(v));
                }, 300);
            };

            loadTrackedItems();
            fetchAndDisplayItems();
        });
    </script>
    <p></p>
    <a href="https://gartkb.github.io/Garts-Great-Tools/" style="color: yellow; text-decoration: underline;">Gart's Great Tools</a>
</body>
</html>
