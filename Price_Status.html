<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="./images/icons/gw2_price_status.png">
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Guild Wars 2 Trading Post Tracker</title>
    <style>
        /* --- KEEPING ALL CSS AS IS --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1200px; margin:0 auto; }
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }
        
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:20px; display:flex; flex-direction:column; align-items:center; gap:10px; position:relative; }
        
        .input-wrapper { display:flex; gap:10px; flex-wrap:wrap; justify-content:center; width:100%; max-width:800px; align-items: flex-start; }
        .input-col { display: flex; flex-direction: column; flex: 1; min-width: 200px; position: relative; }

        input[type="text"] { padding:12px 15px; border:none; border-radius:5px; background:rgba(255,255,255,0.1); color:white; width:100%; font-size:1rem; border:1px solid #3498db; }
        input::placeholder { color:#95a5a6; }
        
        button { padding:12px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; height: 46px; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; }
        
        .api-link { font-size: 0.7rem; color: #7f8c8d; text-decoration: none; cursor: pointer; margin-top: 4px; margin-left: 2px; text-align: left; align-self: flex-start; transition: color 0.3s; }
        .api-link:hover { color: #bdc3c7; text-decoration: underline; }

        .tabs-container { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; border-bottom: 1px solid rgba(52, 152, 219, 0.3); align-items: flex-end; }
        .tab-btn { background: rgba(0,0,0,0.2); border: 1px solid transparent; border-bottom: none; padding: 8px 15px; border-radius: 8px 8px 0 0; color: #95a5a6; cursor: pointer; font-size: 1rem; transition: all 0.2s; white-space: nowrap; position: relative; height: 42px; display: flex; align-items: center; gap: 8px; min-width: 80px; justify-content: center; }
        .tab-btn:hover { background: rgba(52, 152, 219, 0.1); color: white; }
        .tab-btn.active { background: rgba(52, 152, 219, 0.2); color: #3498db; border-color: rgba(52, 152, 219, 0.5); font-weight: bold; }
        .tab-btn.drag-over { background: rgba(46, 204, 113, 0.3); color: #2ecc71; border-color: #2ecc71; transform: translateY(-2px); }
        .tab-text-wrapper { pointer-events: none; }
        .tab-name-span { pointer-events: auto; }
        .tab-edit-input { background: #2c3e50; border: 1px solid #3498db; color: white; font-size: 0.9rem; padding: 2px 5px; width: 100px; height: 26px; border-radius: 3px; }
        .tab-close-btn { width: 18px; height: 18px; border-radius: 50%; background: rgba(231, 76, 60, 0.8); color: white; font-size: 12px; line-height: 18px; text-align: center; display: none; align-items: center; justify-content: center; transition: background 0.2s; }
        .tab-btn:hover .tab-close-btn { display: flex; }
        .tab-close-btn:hover { background: #e74c3c; transform: scale(1.1); }
        .add-tab-btn { padding: 0 15px; font-size: 1.5rem; background: rgba(0,0,0,0.2); color: #2ecc71; justify-content: center; }
        .add-tab-btn:hover { background: rgba(46, 204, 113, 0.2); }

        #delivery-btn, #notification-btn, #orders-btn { background: #7f8c8d; opacity: 0.8; transition: all 0.5s ease; display: flex; align-items: center; gap: 8px; }
        #orders-btn { background: #2980b9; opacity: 1; }
        #delivery-btn.has-content, #notification-btn.has-content { opacity: 1; box-shadow: 0 0 15px rgba(241, 196, 15, 0.6); animation: pulse-glow 2s infinite; }
        #delivery-btn.has-content { background: linear-gradient(135deg, #f1c40f, #e67e22); color: #2c3e50; }
        #notification-btn.has-content { background: linear-gradient(135deg, #e74c3c, #c0392b); color: white; box-shadow: 0 0 15px rgba(231, 76, 60, 0.6); }

        @keyframes pulse-glow { 0% { transform: scale(1); } 50% { transform: scale(1.02); } 100% { transform: scale(1); } }

        .search-results { position:absolute; top:100%; left:0; width: 100%; background:rgba(0,0,0,0.95); border:1px solid #3498db; border-radius:5px; max-height:300px; overflow-y:auto; z-index:100; margin-top:5px; display:none; }
        .search-result-item { padding:10px 15px; display:flex; align-items:center; cursor:pointer; border-bottom:1px solid rgba(255,255,255,0.1); }
        .search-result-item:last-child { border-bottom:none; }
        .search-result-item:hover { background: rgba(52,152,219,0.25); }
        
        .items-container { display:grid; grid-template-columns:repeat(auto-fill,minmax(300px,1fr)); gap:20px; margin-top:20px; }
        .item-card { background:rgba(0,0,0,0.4); border-radius:10px; overflow: visible; transition:transform .3s, opacity 0.3s; display:flex; flex-direction:column; height:100%; position:relative; cursor:grab; }
        .item-card:hover { transform:translateY(-5px); box-shadow:0 5px 15px rgba(0,0,0,0.3); }
        .item-card:active { cursor:grabbing; transform:translateY(-2px); }
        .item-header { position:relative; padding:15px; background:rgba(52,152,219,0.2); display:flex; align-items:center; border-radius: 10px 10px 0 0; }
        .item-image { width:60px; height:60px; background:#1c1c1c; border-radius:5px; margin-right:15px; display:flex; align-items:center; justify-content:center; flex-shrink:0; }
        .item-image img { max-width:100%; max-height:100%; object-fit:contain; }
        .item-info { flex: 1; overflow: hidden; min-width: 0; margin-right: 45px; } 
        .item-name { font-size: 1.2rem; font-weight: bold; margin-bottom: 5px; white-space: nowrap; display: block; overflow: hidden; text-overflow: ellipsis; }
        .item-name a, .item-name span { vertical-align: middle; display: inline-block; }
        .item-id { color:#95a5a6; font-size:.9rem; display:flex; align-items:center; gap: 10px; min-height: 24px; }
        .order-icon { cursor: pointer; font-size: 1.2rem; transition: transform 0.2s; display: inline-flex; align-items: center; justify-content: center; border-radius: 4px; padding: 0 2px; }
        .order-icon:hover { transform: scale(1.2); background: rgba(255,255,255,0.1); }
        .icon-buy { filter: drop-shadow(0 0 2px rgba(46, 204, 113, 0.5)); border-bottom: 2px solid #2ecc71; }
        .icon-sell { filter: drop-shadow(0 0 2px rgba(231, 76, 60, 0.5)); border-bottom: 2px solid #e74c3c; }
        .icon-inv { filter: drop-shadow(0 0 2px rgba(241, 196, 15, 0.5)); border-bottom: 2px solid #f1c40f; }
        .icon-warn { border-bottom-style: dashed !important; opacity: 0.8; }
        .item-prices { padding:20px; flex:1; }
        .price-row { display:flex; justify-content:space-between; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.1); }
        .price-row:last-child { margin-bottom:0; padding-bottom:0; border-bottom:none; }
        .price-label { font-weight:bold; }
        .price-value { display:flex; gap:8px; }
        .gold,.silver,.copper{ display:inline-flex; align-items:center; justify-content:center; padding:3px 8px; border-radius:4px; font-weight:bold; min-width:40px; text-align:center; }
        .gold { background:linear-gradient(to bottom,#ffd700,#daa520); color:#000; }
        .silver { background:linear-gradient(to bottom,#c0c0c0,#a9a9c0); color:#000; }
        .copper { background:linear-gradient(to bottom,#b87333,#8b4513); color:#fff; }
        .card-actions { position:absolute; top:8px; right:8px; display:flex; gap: 5px; z-index: 2;}
        .card-btn { width:24px; height:24px; border-radius:50%; color:white; border:none; font-weight:bold; font-size:14px; cursor:pointer; display:flex; align-items:center; justify-content:center; padding:0; opacity:.7; transition:all .2s; }
        .card-btn:hover { opacity:1; transform: scale(1.1); }
        .remove-btn { background:rgba(231,76,60,0.7); }
        .remove-btn:hover { background:rgba(231,76,60,1); }

        .loading { text-align:center; padding:40px; font-size:1.2rem; color:#bdc3c7; grid-column: 1 / -1; display: flex; align-items: center; justify-content: center; gap: 15px; }
        .loading::after { content: ""; width: 24px; height: 24px; border: 3px solid #3498db; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
        @keyframes spin { to { transform: rotate(360deg); } }

        .error { background:rgba(231,76,60,0.2); padding:15px; border-radius:5px; margin:20px 0; text-align:center; grid-column: 1 / -1; }
        .search-hint { text-align:center; color:#95a5a6; margin-top:5px; font-size:.9rem; }
        .manual-refresh { text-align:center; margin-top:30px; }
        .manual-refresh button { background: rgba(46, 204, 113, 0.2); border: 1px solid #2ecc71; color: #2ecc71; padding: 8px 16px; font-size: 0.9rem; }
        .manual-refresh button:hover { background: rgba(46, 204, 113, 0.3); }
        .graph-link { color: #3498db; text-decoration: none; margin-left: 6px; font-size: 1.1rem; vertical-align: middle; opacity: 0.9; transition: opacity 0.2s, color 0.2s; }
        .graph-link:hover { opacity: 1; color: #2980b9; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: #2c3e50; border: 1px solid #3498db; border-radius: 8px; width: 95%; max-width: 900px; padding: 20px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { font-size: 1.5rem; color: #3498db; margin-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .modal-close { background: none; border: none; color: #ecf0f1; font-size: 2rem; cursor: pointer; padding: 0; line-height: 1; }
        .modal-close:hover { color: #e74c3c; transform: none; background: none; }
        .modal-body { overflow-y: auto; flex: 1; }
        
        .api-input-row { display: flex; gap: 10px; margin-bottom: 15px; }
        .api-list { display: flex; flex-direction: column; gap: 10px; }
        .api-item { background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; display: flex; justify-content: space-between; align-items: center; }
        .api-name { font-weight: bold; color: #3498db; }
        .api-key-mask { color: #95a5a6; font-family: monospace; font-size: 0.8rem; margin-left: 10px; }
        .delete-key-btn { background: #e74c3c; padding: 5px 10px; font-size: 0.8rem; }
        .global-toggle { margin-bottom: 20px; padding: 15px; background: rgba(46, 204, 113, 0.1); border-radius: 5px; display:flex; align-items: center; border: 1px solid rgba(46, 204, 113, 0.3); }
        .global-toggle label { cursor: pointer; font-weight: bold; color: #2ecc71; margin-left: 10px; font-size: 1.05rem; }
        .guild-list { margin-top: 10px; display: flex; flex-direction: column; gap: 5px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 15px; }
        .guild-item { display: flex; align-items: center; background: rgba(0,0,0,0.2); padding: 8px 12px; border-radius: 4px; }
        .guild-item label { flex: 1; margin-left: 10px; cursor: pointer; color: #ecf0f1; display: flex; justify-content: space-between; }
        .guild-tag { color: #f39c12; font-weight: bold; margin-left: 5px; }
        .section-title { color: #3498db; font-weight: bold; margin-bottom: 10px; font-size: 1.1rem; margin-top: 20px; }

        .data-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9rem; }
        .data-table th { text-align: left; color: #95a5a6; padding: 8px; border-bottom: 1px solid #3498db; }
        .data-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); vertical-align: middle; }
        .col-account { font-weight: bold; color: #2ecc71; }
        .col-guild { font-weight: bold; color: #e67e22; } 
        .col-qty { color: #f1c40f; font-weight: bold; }
        .col-date { font-size: 0.8rem; color: #bdc3c7; }
        .inv-owner-header { background: rgba(52, 152, 219, 0.1); color: #3498db; font-weight: bold; padding: 8px; }
        .delivery-icon { width: 24px; height: 24px; vertical-align: middle; margin-right: 8px; border-radius: 3px; }
        .delivery-item-name { vertical-align: middle; }

        .order-toggles { display: flex; gap: 10px; margin-bottom: 15px; }
        .order-toggle-btn { flex: 1; opacity: 0.5; border: 1px solid transparent; }
        .order-toggle-btn.active-buys { opacity: 1; background: rgba(46, 204, 113, 0.2); border-color: #2ecc71; color: #2ecc71; }
        .order-toggle-btn.active-sells { opacity: 1; background: rgba(231, 76, 60, 0.2); border-color: #e74c3c; color: #e74c3c; }

        /* --- STYLES FOR ORDER FILTERS & SORTING --- */
        .order-controls-bar { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 10px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 5px; align-items: center; }
        .order-search-input { padding: 8px 12px; border: 1px solid #3498db; border-radius: 4px; background: rgba(255,255,255,0.1); color: white; min-width: 200px; flex: 1; }
        .order-account-filters { display: flex; gap: 10px; flex-wrap: wrap; }
        .order-acc-chk { display: flex; align-items: center; gap: 5px; background: rgba(52, 152, 219, 0.1); padding: 4px 8px; border-radius: 4px; border: 1px solid transparent; cursor: pointer; user-select: none; font-size: 0.85rem; }
        .order-acc-chk:hover { background: rgba(52, 152, 219, 0.2); }
        .order-acc-chk.unchecked { opacity: 0.5; border-color: #7f8c8d; background: transparent; }
        .order-acc-chk input { display: none; }
        
        /* Sortable Headers */
        .sortable-th { cursor: pointer; user-select: none; transition: color 0.2s; position: relative; padding-right: 15px !important; }
        .sortable-th:hover { color: #ecf0f1; }
        .sortable-th::after { content: 'â†•'; position: absolute; right: 2px; font-size: 0.7em; opacity: 0.3; }
        .sortable-th.sorted-asc::after { content: 'â–²'; opacity: 1; color: #3498db; }
        .sortable-th.sorted-desc::after { content: 'â–¼'; opacity: 1; color: #3498db; }

        .notification-list { display: flex; flex-direction: column; gap: 10px; }
        .notif-item { background: rgba(0,0,0,0.2); border-left: 4px solid #95a5a6; padding: 15px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .notif-item.type-buys { border-color: #2ecc71; background: rgba(46, 204, 113, 0.1); }
        .notif-item.type-sells { border-color: #e67e22; background: rgba(230, 126, 34, 0.1); }
        .notif-text-col { flex: 1; margin-right: 15px; }
        .notif-title { font-weight: bold; font-size: 1.05rem; display: block; margin-bottom: 4px; }
        .notif-msg { color: #bdc3c7; font-size: 0.95rem; }
        .notif-time { font-size: 0.75rem; color: #7f8c8d; margin-top: 5px; }
        .notif-close { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); width: 30px; height: 30px; border-radius: 50%; color: #ecf0f1; font-size: 1.2rem; cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .notif-close:hover { background: #c0392b; border-color: #e74c3c; transform: scale(1.1); }
        .watch-btn { background: none; border: none; cursor: pointer; font-size: 1.2rem; opacity: 0.2; transition: all 0.2s; padding: 0 5px; filter: grayscale(100%); }
        .watch-btn:hover { opacity: 0.6; transform: scale(1.2); }
        .watch-btn.watching { opacity: 1; filter: none; text-shadow: 0 0 10px rgba(255, 215, 0, 0.6); }

        @media (max-width:768px) { 
            .items-container{grid-template-columns:1fr;} 
            h1{font-size:2rem;} 
            .controls{position:relative;} 
            .search-results{width:100%; left:0; }
            .data-table { font-size: 0.8rem; }
            .input-wrapper { flex-direction: column; align-items: stretch; }
            .input-col { width: 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Wars 2 Trading Post Tracker</h1>
            <p class="subtitle">Monitor prices for your favorite items</p>
        </header>
        <div class="controls">
            <div class="input-wrapper">
                <div class="input-col">
                    <input type="text" id="item-input" placeholder="Enter Item ID, Name, or Partial Name">
                    <div style="display:flex; gap:15px; width:100%;">
                        <a id="api-settings-link" class="api-link">Manage API Keys</a>
                        <a id="export-btn" class="api-link">Export Config</a>
                        <a id="import-btn" class="api-link">Import Config</a>
                    </div>
                    <div id="search-results" class="search-results"></div>
                </div>
                <button id="add-item-btn">Add Item</button>
                <div style="display:flex; gap:10px;">
                    <button id="orders-btn" title="View Pending Orders">
                        <span>ðŸ“œ</span> Orders
                    </button>
                    <button id="delivery-btn" title="Check Delivery Box">
                        <span>ðŸ“¦</span> Delivery
                    </button>
                    <button id="notification-btn" title="View Notifications">
                        <span>ðŸ””</span> Alerts <span id="notif-badge"></span>
                    </button>
                </div>
            </div>
            <p class="search-hint">Examples: "Ectoplasm", "19721", "Gossamer", "Heavy Crafting Bag", "Gold to Gems"</p>
        </div>
        
        <div id="tabs-container" class="tabs-container">
            <!-- Tabs Generated JS -->
        </div>

        <div id="error-container"></div>
        <div id="items-container" class="items-container">
            <div class="loading">Loading items...</div>
        </div>
        <div class="manual-refresh">
            <button id="refresh-items-btn">Refresh item IDs from server</button>
        </div>
    </div>

    <!-- API Key Modal -->
    <div id="api-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Manage API Keys</span>
                <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="global-toggle">
                    <input type="checkbox" id="enable-inventory-chk" checked>
                    <label for="enable-inventory-chk">Scan Inventories & Characters</label>
                </div>

                <div class="section-title" style="margin-top:0;">API Keys</div>
                <div class="api-input-row">
                    <input type="text" id="new-api-key" placeholder="Paste API Key" style="flex:2">
                    <input type="text" id="new-api-name" placeholder="Nickname" style="flex:1">
                    <button onclick="addApiKey()">Add</button>
                </div>
                <div id="api-key-list" class="api-list"></div>
                <p style="margin-top:10px; font-size:0.8rem; color:#95a5a6;">
                    Required scopes: <em>tradingpost, inventories, characters, guilds</em>.
                </p>

                <div class="section-title">Monitored Guilds</div>
                <div style="font-size:0.85rem; color:#bdc3c7; margin-bottom: 5px;">Only accessible guilds (Leader permission) appear here. Uncheck to disable polling.</div>
                <div id="guild-list-container" class="guild-list">
                    <div style="color:#95a5a6; font-style:italic;">Accessible guilds will appear here after data is loaded.</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Global Orders Modal (UPDATED) -->
    <div id="global-orders-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>My Pending Orders</span>
                <button class="modal-close" onclick="closeModal('global-orders-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div class="order-toggles">
                    <button id="toggle-buys" class="order-toggle-btn active-buys" onclick="switchOrderType('buys')">Buy Orders</button>
                    <button id="toggle-sells" class="order-toggle-btn" onclick="switchOrderType('sells')">Sell Listings</button>
                </div>
                <!-- Filter Controls -->
                <div class="order-controls-bar">
                    <input type="text" id="order-search-input" class="order-search-input" placeholder="Filter items by name..." oninput="handleOrderSearch(this.value)">
                    <div id="order-account-filters" class="order-account-filters">
                        <!-- Checkboxes generated via JS -->
                    </div>
                </div>
                <div id="global-orders-content"></div>
            </div>
        </div>
    </div>

    <!-- Order Viewer Modal (Specific Item) -->
    <div id="order-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="order-modal-title">Orders</span>
                <button class="modal-close" onclick="closeModal('order-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="order-content"></div>
            </div>
        </div>
    </div>

    <!-- Notification List Modal -->
    <div id="notification-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Notifications</span>
                <button class="modal-close" onclick="closeModal('notification-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="margin-bottom: 15px; display: flex; justify-content: flex-end;">
                    <button onclick="clearAllNotifications()" style="font-size: 0.8rem; padding: 5px 10px; height: auto; background: #c0392b;">Clear All</button>
                </div>
                <div id="notification-content" class="notification-list"></div>
            </div>
        </div>
    </div>

    <!-- Inventory Viewer Modal -->
    <div id="inventory-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="inventory-modal-title">Inventory Locations</span>
                <button class="modal-close" onclick="closeModal('inventory-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="inventory-content"></div>
            </div>
        </div>
    </div>

    <!-- Container Content Modal -->
    <div id="container-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span id="container-modal-title">Container Contents</span>
                <button class="modal-close" onclick="closeModal('container-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="container-content"></div>
            </div>
        </div>
    </div>

    <!-- Delivery Modal -->
    <div id="delivery-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Delivery Box Content</span>
                <button class="modal-close" onclick="closeModal('delivery-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div id="delivery-content"></div>
            </div>
        </div>
    </div>
    
    <!-- Hidden input for file import -->
    <input type="file" id="import-file-input" style="display:none" accept=".json">

    <script>
        const itemInput = document.getElementById('item-input');
        const addItemBtn = document.getElementById('add-item-btn');
        const itemsContainer = document.getElementById('items-container');
        const errorContainer = document.getElementById('error-container');
        const searchResultsContainer = document.getElementById('search-results');
        const refreshItemsBtn = document.getElementById('refresh-items-btn');
        const apiSettingsLink = document.getElementById('api-settings-link');
        const deliveryBtn = document.getElementById('delivery-btn');
        const notificationBtn = document.getElementById('notification-btn');
        const ordersBtn = document.getElementById('orders-btn');
        const tabsContainer = document.getElementById('tabs-container');
        
        const GOLD_TO_GEMS_ID = 9990001;
        const GEMS_TO_GOLD_ID = 9990002;
        const GRAPH_URL_TEMPLATE = 'https://en.gw2treasures.com/item/{id}';
        
        const SPECIAL_ITEMS = {
            [GOLD_TO_GEMS_ID]: { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems', icon: 'https://wiki.guildwars2.com/images/8/88/Gem_%28highres%29.png', type: 'gold-to-gems' },
            [GEMS_TO_GOLD_ID]: { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold', icon: 'https://wiki.guildwars2.com/images/d/d1/Gold_coin.png', type: 'gems-to-gold' }
        };

        const CONTAINER_ITEMS = {
            39121: { items: [{ id: 24344, avgQuantity: 3, dropProb: 0.625 }, { id: 24348, avgQuantity: 3, dropProb: 0.625 }, { id: 24274, avgQuantity: 3, dropProb: 0.625 }, { id: 24354, avgQuantity: 3, dropProb: 0.625 }, { id: 24286, avgQuantity: 3, dropProb: 0.625 }, { id: 24280, avgQuantity: 3, dropProb: 0.625 }, { id: 24298, avgQuantity: 3, dropProb: 0.625 }, { id: 24292, avgQuantity: 3, dropProb: 0.625 }] },
            39122: { items: [{ id: 24275, avgQuantity: 3, dropProb: 0.625 }, { id: 24345, avgQuantity: 3, dropProb: 0.625 }, { id: 24281, avgQuantity: 3, dropProb: 0.625 }, { id: 24349, avgQuantity: 3, dropProb: 0.625 }, { id: 24363, avgQuantity: 3, dropProb: 0.625 }, { id: 24287, avgQuantity: 3, dropProb: 0.625 }, { id: 24355, avgQuantity: 3, dropProb: 0.625 }, { id: 24293, avgQuantity: 3, dropProb: 0.625 }] },          
            39124: { items: [{ id: 24295, avgQuantity: 1, dropProb: 0.375 }, { id: 24357, avgQuantity: 1, dropProb: 0.375 }, { id: 24277, avgQuantity: 1, dropProb: 0.375 }, { id: 24289, avgQuantity: 1, dropProb: 0.375 }, { id: 24358, avgQuantity: 1, dropProb: 0.375 }, { id: 24300, avgQuantity: 1, dropProb: 0.375 }, { id: 24351, avgQuantity: 1, dropProb: 0.375 }, { id: 24283, avgQuantity: 1, dropProb: 0.375 }] }
        };
        
        const CUSTOM_SEARCHABLE_ITEMS = [
            { id: GOLD_TO_GEMS_ID, name: 'Gold to Gems' },
            { id: GEMS_TO_GOLD_ID, name: 'Gems to Gold' },
            { id: 39121, name: 'Light Crafting Bag' },
            { id: 39122, name: 'Medium Crafting Bag' },
            { id: 39124, name: 'Heavy Crafting Bag' }
        ];

        function isContainer(id) { return CONTAINER_ITEMS.hasOwnProperty(id); }

        // --- GLOBAL STATE ---
        let itemTabs = [{ id: 'default', name: 'Main', items: [19721] }];
        let activeTabIndex = 0;
        let fetchIdCounter = 0; 

        let staticItemData = null; 
        let apiKeys = []; 
        let accountOrdersMap = new Map();
        let allAccountOrders = { buys: [], sells: [] }; 
        let globalInventoryMap = new Map(); 
        let deliveryData = []; 
        let globalItemData = new Map(); 
        let watchedOrders = new Map(); 
        let activeNotifications = [];
        
        // Order Viewer State
        let currentOrderType = 'buys';
        let currentOrderSort = { col: 'date', dir: 'desc' };
        let selectedOrderAccounts = new Set();
        let orderSearchQuery = '';

        // Settings
        let enableInventory = true;
        let disabledGuilds = new Set();
        let knownGuilds = {}; 

        const DEBOUNCE_DELAY = 300;
        let debounceTimer = null;
        let draggedCard = null;

        // --- CONCURRENCY HELPER ---
        async function pMap(array, mapper, concurrency = 3) {
            const results = [];
            const iterator = array.entries();
            const workers = new Array(Math.min(concurrency, array.length)).fill(iterator).map(async (iter) => {
                for (const [index, item] of iter) {
                    try { results[index] = await mapper(item); } catch (e) { results[index] = null; }
                }
            });
            await Promise.all(workers);
            return results;
        }

        // --- NOTIFICATIONS & WATCH LOGIC ---
        function loadWatchedOrders() {
            try {
                const raw = localStorage.getItem('gw2_watched_orders');
                if (raw) watchedOrders = new Map(JSON.parse(raw));
            } catch (e) { watchedOrders = new Map(); }
        }

        function saveWatchedOrders() {
            localStorage.setItem('gw2_watched_orders', JSON.stringify([...watchedOrders]));
        }

        function loadActiveNotifications() {
            try {
                const stored = localStorage.getItem('gw2_active_notifications');
                if (stored) activeNotifications = JSON.parse(stored);
            } catch(e) { activeNotifications = []; }
            updateNotificationBtnState();
        }

        function saveActiveNotifications() {
            localStorage.setItem('gw2_active_notifications', JSON.stringify(activeNotifications));
        }

        function addNotification(type, title, message) {
            const notif = {
                id: Date.now() + '-' + Math.random(),
                type,
                title,
                message,
                timestamp: Date.now()
            };
            activeNotifications.unshift(notif); 
            saveActiveNotifications();
            updateNotificationBtnState();
        }

        function removeNotification(id) {
            activeNotifications = activeNotifications.filter(n => n.id !== id);
            saveActiveNotifications();
            renderNotificationModalList(); 
            updateNotificationBtnState();
        }

        function clearAllNotifications() {
            if(confirm('Clear all notifications?')) {
                activeNotifications = [];
                saveActiveNotifications();
                renderNotificationModalList();
                updateNotificationBtnState();
            }
        }

        function updateNotificationBtnState() {
            const count = activeNotifications.length;
            const badge = document.getElementById('notif-badge');
            badge.textContent = count > 0 ? `(${count})` : '';
            if (count > 0) notificationBtn.classList.add('has-content');
            else notificationBtn.classList.remove('has-content');
        }

        // --- TABS LOGIC ---
        function loadTabs() {
            const savedTabs = localStorage.getItem('gw2_item_tabs');
            if (savedTabs) {
                try {
                    itemTabs = JSON.parse(savedTabs);
                    if(!itemTabs.length) itemTabs = [{ id: 'default', name: 'Main', items: [] }];
                } catch { itemTabs = [{ id: 'default', name: 'Main', items: [] }]; }
            } else {
                const oldItems = localStorage.getItem('gw2_tracked_items');
                if(oldItems) {
                    try {
                        const items = JSON.parse(oldItems).map(Number).filter(n => !isNaN(n));
                        itemTabs[0].items = items;
                        saveTabs();
                    } catch {}
                }
            }
            renderTabs();
        }

        function saveTabs() {
            localStorage.setItem('gw2_item_tabs', JSON.stringify(itemTabs));
        }

        function renderTabs() {
            tabsContainer.innerHTML = '';
            itemTabs.forEach((tab, index) => {
                const btn = document.createElement('div');
                btn.className = `tab-btn ${index === activeTabIndex ? 'active' : ''}`;
                const nameSpan = document.createElement('span');
                nameSpan.className = 'tab-name-span';
                nameSpan.textContent = tab.name;
                nameSpan.title = "Double click to rename";
                const nameInput = document.createElement('input');
                nameInput.className = 'tab-edit-input';
                nameInput.value = tab.name;
                nameInput.style.display = 'none';
                
                nameSpan.ondblclick = (e) => {
                    e.stopPropagation();
                    nameSpan.style.display = 'none';
                    nameInput.style.display = 'block';
                    nameInput.focus();
                };
                
                const saveName = () => {
                    const newName = nameInput.value.trim();
                    if(newName) {
                        tab.name = newName;
                        saveTabs();
                        renderTabs();
                    } else {
                        nameInput.value = tab.name;
                        nameInput.style.display = 'none';
                        nameSpan.style.display = 'inline';
                    }
                };
                nameInput.onblur = saveName;
                nameInput.onkeydown = (e) => { if(e.key === 'Enter') saveName(); };

                let closeBtn = null;
                if(index !== 0) {
                    closeBtn = document.createElement('span');
                    closeBtn.className = 'tab-close-btn';
                    closeBtn.textContent = 'Ã—';
                    closeBtn.title = 'Delete Tab';
                    closeBtn.onclick = (e) => {
                        e.stopPropagation();
                        if(confirm(`Delete tab "${tab.name}"? Items will be moved to Main.`)) {
                            itemTabs[0].items.push(...tab.items);
                            itemTabs.splice(index, 1);
                            activeTabIndex = 0;
                            saveTabs();
                            renderTabs();
                            fetchActiveTabData();
                        }
                    };
                }

                btn.appendChild(nameSpan);
                btn.appendChild(nameInput);
                if(closeBtn) btn.appendChild(closeBtn);

                btn.onclick = (e) => {
                    if(e.target !== nameInput && index !== activeTabIndex) {
                        activeTabIndex = index;
                        renderTabs();
                        itemsContainer.innerHTML = '<div class="loading">Loading tab items...</div>';
                        fetchActiveTabData(); 
                    }
                };
                
                btn.addEventListener('dragover', (e) => { e.preventDefault(); if(index !== activeTabIndex) btn.classList.add('drag-over'); });
                btn.addEventListener('dragleave', () => btn.classList.remove('drag-over'));
                btn.addEventListener('drop', (e) => {
                    e.preventDefault();
                    btn.classList.remove('drag-over');
                    if (draggedCard && index !== activeTabIndex) {
                        moveItemToTab(Number(draggedCard.dataset.itemId), index);
                    }
                });

                tabsContainer.appendChild(btn);
            });

            const addBtn = document.createElement('button');
            addBtn.className = 'tab-btn add-tab-btn';
            addBtn.textContent = '+';
            addBtn.onclick = addNewTab;
            tabsContainer.appendChild(addBtn);
        }

        function addNewTab() {
            const name = prompt("Enter name for new tab:");
            if(name) {
                itemTabs.push({ id: 'tab-' + Date.now(), name: name.trim(), items: [] });
                activeTabIndex = itemTabs.length - 1;
                saveTabs();
                renderTabs();
                fetchActiveTabData();
            }
        }

        async function addToActiveTab(id) {
            if(!itemTabs[activeTabIndex].items.includes(id)) {
                itemTabs[activeTabIndex].items.push(id);
                saveTabs();
                await fetchActiveTabData(); 
            }
        }

        function removeFromActiveTab(id) {
            itemTabs[activeTabIndex].items = itemTabs[activeTabIndex].items.filter(x => x !== id);
            saveTabs();
            const card = itemsContainer.querySelector(`.item-card[data-item-id="${id}"]`);
            if(card) card.remove();
        }

        function moveItemToTab(itemId, targetTabIndex) {
            itemTabs[activeTabIndex].items = itemTabs[activeTabIndex].items.filter(x => x !== itemId);
            if(!itemTabs[targetTabIndex].items.includes(itemId)) {
                itemTabs[targetTabIndex].items.push(itemId);
            }
            saveTabs();
            const card = itemsContainer.querySelector(`.item-card[data-item-id="${itemId}"]`);
            if(card) card.remove();
        }

        // --- API & Settings ---
        function loadApiKeys() {
            const stored = localStorage.getItem('gw2_api_keys');
            if (stored) { try { apiKeys = JSON.parse(stored); } catch (e) { apiKeys = []; } }
            renderApiKeys();
        }
        function saveApiKeys() { localStorage.setItem('gw2_api_keys', JSON.stringify(apiKeys)); renderApiKeys(); }

        function loadSettings() {
            const invSetting = localStorage.getItem('gw2_enable_inventory');
            if(invSetting !== null) enableInventory = invSetting === 'true';
            document.getElementById('enable-inventory-chk').checked = enableInventory;
            const disabled = localStorage.getItem('gw2_disabled_guilds');
            if(disabled) { try { disabledGuilds = new Set(JSON.parse(disabled)); } catch {} }
            const known = localStorage.getItem('gw2_known_guilds');
            if(known) { try { knownGuilds = JSON.parse(known); } catch {} }
            renderGuildSettings();
        }
        function saveSettings() {
            localStorage.setItem('gw2_enable_inventory', enableInventory);
            localStorage.setItem('gw2_disabled_guilds', JSON.stringify([...disabledGuilds]));
            localStorage.setItem('gw2_known_guilds', JSON.stringify(knownGuilds));
        }

        function addApiKey() {
            const keyInput = document.getElementById('new-api-key');
            const nameInput = document.getElementById('new-api-name');
            const key = keyInput.value.trim();
            const name = nameInput.value.trim() || 'Account ' + (apiKeys.length + 1);
            if (!key) { alert('Please enter an API Key'); return; }
            apiKeys.push({ key, name });
            saveApiKeys();
            keyInput.value = ''; nameInput.value = '';
            refreshAllData();
        }
        function removeApiKey(index) {
            if(confirm('Remove this API key?')) { apiKeys.splice(index, 1); saveApiKeys(); refreshAllData(); }
        }
        function renderApiKeys() {
            const list = document.getElementById('api-key-list');
            list.innerHTML = '';
            if(apiKeys.length === 0) list.innerHTML = '<div style="color:#95a5a6; text-align:center;">No API keys configured.</div>';
            else apiKeys.forEach((k, i) => {
                const div = document.createElement('div');
                div.className = 'api-item';
                div.innerHTML = `<div><span class="api-name">${k.name}</span><span class="api-key-mask">${k.key.substring(0,8)}...</span></div><button class="delete-key-btn" onclick="removeApiKey(${i})">Delete</button>`;
                list.appendChild(div);
            });
        }
        function renderGuildSettings() {
            const container = document.getElementById('guild-list-container');
            container.innerHTML = '';
            const guildIds = Object.keys(knownGuilds);
            if(guildIds.length === 0) { container.innerHTML = '<div style="color:#95a5a6; font-style:italic; text-align:center;">Accessible guilds will appear here after data is loaded.</div>'; return; }
            guildIds.forEach(gid => {
                const g = knownGuilds[gid];
                const div = document.createElement('div');
                div.className = 'guild-item';
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = !disabledGuilds.has(gid);
                checkbox.onchange = () => { if(checkbox.checked) disabledGuilds.delete(gid); else disabledGuilds.add(gid); saveSettings(); };
                const label = document.createElement('label');
                label.innerHTML = `<span>${g.name} <span class="guild-tag">[${g.tag}]</span></span>`;
                label.onclick = () => checkbox.click();
                div.appendChild(checkbox); div.appendChild(label); container.appendChild(div);
            });
        }

        async function discoverGuilds() {
            if(apiKeys.length === 0) return;
            let newGuildsFound = false;
            const currentValidGuilds = new Set();
            await pMap(apiKeys, async (account) => {
                try {
                    const accRes = await fetch(`https://api.guildwars2.com/v2/account?access_token=${account.key}`);
                    if(!accRes.ok) return;
                    const accInfo = await accRes.json();
                    if(accInfo.guild_leader) {
                        for (const guildId of accInfo.guild_leader) {
                            currentValidGuilds.add(guildId);
                            if(!knownGuilds[guildId]) {
                                try {
                                    const gRes = await fetch(`https://api.guildwars2.com/v2/guild/${guildId}`);
                                    if(gRes.ok) {
                                        const gInfo = await gRes.json();
                                        knownGuilds[guildId] = { name: gInfo.name, tag: gInfo.tag };
                                        newGuildsFound = true;
                                    }
                                } catch(e) {}
                            }
                        }
                    }
                } catch(e) {}
            }, 3); 
            
            Object.keys(knownGuilds).forEach(gid => {
                if(!currentValidGuilds.has(gid)) { delete knownGuilds[gid]; disabledGuilds.delete(gid); newGuildsFound = true; }
            });
            if(newGuildsFound) { saveSettings(); renderGuildSettings(); }
        }

        // --- DATA LOGIC ---
        async function refreshAllData() {
            discoverGuilds();
            const promises = [fetchAccountData()];
            if(enableInventory) promises.push(fetchAccountInventories());
            else globalInventoryMap.clear();

            await Promise.all(promises); 
            await fetchActiveTabData();
        }

        async function fetchActiveTabData() {
            const currentId = ++fetchIdCounter; 
            const activeIds = itemTabs[activeTabIndex].items;

            if (activeIds.length === 0) {
                itemsContainer.innerHTML = '<div class="loading">No items in this tab. Drop items here or add new ones.</div>';
                return;
            }

            if(itemsContainer.innerHTML.trim() === '') {
                 itemsContainer.innerHTML = '<div class="loading">Loading tab items...</div>';
            }

            try {
                const itemResults = await fetchItemData(activeIds); 
                
                if(currentId !== fetchIdCounter) return;

                itemResults.forEach(item => globalItemData.set(item.id, item));
                updateDomForActiveTab(activeIds);
            } catch (e) {
                console.error(e);
                if(currentId === fetchIdCounter) {
                    itemsContainer.innerHTML = '<div class="error">Error loading items. Check API limits or try again later.</div>';
                }
            }
        }

        // --- DOM RECONCILIATION ---
        function updateDomForActiveTab(activeIds) {
            Array.from(itemsContainer.children).forEach(child => {
                if (!child.classList.contains('item-card')) child.remove();
            });
            
            const existingCards = new Map();
            itemsContainer.querySelectorAll('.item-card').forEach(el => existingCards.set(Number(el.dataset.itemId), el));

            const activeIdSet = new Set(activeIds);

            existingCards.forEach((el, id) => {
                if(!activeIdSet.has(id)) el.remove();
            });

            activeIds.forEach(id => {
                const data = globalItemData.get(id);
                if(!data) return;

                if(existingCards.has(id)) {
                    const card = existingCards.get(id);
                    const temp = document.createElement('div');
                    temp.appendChild(createItemCard(data)); 
                    if(card.innerHTML !== temp.firstElementChild.innerHTML) {
                        card.innerHTML = temp.firstElementChild.innerHTML;
                        const rmBtn = card.querySelector('.remove-btn');
                        if(rmBtn) rmBtn.addEventListener('click', e => { e.stopPropagation(); removeFromActiveTab(id); });
                    }
                    itemsContainer.appendChild(card);
                } else {
                    itemsContainer.appendChild(createItemCard(data));
                }
            });
        }

        async function fetchAccountData() {
            accountOrdersMap.clear();
            allAccountOrders = { buys: [], sells: [] }; // Reset global order list
            deliveryData = [];
            if(apiKeys.length === 0) return;

            const results = await pMap(apiKeys, async (account) => {
                try {
                    const [buys, sells, delivery] = await Promise.all([
                        fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/buys?access_token=${account.key}`).then(r => r.ok ? r.json() : []),
                        fetch(`https://api.guildwars2.com/v2/commerce/transactions/current/sells?access_token=${account.key}`).then(r => r.ok ? r.json() : []),
                        fetch(`https://api.guildwars2.com/v2/commerce/delivery?access_token=${account.key}`).then(r => r.ok ? r.json() : null)
                    ]);
                    return { account: account.name, buys, sells, delivery };
                } catch(e) { return null; }
            }, 5);

            const validResults = results.filter(r => r !== null);
            const currentActiveIds = new Set();
            const extraItemIds = new Set(); // Collect IDs for both delivery AND global orders to fetch names

            validResults.forEach(res => {
                const processOrders = (list, type) => {
                    list.forEach(o => {
                        currentActiveIds.add(o.id);
                        extraItemIds.add(o.item_id);
                        
                        // Populate Map for specific item cards
                        if(!accountOrdersMap.has(o.item_id)) accountOrdersMap.set(o.item_id, { buys: [], sells: [] });
                        accountOrdersMap.get(o.item_id)[type].push({ ...o, accountName: res.account });

                        // Populate Global List
                        allAccountOrders[type].push({ ...o, accountName: res.account });
                    });
                };
                processOrders(res.buys, 'buys');
                processOrders(res.sells, 'sells');

                if (res.delivery && (res.delivery.coins > 0 || res.delivery.items.length > 0)) {
                     res.delivery.items.forEach(i => {
                         extraItemIds.add(i.id);
                         if (enableInventory) {
                             if (!globalInventoryMap.has(i.id)) globalInventoryMap.set(i.id, []);
                             globalInventoryMap.get(i.id).push({ owner: res.account, source: 'Delivery Box', count: i.count, isGuild: false });
                         }
                     });
                     deliveryData.push({ accountName: res.account, coins: res.delivery.coins, items: res.delivery.items });
                }
            });

            // --- WATCHED ORDER DETECTION ---
            if (validResults.length > 0) {
                watchedOrders.forEach((details, orderId) => {
                    if (!currentActiveIds.has(orderId)) {
                        const typeLabel = details.type === 'buys' ? 'Buy Order Exhausted' : 'Sell Order Fulfilled';
                        const msg = `${details.quantity}x ${details.itemName} at ${formatCurrency(details.price).gold}g ${formatCurrency(details.price).silver}s`;
                        addNotification(details.type, typeLabel, msg);
                        watchedOrders.delete(orderId);
                        saveWatchedOrders();
                    }
                });
            }

            // Ensure we have item details (names/icons) for everything in delivery boxes AND pending orders
            if (extraItemIds.size > 0) {
                const nameMap = new Map();
                const cached = await getStaticItemDetails([...extraItemIds]);
                cached.forEach(c => nameMap.set(c.id, { name: c.name, icon: c.icon }));
                
                const missing = [...extraItemIds].filter(id => !nameMap.has(id));
                if(missing.length > 0) {
                    try {
                        const apiItems = await fetch(`https://api.guildwars2.com/v2/items?ids=${missing.join(',')}`).then(r=>r.ok?r.json():[]);
                        await saveStaticItemDetails(apiItems); 
                        apiItems.forEach(i => nameMap.set(i.id, { name: i.name, icon: i.icon }));
                    } catch(e){}
                }

                // Hydrate delivery data
                deliveryData.forEach(d => {
                    d.items = d.items.map(i => ({ ...i, ...(nameMap.get(i.id) || { name: `Item ${i.id}`, icon: '' }) }));
                });
            }

            if (deliveryData.length > 0) {
                deliveryBtn.classList.add('has-content');
            } else {
                deliveryBtn.classList.remove('has-content');
            }
        }

        async function fetchAccountInventories() {
            globalInventoryMap.clear();
            if(apiKeys.length === 0 || !enableInventory) return;
            const processedGuilds = new Set();
            const addItemToMap = (id, count, owner, source, isGuild = false) => {
                if (id && count > 0) {
                    if (!globalInventoryMap.has(id)) globalInventoryMap.set(id, []);
                    globalInventoryMap.get(id).push({ owner, source, count, isGuild });
                }
            };

            await pMap(apiKeys, async (account) => {
                try {
                    const [mats, bank, shared, chars, accInfo] = await Promise.all([
                        fetch(`https://api.guildwars2.com/v2/account/materials?access_token=${account.key}`).then(r=>r.ok?r.json():[]),
                        fetch(`https://api.guildwars2.com/v2/account/bank?access_token=${account.key}`).then(r=>r.ok?r.json():[]),
                        fetch(`https://api.guildwars2.com/v2/account/inventory?access_token=${account.key}`).then(r=>r.ok?r.json():[]),
                        fetch(`https://api.guildwars2.com/v2/characters?ids=all&access_token=${account.key}`).then(r=>r.ok?r.json():[]),
                        fetch(`https://api.guildwars2.com/v2/account?access_token=${account.key}`).then(r=>r.ok?r.json():{})
                    ]);

                    if(Array.isArray(mats)) mats.forEach(m => addItemToMap(m.id, m.count, account.name, 'Material Storage'));
                    if(Array.isArray(bank)) bank.forEach(i => i && addItemToMap(i.id, i.count, account.name, 'Bank Vault'));
                    if(Array.isArray(shared)) shared.forEach(i => i && addItemToMap(i.id, i.count, account.name, 'Shared Slot'));
                    
                    if(Array.isArray(chars)) {
                        chars.forEach(char => {
                            if (char.bags) char.bags.forEach(bag => {
                                if (bag && bag.inventory) bag.inventory.forEach(i => i && addItemToMap(i.id, i.count, account.name, `Char: ${char.name}`));
                            });
                        });
                    }

                    if(accInfo.guild_leader && Array.isArray(accInfo.guild_leader)) {
                        for (const guildId of accInfo.guild_leader) {
                            if(processedGuilds.has(guildId) || disabledGuilds.has(guildId)) continue;
                            processedGuilds.add(guildId);
                            try {
                                const stash = await fetch(`https://api.guildwars2.com/v2/guild/${guildId}/stash?access_token=${account.key}`).then(r => r.ok?r.json():[]);
                                const gName = knownGuilds[guildId] ? `Guild: ${knownGuilds[guildId].name} [${knownGuilds[guildId].tag}]` : 'Unknown Guild';
                                stash.forEach(tab => {
                                    if(tab.inventory) tab.inventory.forEach(i => i && addItemToMap(i.id, i.count, gName, 'Guild Stash', true));
                                });
                            } catch(e) {}
                        }
                    }
                } catch(e) {}
            }, 2); 
        }

        // --- IDB CACHE ---
        function getDb() {
            return new Promise((resolve, reject) => {
                const req = indexedDB.open('GW2TrackerDB', 1);
                req.onerror = () => reject(req.error);
                req.onsuccess = () => resolve(req.result);
                req.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if (!db.objectStoreNames.contains('itemDetails')) db.createObjectStore('itemDetails', { keyPath: 'id' });
                    if (!db.objectStoreNames.contains('files')) db.createObjectStore('files');
                };
            });
        }
        
        async function getStaticItemDetails(ids) {
            if(!ids.length) return [];
            try {
                const db = await getDb();
                const tx = db.transaction('itemDetails', 'readonly');
                const store = tx.objectStore('itemDetails');
                const results = [];
                await Promise.all(ids.map(id => new Promise(res => {
                    const req = store.get(id);
                    req.onsuccess = () => res(req.result ? results.push(req.result) : null);
                    req.onerror = () => res(null);
                })));
                return results;
            } catch(e) { return []; }
        }

        async function saveStaticItemDetails(items) {
            if(!items || !items.length) return;
            try {
                const db = await getDb();
                const tx = db.transaction('itemDetails', 'readwrite');
                const store = tx.objectStore('itemDetails');
                items.forEach(item => {
                    if(item && item.id) store.put({ id: item.id, name: item.name, icon: item.icon, rarity: item.rarity });
                });
                await new Promise(resolve => { tx.oncomplete = resolve; tx.onerror = resolve; });
            } catch(e) {}
        }

        async function getCachedSearchFile() {
            if (staticItemData) return staticItemData;
            try {
                const db = await getDb();
                const tx = db.transaction('files', 'readonly');
                const req = tx.objectStore('files').get('gw2_items_v2');
                const res = await new Promise(r => { req.onsuccess = () => r(req.result); req.onerror = () => r(null); });
                if(res) { staticItemData = res; return res; }
            } catch(e){}
            
            try {
                const res = await fetch('gw2-items.json?' + Date.now());
                if(res.ok) {
                    const d = await res.json();
                    const items = d.items || [];
                    const db = await getDb();
                    const tx = db.transaction('files', 'readwrite');
                    tx.objectStore('files').put(items, 'gw2_items_v2');
                    staticItemData = items;
                    return items;
                }
            } catch(e){}
            return [];
        }

        // --- ROBUST ITEM FETCHING ---
        async function fetchItemData(itemIds) {
            if (itemIds.length === 0) return [];
            const resultsMap = new Map();
            const specialIds = itemIds.filter(id => [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(id));
            const containerIds = itemIds.filter(isContainer);
            const regularIds = itemIds.filter(id => !specialIds.includes(id) && !containerIds.includes(id));

            const cachedStatic = await getStaticItemDetails(regularIds);
            cachedStatic.forEach(i => resultsMap.set(i.id, { ...i, buyPrice: null, sellPrice: null }));
            
            const missingStaticIds = regularIds.filter(id => !resultsMap.has(id));

            const promises = [];
            
            if (missingStaticIds.length > 0) {
                promises.push(fetch(`https://api.guildwars2.com/v2/items?ids=${missingStaticIds.join(',')}`)
                    .then(r => r.ok ? r.json() : [])
                    .then(async items => {
                        if(Array.isArray(items)) {
                            await saveStaticItemDetails(items);
                            items.forEach(i => resultsMap.set(i.id, { id: i.id, name: i.name, icon: i.icon, buyPrice: null, sellPrice: null }));
                        }
                    }).catch(e => console.warn('Static fetch failed', e))
                );
            }

            if (regularIds.length > 0) {
                promises.push(fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${regularIds.join(',')}`)
                    .then(r => r.ok ? r.json() : [])
                    .then(prices => {
                        if(Array.isArray(prices)) {
                            prices.forEach(p => {
                                if(resultsMap.has(p.id)) {
                                    const i = resultsMap.get(p.id);
                                    i.buyPrice = p.buys.unit_price;
                                    i.sellPrice = p.sells.unit_price;
                                }
                            });
                        }
                    }).catch(e => console.warn('Price fetch failed', e))
                );
            }

            specialIds.forEach(sid => {
                const def = SPECIAL_ITEMS[sid];
                promises.push(
                    (sid === GEMS_TO_GOLD_ID 
                        ? fetch('https://api.guildwars2.com/v2/commerce/exchange/gems?quantity=400') 
                        : fetch('https://api.guildwars2.com/v2/commerce/exchange/coins?quantity=10000000'))
                    .then(r => r.ok ? r.json() : null)
                    .then(d => {
                        if(d) {
                            if (sid === GEMS_TO_GOLD_ID) resultsMap.set(sid, { ...def, returnFor400Gems: d.quantity });
                            else resultsMap.set(sid, { ...def, costFor400Gems: Math.round((400 / (d.quantity / 1000)) * 10000) });
                        } else {
                            throw new Error();
                        }
                    }).catch(() => resultsMap.set(sid, { ...def, costFor400Gems: null, returnFor400Gems: null }))
                );
            });

            if(containerIds.length > 0) {
                const childSet = new Set();
                containerIds.forEach(cid => CONTAINER_ITEMS[cid].items.forEach(i => childSet.add(i.id)));
                
                promises.push(fetch(`https://api.guildwars2.com/v2/commerce/prices?ids=${Array.from(childSet).join(',')}`)
                    .then(r => r.ok ? r.json() : [])
                    .then(async prices => {
                        const childPriceMap = new Map();
                        if(Array.isArray(prices)) prices.forEach(p => childPriceMap.set(p.id, p.sells?.unit_price));
                        
                        const childIds = Array.from(childSet);
                        const childStatic = await getStaticItemDetails(childIds);
                        const childNameMap = new Map();
                        childStatic.forEach(i => childNameMap.set(i.id, i.name));
                        const missingChildren = childIds.filter(id => !childNameMap.has(id));
                        
                        if(missingChildren.length > 0) {
                            try {
                                const apiChildren = await fetch(`https://api.guildwars2.com/v2/items?ids=${missingChildren.join(',')}`).then(r=>r.ok?r.json():[]);
                                if(Array.isArray(apiChildren)) {
                                    await saveStaticItemDetails(apiChildren);
                                    apiChildren.forEach(i => childNameMap.set(i.id, i.name));
                                }
                            } catch(e){}
                        }
                        
                        const containerStatic = await getStaticItemDetails(containerIds);
                        containerStatic.forEach(c => resultsMap.set(c.id, { ...c, isContainer: true }));
                        const missingCont = containerIds.filter(id => !resultsMap.has(id));
                         if(missingCont.length > 0) {
                            try {
                                const apiCont = await fetch(`https://api.guildwars2.com/v2/items?ids=${missingCont.join(',')}`).then(r=>r.ok?r.json():[]);
                                if(Array.isArray(apiCont)) {
                                    await saveStaticItemDetails(apiCont);
                                    apiCont.forEach(c => resultsMap.set(c.id, { ...c, isContainer: true }));
                                }
                            } catch(e){}
                        }

                        containerIds.forEach(cid => {
                            if(!resultsMap.has(cid)) return;
                            const item = resultsMap.get(cid);
                            let total = 0;
                            const breakdown = [];
                            CONTAINER_ITEMS[cid].items.forEach(d => {
                                const p = childPriceMap.get(d.id);
                                const name = childNameMap.get(d.id) || `Item ${d.id}`;
                                if (p) {
                                    const val = p * d.avgQuantity * d.dropProb;
                                    total += val;
                                    breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: Math.round(val) });
                                } else {
                                    breakdown.push({ name, avgQty: d.avgQuantity, prob: d.dropProb, expectedCopper: null });
                                }
                            });
                            item.sellPrice = Math.round(total);
                            item.buyPrice = null;
                            item.containerContents = breakdown;
                        });
                    }).catch(e => console.warn('Container fetch failed', e)));
            }

            await Promise.all(promises);
            return itemIds.map(id => resultsMap.get(id)).filter(Boolean);
        }

        // --- UI HELPERS ---
        function formatCurrency(copper) {
            if (copper === null || copper === undefined || isNaN(copper)) return { gold: '-', silver: '-', copper: '-' };
            const gold = Math.floor(copper / 10000);
            const silver = Math.floor((copper % 10000) / 100);
            const copperRemainder = copper % 100;
            return { gold, silver, copper: copperRemainder };
        }
        function createCurrencyElement(copperValue) {
            const { gold, silver, copper } = formatCurrency(copperValue);
            const elem = document.createElement('div');
            elem.className = 'price-value';
            if (gold === '-' && silver === '-' && copper === '-') {
                elem.innerHTML = '<span style="color:#e74c3c;">N/A</span>';
                return elem;
            }
            elem.innerHTML = `
                ${gold > 0 ? `<span class="gold">${gold}</span>` : ''}
                ${silver > 0 || gold > 0 ? `<span class="silver">${silver}</span>` : ''}
                <span class="copper">${copper}</span>
            `;
            return elem;
        }

        function createItemCard(itemData) {
            const card = document.createElement('div');
            card.className = 'item-card';
            card.dataset.itemId = itemData.id;
            card.draggable = true;
            
            const isSpecial = [GOLD_TO_GEMS_ID, GEMS_TO_GOLD_ID].includes(itemData.id);
            const graphUrl = GRAPH_URL_TEMPLATE.replace('{id}', itemData.id);
            const safeName = itemData.name.replace(/'/g, "\\'");
            const orders = accountOrdersMap.get(itemData.id) || { buys: [], sells: [] };
            const inventory = globalInventoryMap.get(itemData.id) || [];
            
            let buyClass = '';
            let buyTitle = 'You have active Buy Orders';
            if (orders.buys.length > 0 && itemData.buyPrice) {
                const maxUserPrice = Math.max(...orders.buys.map(o => o.price));
                if (maxUserPrice < itemData.buyPrice) { buyClass = ' icon-warn'; buyTitle = 'Your Buy Orders are outbid'; }
            }

            let sellClass = '';
            let sellTitle = 'You have active Sell Orders';
            if (orders.sells.length > 0 && itemData.sellPrice) {
                const minUserPrice = Math.min(...orders.sells.map(o => o.price));
                if (minUserPrice > itemData.sellPrice) { sellClass = ' icon-warn'; sellTitle = 'Your Sell Listings are underbid'; }
            }

            let emojisHtml = '';
            if (orders.buys.length > 0) emojisHtml += `<span class="order-icon icon-buy${buyClass}" onclick="openOrderModal('buys', ${itemData.id}, '${safeName}')" title="${buyTitle}">ðŸ›’</span>`;
            if (orders.sells.length > 0) emojisHtml += `<span class="order-icon icon-sell${sellClass}" onclick="openOrderModal('sells', ${itemData.id}, '${safeName}')" title="${sellTitle}">ðŸ·ï¸</span>`;
            if (inventory.length > 0) emojisHtml += `<span class="order-icon icon-inv" onclick="openInventoryModal(${itemData.id}, '${safeName}')" title="You possess this item">ðŸ‘œ</span>`;
            if (itemData.isContainer) emojisHtml += `<span class="order-icon icon-info" onclick="openContainerModal(${itemData.id})" title="View Contents">â„¹ï¸</span>`;

            const idHtml = isSpecial ? 'Special' : `ID: ${itemData.id} ${emojisHtml}`;
            const actionBtns = `<div class="card-actions"><button class="card-btn remove-btn" data-item-id="${itemData.id}" title="Remove Item">Ã—</button></div>`;

            let mainContent = '';
            if (isSpecial) {
                let label = itemData.id === GOLD_TO_GEMS_ID ? 'Cost for 400 Gems:' : 'Return for 400 Gems:';
                let val = itemData.id === GOLD_TO_GEMS_ID ? itemData.costFor400Gems : itemData.returnFor400Gems;
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info"><div class="item-name">${itemData.name}</div><div class="item-id">Special</div></div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices"><div class="price-row"><div class="price-label">${label}</div>${createCurrencyElement(val).outerHTML}</div></div>`;
            } else if (itemData.isContainer) {
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info"><div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">ðŸ“ˆ</a> ${itemData.name}</div><div class="item-id">${idHtml} â€¢ Container</div></div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices"><div class="price-row"><div class="price-label">Expected Value:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div><div class="price-row"><div class="price-label">Buy Price:</div><span style="color:#e74c3c;">Not Tradable</span></div></div>`;
            } else {
                mainContent = `
                    <div class="item-header">
                        <div class="item-image"><img src="${itemData.icon}"></div>
                        <div class="item-info"><div class="item-name"><a href="${graphUrl}" target="_blank" class="graph-link">ðŸ“ˆ</a> ${itemData.name}</div><div class="item-id">${idHtml}</div></div>
                        ${actionBtns}
                    </div>
                    <div class="item-prices"><div class="price-row"><div class="price-label">Buy Price:</div>${createCurrencyElement(itemData.buyPrice).outerHTML}</div><div class="price-row"><div class="price-label">Sell Price:</div>${createCurrencyElement(itemData.sellPrice).outerHTML}</div></div>`;
            }
            
            card.innerHTML = mainContent;
            const rmBtn = card.querySelector('.remove-btn');
            if(rmBtn) rmBtn.addEventListener('click', e => { e.stopPropagation(); removeFromActiveTab(Number(e.target.dataset.itemId)); });
            card.addEventListener('dragstart', handleDragStart); card.addEventListener('dragover', handleDragOver); card.addEventListener('drop', handleDrop); card.addEventListener('dragend', handleDragEnd);
            return card;
        }

        // --- MODALS ---
        function openInventoryModal(itemId, itemName) {
            const items = globalInventoryMap.get(itemId) || [];
            document.getElementById('inventory-modal-title').textContent = `Inventory Locations for ${itemName}`;
            document.getElementById('inventory-modal').style.display = 'flex';
            const content = document.getElementById('inventory-content');
            if(items.length === 0) { content.innerHTML = '<div style="text-align:center; padding:20px;">None found.</div>'; return; }
            
            const groups = {}; let grandTotal = 0;
            items.forEach(i => {
                if (!groups[i.owner]) groups[i.owner] = { isGuild: i.isGuild, total: 0, sources: {} };
                if (!groups[i.owner].sources[i.source]) groups[i.owner].sources[i.source] = 0;
                groups[i.owner].sources[i.source] += i.count; groups[i.owner].total += i.count; grandTotal += i.count;
            });
            let html = `<table class="data-table"><thead><tr><th style="width:60%">Location</th><th>Count</th></tr></thead><tbody>`;
            Object.keys(groups).sort((a, b) => groups[a].isGuild === groups[b].isGuild ? a.localeCompare(b) : groups[a].isGuild ? 1 : -1).forEach(owner => {
                html += `<tr class="inv-owner-header"><td class="${groups[owner].isGuild?'col-guild':'col-account'}">${owner}</td><td style="font-weight:bold;">Total: ${groups[owner].total}</td></tr>`;
                Object.keys(groups[owner].sources).sort().forEach(src => html += `<tr><td style="padding-left: 20px;">- ${src}</td><td class="col-qty">${groups[owner].sources[src]}</td></tr>`);
            });
            html += `<tr style="border-top: 2px solid #3498db; background: rgba(255,255,255,0.05);"><td style="text-align:right; font-weight:bold;">Grand Total:</td><td class="col-qty" style="font-size:1.1em;">${grandTotal}</td></tr></tbody></table>`;
            content.innerHTML = html;
        }

        function openOrderModal(type, itemId, itemName) {
            const orders = accountOrdersMap.get(itemId)?.[type] || [];
            const itemData = globalItemData.get(itemId);
            document.getElementById('order-modal-title').textContent = `${type === 'buys' ? 'Buy' : 'Sell'} Orders for ${itemName}`;
            document.getElementById('order-modal').style.display = 'flex';
            const content = document.getElementById('order-content');
            
            if (orders.length === 0) { content.innerHTML = '<div style="text-align:center; padding:20px;">No active orders found.</div>'; return; }
            
            orders.sort((a, b) => type === 'buys' ? b.price - a.price : a.price - b.price);
            
            const table = document.createElement('table');
            table.className = 'data-table';
            table.innerHTML = `<thead><tr><th>Watch</th><th>Account</th><th>Qty</th><th>Unit Price</th><th>Total Value</th><th>Date Placed</th></tr></thead>`;
            const tbody = document.createElement('tbody');

            orders.forEach(order => {
                let warningHtml = '';
                if (itemData) {
                    if (type === 'buys' && itemData.buyPrice && order.price < itemData.buyPrice) warningHtml = ' <span title="Outbid by current market">âš ï¸</span>';
                    else if (type === 'sells' && itemData.sellPrice && order.price > itemData.sellPrice) warningHtml = ' <span title="Undercut by current market">âš ï¸</span>';
                }

                const tr = document.createElement('tr');
                
                const isWatched = watchedOrders.has(order.id);
                const watchBtn = document.createElement('button');
                watchBtn.className = `watch-btn ${isWatched ? 'watching' : ''}`;
                watchBtn.innerHTML = 'ðŸ””';
                watchBtn.title = isWatched ? "Click to stop watching" : "Alarm when this order finishes";
                watchBtn.onclick = (e) => {
                    e.stopPropagation();
                    if (watchedOrders.has(order.id)) {
                        watchedOrders.delete(order.id);
                        watchBtn.classList.remove('watching');
                        watchBtn.title = "Alarm when this order finishes";
                    } else {
                        watchedOrders.set(order.id, {
                            id: order.id,
                            itemId: itemId,
                            itemName: itemName,
                            type: type,
                            price: order.price,
                            quantity: order.quantity
                        });
                        watchBtn.classList.add('watching');
                        watchBtn.title = "Click to stop watching";
                    }
                    saveWatchedOrders();
                };

                const tdWatch = document.createElement('td');
                tdWatch.appendChild(watchBtn);

                tr.innerHTML = `
                    <td class="col-account">${order.accountName}</td>
                    <td class="col-qty">${order.quantity}</td>
                    <td>${createCurrencyElement(order.price).outerHTML}${warningHtml}</td>
                    <td>${createCurrencyElement(order.quantity * order.price).outerHTML}</td>
                    <td class="col-date">${new Date(order.created).toLocaleString()}</td>
                `;
                tr.prepend(tdWatch);
                tbody.appendChild(tr);
            });

            table.appendChild(tbody);
            content.innerHTML = '';
            content.appendChild(table);
        }

        // Global Order Modal (UPDATED)
        async function openGlobalOrdersModal() {
            // Initialize selected accounts to all if empty
            if (selectedOrderAccounts.size === 0 && apiKeys.length > 0) {
                apiKeys.forEach(k => selectedOrderAccounts.add(k.name));
            }

            // Render Account Checkboxes
            const accContainer = document.getElementById('order-account-filters');
            accContainer.innerHTML = '';
            apiKeys.forEach(k => {
                const isChecked = selectedOrderAccounts.has(k.name);
                const label = document.createElement('label');
                label.className = `order-acc-chk ${isChecked ? '' : 'unchecked'}`;
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.checked = isChecked;
                
                checkbox.onchange = () => {
                     if (checkbox.checked) {
                        selectedOrderAccounts.add(k.name);
                        label.classList.remove('unchecked');
                    } else {
                        selectedOrderAccounts.delete(k.name);
                        label.classList.add('unchecked');
                    }
                    renderGlobalOrders();
                };

                label.appendChild(checkbox);
                label.appendChild(document.createTextNode(' ' + k.name));
                accContainer.appendChild(label);
            });

            // Reset search
            orderSearchQuery = '';
            document.getElementById('order-search-input').value = '';

            document.getElementById('global-orders-modal').style.display = 'flex';
            await renderGlobalOrders();
        }

        function switchOrderType(type) {
            currentOrderType = type;
            renderGlobalOrders();
        }

        function handleOrderSearch(val) {
            orderSearchQuery = val.toLowerCase();
            renderGlobalOrders();
        }

        function handleOrderSort(col) {
            if (currentOrderSort.col === col) {
                currentOrderSort.dir = currentOrderSort.dir === 'asc' ? 'desc' : 'asc';
            } else {
                currentOrderSort.col = col;
                currentOrderSort.dir = 'desc'; // Default to desc usually better for price/date
            }
            renderGlobalOrders();
        }

        async function renderGlobalOrders() {
            // UI Toggle States
            document.getElementById('toggle-buys').className = `order-toggle-btn ${currentOrderType === 'buys' ? 'active-buys' : ''}`;
            document.getElementById('toggle-sells').className = `order-toggle-btn ${currentOrderType === 'sells' ? 'active-sells' : ''}`;

            const content = document.getElementById('global-orders-content');
            let orders = allAccountOrders[currentOrderType];
            
            if (!orders || orders.length === 0) {
                content.innerHTML = `<div style="text-align:center; padding:30px; color:#bdc3c7;">No ${currentOrderType === 'buys' ? 'Buy Orders' : 'Sell Listings'} found.</div>`;
                return;
            }

            // 1. Enrich data with Names/Icons (from Cache)
            const uniqueIds = [...new Set(orders.map(o => o.item_id))];
            const itemDetails = new Map();
            const cachedDetails = await getStaticItemDetails(uniqueIds);
            cachedDetails.forEach(d => itemDetails.set(d.id, d));

            let enrichedOrders = orders.map(o => {
                const details = itemDetails.get(o.item_id) || { name: `Item ${o.item_id}`, icon: '' };
                return {
                    ...o,
                    itemName: details.name,
                    itemIcon: details.icon,
                    totalValue: o.quantity * o.price,
                    createdDate: new Date(o.created)
                };
            });

            // 2. Filter (Account & Search)
            enrichedOrders = enrichedOrders.filter(o => {
                const accountMatch = selectedOrderAccounts.has(o.accountName);
                const searchMatch = !orderSearchQuery || o.itemName.toLowerCase().includes(orderSearchQuery);
                return accountMatch && searchMatch;
            });

            // 3. Sort
            enrichedOrders.sort((a, b) => {
                let valA, valB;
                switch (currentOrderSort.col) {
                    case 'account': valA = a.accountName; valB = b.accountName; break;
                    case 'item': valA = a.itemName; valB = b.itemName; break;
                    case 'qty': valA = a.quantity; valB = b.quantity; break;
                    case 'price': valA = a.price; valB = b.price; break;
                    case 'total': valA = a.totalValue; valB = b.totalValue; break;
                    case 'date': valA = a.createdDate; valB = b.createdDate; break;
                    default: valA = a.createdDate; valB = b.createdDate;
                }

                if (valA < valB) return currentOrderSort.dir === 'asc' ? -1 : 1;
                if (valA > valB) return currentOrderSort.dir === 'asc' ? 1 : -1;
                return 0;
            });

            // 4. Render Table
            const getSortClass = (col) => currentOrderSort.col === col ? `sorted-${currentOrderSort.dir}` : '';
            
            let html = `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th class="sortable-th ${getSortClass('account')}" onclick="handleOrderSort('account')">Account</th>
                            <th class="sortable-th ${getSortClass('item')}" onclick="handleOrderSort('item')">Item</th>
                            <th class="sortable-th ${getSortClass('qty')}" onclick="handleOrderSort('qty')">Qty</th>
                            <th class="sortable-th ${getSortClass('price')}" onclick="handleOrderSort('price')">Unit Price</th>
                            <th class="sortable-th ${getSortClass('total')}" onclick="handleOrderSort('total')">Total Value</th>
                            <th class="sortable-th ${getSortClass('date')}" onclick="handleOrderSort('date')">Date</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            if (enrichedOrders.length === 0) {
                 html += `<tr><td colspan="6" style="text-align:center; padding:20px; color:#95a5a6;">No orders match your filters.</td></tr>`;
            } else {
                enrichedOrders.forEach(o => {
                    const iconHtml = o.itemIcon ? `<img src="${o.itemIcon}" class="delivery-icon">` : '';
                    html += `<tr>
                        <td class="col-account">${o.accountName}</td>
                        <td><div style="display:flex; align-items:center;">${iconHtml} ${o.itemName}</div></td>
                        <td class="col-qty">${o.quantity}</td>
                        <td>${createCurrencyElement(o.price).outerHTML}</td>
                        <td>${createCurrencyElement(o.totalValue).outerHTML}</td>
                        <td class="col-date">${o.createdDate.toLocaleDateString()} ${o.createdDate.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'})}</td>
                    </tr>`;
                });
            }

            html += `</tbody></table>`;
            content.innerHTML = html;
        }

        function openNotificationModal() {
            document.getElementById('notification-modal').style.display = 'flex';
            renderNotificationModalList();
        }

        function renderNotificationModalList() {
            const content = document.getElementById('notification-content');
            content.innerHTML = '';
            
            if (activeNotifications.length === 0) {
                content.innerHTML = '<div style="text-align:center; padding:30px; color:#bdc3c7;">No new alerts.</div>';
                return;
            }

            activeNotifications.forEach(notif => {
                const item = document.createElement('div');
                item.className = `notif-item type-${notif.type}`;
                item.innerHTML = `
                    <div class="notif-text-col">
                        <span class="notif-title">${notif.title}</span>
                        <div class="notif-msg">${notif.message}</div>
                        <div class="notif-time">${new Date(notif.timestamp).toLocaleString()}</div>
                    </div>
                    <button class="notif-close" title="Dismiss">Ã—</button>
                `;
                item.querySelector('.notif-close').onclick = () => removeNotification(notif.id);
                content.appendChild(item);
            });
        }

        function openContainerModal(itemId) {
            const itemData = globalItemData.get(itemId);
            if (!itemData || !itemData.isContainer) return;
            document.getElementById('container-modal-title').textContent = `Container: ${itemData.name}`;
            document.getElementById('container-modal').style.display = 'flex';
            let html = `<table class="data-table"><thead><tr><th>Item Name</th><th>Chance / Qty</th><th>Expected Value</th></tr></thead><tbody>`;
            itemData.containerContents.forEach(c => html += `<tr><td>${c.name}</td><td>${c.avgQty}x (${(c.prob*100).toFixed(0)}%)</td><td>${c.expectedCopper !== null ? createCurrencyElement(c.expectedCopper).outerHTML : '<span style="color:#7f8c8d;">N/A</span>'}</td></tr>`);
            document.getElementById('container-content').innerHTML = html + `</tbody></table>`;
        }

        function openDeliveryModal() {
            document.getElementById('delivery-modal').style.display = 'flex';
            const content = document.getElementById('delivery-content');
            if (deliveryData.length === 0) { content.innerHTML = '<div style="text-align:center; padding:20px;">No items or coins waiting for pickup.</div>'; return; }
            let html = `<table class="data-table"><thead><tr><th>Account</th><th>Coins</th><th>Items</th></tr></thead><tbody>`;
            deliveryData.forEach(d => {
                let itemsHtml = d.items.length > 0 ? d.items.map(i => `<div style="margin-bottom:4px;">${i.icon ? `<img src="${i.icon}" class="delivery-icon">` : ''}<span class="delivery-item-name">${i.name}</span> <span class="col-qty">x${i.count}</span></div>`).join('') : '<span style="color:#7f8c8d;">None</span>';
                html += `<tr><td class="col-account">${d.accountName}</td><td>${d.coins > 0 ? createCurrencyElement(d.coins).outerHTML : '<span style="color:#7f8c8d;">-</span>'}</td><td>${itemsHtml}</td></tr>`;
            });
            content.innerHTML = html + `</tbody></table>`;
        }

        // --- DRAG AND DROP & UTILS ---
        function handleDragStart(e) { draggedCard = this; this.style.opacity = '0.5'; }
        function handleDragOver(e) { e.preventDefault(); }
        function handleDragEnd() { this.style.opacity = '1'; draggedCard = null; }
        function handleDrop(e) {
            e.preventDefault();
            if (draggedCard && draggedCard !== this) {
                const from = Number(draggedCard.dataset.itemId);
                const to = Number(this.dataset.itemId);
                const currentItems = itemTabs[activeTabIndex].items;
                const i1 = currentItems.indexOf(from);
                const i2 = currentItems.indexOf(to);
                if (i1 > -1 && i2 > -1) {
                    currentItems.splice(i1, 1);
                    currentItems.splice(i2, 0, from);
                    saveTabs();
                    if(i1 < i2) this.after(draggedCard); else this.before(draggedCard);
                }
            }
        }

        async function searchItemsByName(q) {
            const lowerQ = q.toLowerCase();
            const customMatches = CUSTOM_SEARCHABLE_ITEMS.filter(i => i.name.toLowerCase().includes(lowerQ));
            const items = await getCachedSearchFile();
            const staticMatches = items
                .filter(i => i[1] && i[1].toLowerCase().includes(lowerQ))
                .slice(0, 15)
                .map(i => ({ id: i[0], name: i[1] }));
            return [...customMatches, ...staticMatches];
        }

        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function showError(m) { errorContainer.innerHTML = `<div class="error">${m}</div>`; setTimeout(() => errorContainer.innerHTML='', 4000); }

        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            loadSettings();
            loadWatchedOrders(); // Load alarms
            loadActiveNotifications();
            loadTabs();
            refreshAllData(); 

            apiSettingsLink.onclick = () => document.getElementById('api-modal').style.display = 'flex';
            deliveryBtn.onclick = () => openDeliveryModal();
            notificationBtn.onclick = () => openNotificationModal();
            ordersBtn.onclick = () => openGlobalOrdersModal();
            document.getElementById('enable-inventory-chk').onchange = (e) => { enableInventory = e.target.checked; saveSettings(); refreshAllData(); };

            async function triggerAddItem() {
                const v = itemInput.value.trim();
                if(!v) return;
                const id = parseInt(v);
                if(!isNaN(id)) { await addToActiveTab(id); itemInput.value = ''; }
                else showSearchResults(await searchItemsByName(v));
            }
            addItemBtn.onclick = triggerAddItem;
            itemInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') triggerAddItem(); });
            
            refreshItemsBtn.onclick = async () => {
                refreshItemsBtn.disabled = true;
                try {
                    const db = await getDb();
                    const tx = db.transaction('files', 'readwrite');
                    tx.objectStore('files').delete('gw2_items_v2'); 
                } catch(e){}
                await getCachedSearchFile();
                await refreshAllData();
                refreshItemsBtn.disabled = false;
                showError('Refreshed.');
            };

            function showSearchResults(res) {
                searchResultsContainer.innerHTML = '';
                res.forEach(i => {
                    const d = document.createElement('div');
                    d.className = 'search-result-item';
                    d.innerHTML = `<div>${i.name}</div><div style="font-size:0.8em;color:#aaa">ID: ${i.id}</div>`;
                    d.onclick = async () => { await addToActiveTab(i.id); searchResultsContainer.style.display = 'none'; itemInput.value = ''; };
                    searchResultsContainer.appendChild(d);
                });
                searchResultsContainer.style.display = 'block';
            }

            window.onclick = (e) => { 
                if(!e.target.closest('.controls')) searchResultsContainer.style.display='none';
                if(e.target.classList.contains('modal-overlay')) e.target.style.display = 'none';
            };
            itemInput.oninput = (e) => {
                clearTimeout(debounceTimer);
                debounceTimer = setTimeout(async () => {
                    const v = e.target.value.trim();
                    if(v.length > 2 && isNaN(parseInt(v))) showSearchResults(await searchItemsByName(v));
                }, 300);
            };

            document.getElementById('export-btn').onclick = () => {
                const a = document.createElement('a');
                a.href = URL.createObjectURL(new Blob([JSON.stringify(itemTabs, null, 2)], {type: "application/json"}));
                a.download = "gw2-tracker-config.json";
                document.body.appendChild(a); a.click(); document.body.removeChild(a);
            };

            const fileInput = document.getElementById('import-file-input');
            document.getElementById('import-btn').onclick = () => fileInput.click();
            fileInput.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = async (event) => {
                    try {
                        const imported = JSON.parse(event.target.result);
                        if (Array.isArray(imported) && imported.length > 0 && imported[0].items) {
                            if(confirm('Importing will overwrite your current tabs. Continue?')) {
                                itemTabs = imported;
                                activeTabIndex = 0;
                                saveTabs();
                                renderTabs();
                                await refreshAllData();
                                alert("Imported successfully.");
                            }
                        } else alert("Invalid file.");
                    } catch (err) { alert("Error parsing file."); }
                    fileInput.value = '';
                };
                reader.readAsText(file);
            };
        });
    </script>
    <p></p>
    <a href="https://gartkb.github.io/Garts-Great-Tools/" style="color: yellow; text-decoration: underline;">Gart's Great Tools</a>
</body>
</html>