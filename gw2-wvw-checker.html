<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GW2 WvW Team Manager</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a1a; color: #ddd; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .main-wrapper { width: 800px; max-width: 95%; }
        
        /* Containers */
        .card { background: #2a2a2a; padding: 25px; border-radius: 8px; box-shadow: 0 4px 15px rgba(0,0,0,0.3); margin-bottom: 20px; border: 1px solid #333; }
        h2 { color: #f5bd00; margin-top: 0; font-size: 1.5em; border-bottom: 1px solid #444; padding-bottom: 10px; margin-bottom: 20px; }
        h3 { color: #eee; font-size: 1.1em; margin: 0 0 10px 0; }

        /* Inputs */
        .input-row { display: flex; gap: 10px; margin-bottom: 10px; }
        input[type="text"] { flex: 1; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; font-family: monospace; }
        select { padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; width: 80px; text-align: center; }
        
        /* Buttons */
        button { padding: 12px 20px; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; transition: background 0.2s; color: white; }
        .btn-primary { background: #b71c1c; }
        .btn-primary:hover { background: #d32f2f; }
        .btn-secondary { background: #006064; }
        .btn-secondary:hover { background: #00838f; }
        button:disabled { background: #555 !important; cursor: wait; }

        /* Output Areas */
        .output-box { margin-top: 15px; padding-top: 15px; border-top: 1px solid #333; min-height: 20px; }
        
        /* Tables & Lists */
        table { width: 100%; border-collapse: collapse; background: #222; margin-top: 10px; }
        th { text-align: left; color: #888; border-bottom: 2px solid #444; padding: 10px; font-size: 0.85em; text-transform: uppercase; }
        td { border-bottom: 1px solid #333; padding: 12px 10px; vertical-align: middle; }
        
        /* Stylized Text */
        .guild-name { font-weight: bold; color: #eee; }
        .tag { color: #f5bd00; font-family: monospace; margin-left: 5px; }
        .team-active { color: #4caf50; font-weight: bold; }
        .team-inactive { color: #888; font-style: italic; }
        .badge { background: #4caf50; color: white; font-size: 0.65em; padding: 3px 6px; border-radius: 3px; text-transform: uppercase; margin-left: 8px; }
        
        /* Storage Msg */
        .saved-msg { font-size: 0.8em; color: #4caf50; margin-left: 10px; opacity: 0; transition: opacity 0.5s; }
        .forget-link { font-size: 0.8em; color: #888; text-decoration: underline; cursor: pointer; float: right; margin-top: 5px; }

        /* Reference Section */
        .ref-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 8px; margin-top: 10px; }
        .ref-card { background: #222; padding: 8px; border-radius: 4px; border: 1px solid #333; text-align: center; font-size: 0.9em; }
        .ref-card strong { display: block; color: #ccc; }
        .ref-card small { color: #666; }
    </style>
</head>
<body>

<div class="main-wrapper">
    
    <!-- SECTION 1: MY ACCOUNT -->
    <div class="card">
        <h2>My Account</h2>
        <div class="input-row">
            <input type="text" id="apiKey" placeholder="Paste your API Key here (requires account & guilds scope)">
            <button class="btn-primary" onclick="showMyGuildTeams()" id="btnMy">Show my guild teams</button>
        </div>
        <div style="height: 20px;">
            <span id="savedMsg" class="saved-msg">Key saved.</span>
            <span class="forget-link" onclick="forgetKey()">Forget Key</span>
        </div>
        <div id="outputAccount" class="output-box"></div>
    </div>

    <!-- SECTION 2: GUILD LOOKUP -->
    <div class="card">
        <h2>Guild Lookup</h2>
        <p style="font-size:0.9em; color:#aaa; margin-bottom: 15px;">Search for any guild by name to see their World Restructuring assignment.</p>
        <div class="input-row">
            <select id="searchRegion">
                <option value="na">NA</option>
                <option value="eu">EU</option>
            </select>
            <input type="text" id="searchName" placeholder="Exact Guild Name (e.g. Rate of Fire)">
            <button class="btn-secondary" onclick="lookupGuild()" id="btnSearch">Search</button>
        </div>
        <div id="outputSearch" class="output-box"></div>
    </div>

    <!-- SECTION 3: REFERENCE -->
    <div class="card">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3>Team Reference List</h3>
            <span style="font-size:0.8em; color:#888; cursor:pointer; text-decoration:underline;" onclick="renderRefList()">Refresh</span>
        </div>
        <div id="refList" class="ref-grid"></div>
    </div>

</div>

<script>
    const API = 'https://api.guildwars2.com/v2';
    const STORAGE_KEY = 'gw2_audit_key';

    // --- STATIC DATA ---
    const TEAM_NAMES = {
        "11001": "Moogooloo", "11002": "Rall's Rest", "11003": "Domain of Torment", 
        "11004": "Yohlon Haven", "11005": "Tombs of Drascir", "11006": "Hall of Judgment", 
        "11007": "Throne of Balthazar", "11008": "Dwayna's Temple", "11009": "Abaddon's Prison", 
        "11010": "Cathedral of Blood", "11011": "Lutgardis Conservatory", "11012": "Mosswood",
        "12001": "Skrittsburgh", "12002": "Fortune's Vale", "12003": "Silent Woods", 
        "12004": "Ettin's Back", "12005": "Domain of Anguish", "12006": "Palawadan", 
        "12007": "Bloodstone Gulch", "12008": "Frost Citadel", "12009": "Dragrimmar", 
        "12010": "Grenth's Door", "12011": "Mirror of Lyssa", "12012": "Melandru's Dome", 
        "12013": "Kormir's Library", "12014": "Great House Aviary", "12015": "Bava Nisos"
    };

    // --- CACHE ---
    // We store the massive guild maps here so we don't re-download them 
    // if the user switches between My Account and Guild Lookup
    let wvwMapCache = { na: null, eu: null };

    // --- INIT ---
    window.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem(STORAGE_KEY);
        if(savedKey) document.getElementById('apiKey').value = savedKey;
        renderRefList();
    });

    // --- SHARED HELPER: Get Map ---
    async function getWvwMap(region) {
        if(wvwMapCache[region]) return wvwMapCache[region];
        
        const res = await fetch(`${API}/wvw/guilds/${region}`);
        if(!res.ok) throw new Error(`Could not fetch ${region.toUpperCase()} team data.`);
        
        const data = await res.json();
        wvwMapCache[region] = data;
        return data;
    }

    // --- FUNCTION 1: SHOW MY GUILD TEAMS ---
    async function showMyGuildTeams() {
        const out = document.getElementById('outputAccount');
        const btn = document.getElementById('btnMy');
        let key = document.getElementById('apiKey').value.trim();

        if(key.length < 10) {
            out.innerHTML = `<div style="color:#ff5252">Please enter a valid API key.</div>`;
            return;
        }

        // Save Key
        localStorage.setItem(STORAGE_KEY, key);
        document.getElementById('savedMsg').style.opacity = '1';
        setTimeout(() => document.getElementById('savedMsg').style.opacity = '0', 3000);

        btn.disabled = true;
        btn.innerText = "Loading...";
        out.innerHTML = `<div style="color:#888;">Fetching account and team data...</div>`;

        try {
            // 1. Get Account
            const accRes = await fetch(`${API}/account?access_token=${key}`);
            if(!accRes.ok) throw new Error("Invalid API Key or API error.");
            const acc = await accRes.json();

            // 2. Determine Region
            const region = (acc.world < 2000) ? 'na' : 'eu';
            const selectedGuildId = acc.wvw_guild;

            // 3. Get Map (Uses Cache)
            out.innerHTML = `<div style="color:#888;">Downloading ${region.toUpperCase()} team map...</div>`;
            const map = await getWvwMap(region);

            // 4. Get Guild Details
            const guildIds = acc.guilds || [];
            const guildPromises = guildIds.map(id => fetch(`${API}/guild/${id}`).then(r => r.ok ? r.json() : null));
            const guildsData = await Promise.all(guildPromises);

            // 5. Build Table
            let rows = guildsData.map((g, idx) => {
                if(!g) return ""; // Skip errored guilds
                
                const isSelected = (g.id === selectedGuildId);
                const tid = map[g.id];
                const tName = TEAM_NAMES[tid] || (tid ? `Team ${tid}` : "No Team");
                
                let statusHtml = tid 
                    ? `<span class="team-active">${tName}</span>` 
                    : `<span class="team-inactive">Not Assigned</span>`;
                
                if(isSelected && tid) statusHtml += ` <span class="badge">Selected</span>`;
                else if (isSelected) statusHtml += ` <span style="color:#f5bd00; font-size:0.8em;">(Selected but no team)</span>`;

                return `
                    <tr style="${isSelected ? 'background:rgba(76, 175, 80, 0.1)' : ''}">
                        <td>
                            <span class="guild-name">${g.name}</span> <span class="tag">[${g.tag}]</span>
                        </td>
                        <td>${statusHtml}</td>
                    </tr>
                `;
            }).join('');

            out.innerHTML = `
                <div style="margin-bottom:10px; border-left:3px solid #f5bd00; padding-left:10px;">
                    <div>Region: <strong>${region.toUpperCase()}</strong></div>
                    <div>Account: ${acc.name}</div>
                </div>
                <table>
                    <thead><tr><th>Guild</th><th>Assigned Team</th></tr></thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

        } catch(e) {
            out.innerHTML = `<div style="color:#ff5252">Error: ${e.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Show my guild teams";
        }
    }

    // --- FUNCTION 2: GUILD LOOKUP ---
    async function lookupGuild() {
        const out = document.getElementById('outputSearch');
        const btn = document.getElementById('btnSearch');
        const name = document.getElementById('searchName').value.trim();
        const region = document.getElementById('searchRegion').value;

        if(!name) return;

        btn.disabled = true;
        btn.innerText = "...";
        out.innerHTML = `<div style="color:#888">Searching...</div>`;

        try {
            // 1. Find Guild ID
            const searchRes = await fetch(`${API}/guild/search?name=${encodeURIComponent(name)}`);
            if(!searchRes.ok) throw new Error("Guild not found.");
            const searchData = await searchRes.json();
            
            if(searchData.length === 0) throw new Error("Guild not found.");
            const gid = searchData[0];
            const guildRes = await fetch(`${API}/guild/${gid}`);
            const guildData = await guildRes.json();
            // 2. Get Map (Uses Cache)
            // Note: Even if we searched by name, we need to know which region's map to check
            const map = await getWvwMap(region);

            // 3. Result
            const tid = map[gid];
            
            if(tid) {
                const tName = TEAM_NAMES[tid] || `Team ${tid}`;
                out.innerHTML = `
                    <div style="background:#222; padding:15px; text-align:center; border:1px solid #444; margin-top:10px;">
                        <div style="font-size:1.2em; color:#fff;">    ${name} <span class="tag">[${guildData.tag}]</span></div>
                        <div style="color:#aaa; font-size:0.9em; margin-bottom:10px;">${gid}</div>
                        <div style="font-size:1.5em; font-weight:bold; color:#f5bd00;">${tName}</div>
                        <div style="color:#666; font-size:0.8em;">Region: ${region.toUpperCase()}</div>
                    </div>
                `;
            } else {
                 out.innerHTML = `
                    <div style="background:#2e1a1a; padding:15px; border:1px solid #552222; margin-top:10px; color:#ff8a80;">
                        <strong>${name}</strong> exists, but is not assigned to a World Restructuring team in <strong>${region.toUpperCase()}</strong>.
                        <br><small>They might be in the other region or inactive.</small>
                    </div>
                `;
            }

        } catch(e) {
            out.innerHTML = `<div style="color:#ff5252">${e.message}</div>`;
        } finally {
            btn.disabled = false;
            btn.innerText = "Search";
        }
    }

    function forgetKey() {
        localStorage.removeItem(STORAGE_KEY);
        document.getElementById('apiKey').value = '';
        alert("Key forgotten.");
    }

    function renderRefList() {
        const div = document.getElementById('refList');
        const entries = Object.entries(TEAM_NAMES).map(([id, name]) => ({id, name}));
        entries.sort((a,b) => a.name.localeCompare(b.name));
        div.innerHTML = entries.map(t => `
            <div class="ref-card">
                <strong>${t.name}</strong>
                <small>${t.id} (${t.id.startsWith('11')?'NA':'EU'})</small>
            </div>
        `).join('');
    }
</script>

</body>
</html>