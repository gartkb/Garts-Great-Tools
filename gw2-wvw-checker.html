<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GW2 WvW Audit (Auto-Save)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, sans-serif; background: #1a1a1a; color: #ddd; padding: 40px; display: flex; flex-direction: column; align-items: center; }
        .container { background: #2a2a2a; padding: 25px; border-radius: 8px; width: 800px; max-width: 95%; box-shadow: 0 10px 25px rgba(0,0,0,0.5); margin-bottom: 30px; }
        h2 { text-align: center; color: #f5bd00; margin-top: 0; }
        
        .input-wrapper { margin-bottom: 20px; }
        .input-row { display: flex; gap: 10px; }
        input { flex: 1; padding: 12px; background: #333; border: 1px solid #444; color: white; border-radius: 4px; font-family: monospace; }
        button { padding: 12px 25px; background: #b71c1c; color: white; border: none; font-weight: bold; cursor: pointer; border-radius: 4px; }
        button:hover { background: #d32f2f; }
        button:disabled { background: #555; cursor: wait; }
        
        .saved-msg { font-size: 0.8em; color: #4caf50; margin-top: 5px; display: none; }
        .forget-link { font-size: 0.8em; color: #888; text-decoration: underline; cursor: pointer; margin-left: 5px; }
        .forget-link:hover { color: #ccc; }

        .info-header { background: #333; padding: 20px; border-left: 5px solid #f5bd00; margin-bottom: 25px; }
        .team-display { font-size: 1.4em; font-weight: bold; color: white; margin-bottom: 5px;}
        .meta-row { display: flex; justify-content: space-between; font-size: 0.9em; color: #aaa; border-top: 1px solid #444; padding-top: 10px; margin-top: 10px; }

        table { width: 100%; border-collapse: collapse; background: #252525; }
        th { text-align: left; color: #888; border-bottom: 2px solid #444; padding: 12px; font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; }
        td { border-bottom: 1px solid #333; padding: 15px 12px; vertical-align: middle; }
        
        .guild-name { font-weight: bold; font-size: 1.1em; color: #eee; }
        .tag { color: #f5bd00; font-family: monospace; font-weight: normal; margin-left: 5px; }
        .gid-small { font-size: 0.75em; color: #666; margin-top: 4px; font-family: monospace; }
        
        .row-selected { background: rgba(76, 175, 80, 0.15); border-left: 3px solid #4caf50; }
        .status-confirmed { color: #4caf50; font-weight: bold; font-size: 0.9em; margin-left: 5px; }
        .status-inactive { color: #888; font-style: italic; }
        .status-error { color: #ff5252; }
        .badge { background: #4caf50; color: white; font-size: 0.65em; padding: 3px 6px; border-radius: 3px; text-transform: uppercase; margin-left: 8px; vertical-align: middle; }
        .error-box { background: rgba(255, 82, 82, 0.1); border: 1px solid #ff5252; color: #ff8a80; padding: 15px; margin-top: 15px; }

        .teams-section { width: 800px; max-width: 95%; }
        .teams-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 10px; margin-top: 15px; }
        .team-card { background: #333; padding: 10px; border-radius: 4px; border: 1px solid #444; text-align: center; }
        .team-card strong { display: block; color: #f5bd00; margin-bottom: 3px; }
        .team-card small { color: #888; display: block;}
        .refresh-link { color: #aaa; text-decoration: underline; cursor: pointer; font-size: 0.9em; }
        .list-type-badge { background: #444; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; color: white; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2>GW2 WvW Audit</h2>
    
    <div class="input-wrapper">
        <div class="input-row">
            <input type="text" id="apiKey" placeholder="Paste your API Key here">
            <button onclick="auditGuilds()" id="btn">Audit Account</button>
        </div>
        <div style="margin-top:5px; display:flex; justify-content:space-between;">
            <span id="savedMsg" class="saved-msg">Key saved to browser storage.</span>
            <span class="forget-link" onclick="forgetKey()">Forget Key</span>
        </div>
    </div>

    <div id="output"></div>
</div>

<div class="teams-section">
    <div style="display:flex; justify-content:space-between; align-items:center;">
        <h3 style="margin:0;">Global Server List</h3>
        <span class="refresh-link" onclick="fetchGlobalTeams()">Force Refresh</span>
    </div>
    <div style="margin-top:10px; padding: 10px; background: #252525; border-radius: 4px;">
        Viewing: <span id="listType" class="list-type-badge">Loading...</span>
    </div>
    <div id="teamsList" class="teams-grid">
        <div style="color:#666; font-style:italic; padding:20px;">Waiting for scan...</div>
    </div>
</div>

<script>
    const API = 'https://api.guildwars2.com/v2';
    const STORAGE_KEY = 'gw2_audit_key';

    // --- STATIC TEAM DATA FROM WIKI ---
    // The API doesn't provide an endpoint to resolve names for these IDs yet, 
    // so we must use this hardcoded list from the wiki page.
    const TEAM_NAMES = {
        "11001": "Moogooloo", "11002": "Rall's Rest", "11003": "Domain of Torment", 
        "11004": "Yohlon Haven", "11005": "Tombs of Drascir", "11006": "Hall of Judgment", 
        "11007": "Throne of Balthazar", "11008": "Dwayna's Temple", "11009": "Abaddon's Prison", 
        "11010": "Cathedral of Blood", "11011": "Lutgardis Conservatory", "11012": "Mosswood",
        "12001": "Skrittsburgh", "12002": "Fortune's Vale", "12003": "Silent Woods", 
        "12004": "Ettin's Back", "12005": "Domain of Anguish", "12006": "Palawadan", 
        "12007": "Bloodstone Gulch", "12008": "Frost Citadel", "12009": "Dragrimmar", 
        "12010": "Grenth's Door", "12011": "Mirror of Lyssa", "12012": "Melandru's Dome", 
        "12013": "Kormir's Library", "12014": "Great House Aviary", "12015": "Bava Nisos"
    };

    // --- ON LOAD ---
    window.addEventListener('DOMContentLoaded', () => {
        const savedKey = localStorage.getItem(STORAGE_KEY);
        if(savedKey) {
            document.getElementById('apiKey').value = savedKey;
        }
        fetchGlobalTeams(); // Load the reference list at bottom
    });

    // --- HELPER: Save/Forget ---
    function saveKey(key) {
        localStorage.setItem(STORAGE_KEY, key);
        const msg = document.getElementById('savedMsg');
        msg.style.display = 'inline';
        setTimeout(() => { msg.style.display = 'none'; }, 3000);
    }

    function forgetKey() {
        localStorage.removeItem(STORAGE_KEY);
        document.getElementById('apiKey').value = '';
        alert("API Key removed from browser storage.");
    }

    // --- MAIN AUDIT FUNCTION ---
    async function auditGuilds() {
        const out = document.getElementById('output');
        const btn = document.getElementById('btn');
        let key = document.getElementById('apiKey').value.trim().replace(/[\s\n\r]+/g, '');

        if(key.length < 50) {
            out.innerHTML = `<div class="error-box">That doesn't look like a valid API key.</div>`;
            return;
        }

        saveKey(key);
        btn.disabled = true;
        btn.innerText = "Auditing...";
        out.innerHTML = "";

        try {
            // 1. Get Account Info
            const accRes = await fetch(`${API}/account?access_token=${key}`);
            if(!accRes.ok) throw new Error(`API Key Error: ${accRes.status}`);
            const acc = await accRes.json();
            
            const worldId = acc.world;
            const selectedGuildId = acc.wvw_guild;

            // 2. Determine Region (NA=1xxx, EU=2xxx) to pick the correct endpoint
            const region = (worldId < 2000) ? 'na' : 'eu';
            
            // 3. Fetch the massive WvW Guild Map for that region
            // This returns { "GUILD-GUID": "TEAM-ID", ... }
            const wvwMapRes = await fetch(`${API}/wvw/guilds/${region}`);
            let wvwMap = {};
            if(wvwMapRes.ok) {
                wvwMap = await wvwMapRes.json();
            } else {
                console.error("Could not fetch WvW Guild Map");
            }

            // 4. Get User's Guild Details
            const guildIds = acc.guilds || [];
            const guildPromises = guildIds.map(id => 
                fetch(`${API}/guild/${id}`).then(res => res.ok ? res.json() : null)
            );
            const guildsData = await Promise.all(guildPromises);

            // 5. Process Guilds: Check which team they are mapped to
            const processedGuilds = guildsData.map((g, index) => {
                if(!g) return { id: guildIds[index], name: "Unknown Guild", tag: "???", valid: false };
                
                // Lookup this guild's ID in the regional map
                const assignedTeamId = wvwMap[g.id]; 
                const assignedTeamName = TEAM_NAMES[assignedTeamId] || (assignedTeamId ? `Team ${assignedTeamId}` : null);

                return { 
                    ...g, 
                    valid: true,
                    assignedTeamId: assignedTeamId,
                    assignedTeamName: assignedTeamName
                };
            });

            // Sort: Selected guild first, then by name
            processedGuilds.sort((a,b) => (b.id === selectedGuildId) - (a.id === selectedGuildId));

            // 6. Render Rows
            let rows = processedGuilds.map(g => {
                const isSelected = (g.id === selectedGuildId);
                
                // Status Column Logic
                let statusHtml = '';
                if(g.assignedTeamId) {
                    statusHtml = `<span style="color:#ddd; font-weight:bold;">${g.assignedTeamName}</span>`;
                    if(isSelected) statusHtml += ` <span class="status-confirmed">(Active)</span>`;
                } else {
                    statusHtml = `<span class="status-inactive">Not assigned to a team</span>`;
                }

                return `
                    <tr class="${isSelected ? 'row-selected' : ''}">
                        <td>
                            <div class="guild-name">${g.name} <span class="tag">[${g.tag}]</span>
                            ${isSelected ? '<span class="badge">Active</span>' : ''}</div>
                            <div class="gid-small">${g.id}</div>
                        </td>
                        <td>${statusHtml}</td>
                    </tr>
                `;
            }).join('');

            // Determine Account's Effective Team
            let accountTeamName = "Unknown";
            if(selectedGuildId && wvwMap[selectedGuildId]) {
                accountTeamName = TEAM_NAMES[wvwMap[selectedGuildId]] || wvwMap[selectedGuildId];
            } else {
                accountTeamName = "Not Sorted (Check Selected Guild)";
            }

            out.innerHTML = `
                <div class="info-header">
                    <div style="font-size:0.9em; color:#aaa; margin-bottom:5px;">Region: ${region.toUpperCase()}</div>
                    <div class="team-display">${accountTeamName}</div>
                    <div style="font-size:0.9em; margin-bottom:10px;">
                        This is determined by your selected guild: <strong>${selectedGuildId || 'None'}</strong>
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>Guild</th>
                            <th>Assigned Team (World Restructuring)</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            `;

        } catch(err) {
            out.innerHTML = `<div class="error-box">Error: ${err.message}</div>`;
            console.error(err);
        } finally {
            btn.disabled = false;
            btn.innerText = "Audit Account";
        }
    }

    // --- GLOBAL TEAMS LIST (Bottom Reference) ---
    function fetchGlobalTeams() {
        const div = document.getElementById('teamsList');
        const badge = document.getElementById('listType');
        
        badge.innerText = "Static Wiki List";
        badge.style.background = "#2e7d32"; 

        // Just render our static list since API doesn't list them nicely yet
        // Convert object to array and sort
        const entries = Object.entries(TEAM_NAMES).map(([id, name]) => ({id, name}));
        entries.sort((a,b) => a.name.localeCompare(b.name));

        div.innerHTML = entries.map(t => `
            <div class="team-card">
                <strong>${t.name}</strong>
                <small>ID: ${t.id}</small>
                <small style="color:#555">${t.id.startsWith('11') ? 'NA' : 'EU'}</small>
            </div>
        `).join('');
    }
</script>

</body>
</html>