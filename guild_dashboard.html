<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GW2 Guild Dashboard</title>
    <style>
        /* --- CORE STYLES --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1400px; margin:0 auto; }
        
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }

        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:20px; display:flex; justify-content: center; align-items:center; gap:15px; flex-wrap: wrap; border: 1px solid rgba(52, 152, 219, 0.3); }
        button { padding:10px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { background: rgba(0,0,0,0.4); border: 1px solid rgba(52, 152, 219, 0.3); padding: 12px 25px; border-radius: 5px; color: #bdc3c7; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; min-width: 120px; text-align: center; }
        .nav-tab:hover { background: rgba(52, 152, 219, 0.1); color: white; border-color: #3498db; }
        .nav-tab.active { background: #3498db; color: white; border-color: #3498db; box-shadow: 0 0 15px rgba(52,152,219,0.4); }
        .nav-tab.debug-tab { border-color: #e74c3c; color: #e74c3c; }
        .nav-tab.debug-tab.active { background: #c0392b; color: white; border-color: #c0392b; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        .filter-bar { margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 5px; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-input { background: #2c3e50; color: white; border: 1px solid #3498db; padding: 6px 10px; border-radius: 4px; outline: none; }
        .filter-label { font-size: 0.9rem; color: #bdc3c7; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .guild-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .guild-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; height: 100%; min-height: 300px; }
        .guild-header { background: rgba(52, 152, 219, 0.15); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .guild-name { font-size: 1.3rem; font-weight: bold; color: #3498db; }
        .guild-tag { color: #f1c40f; font-weight: bold; margin-left: 8px; }
        .guild-body { padding: 15px; flex: 1; max-height: 600px; overflow-y: auto; position: relative; }

        .stash-section-title { color: #bdc3c7; font-size: 0.9rem; text-transform: uppercase; margin: 15px 0 5px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
        
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 8px; }
        
        .item-slot { background: rgba(0,0,0,0.3); border-radius: 4px; aspect-ratio: 1; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.1s; cursor: help; }
        .item-slot:hover { border-color: #3498db; background: rgba(52,152,219,0.2); z-index: 2; transform: scale(1.1); }
        .item-slot img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; }
        .item-count { position: absolute; bottom: 1px; right: 3px; font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; pointer-events: none; }
        .empty-slot { opacity: 0.1; }
        
        .item-slot.type-consumable { border-bottom: 3px solid #f1c40f; } 
        .item-slot.type-decoration { border-bottom: 3px solid #3498db; } 
        .item-slot.type-claimable { border-bottom: 3px solid #e74c3c; } 
        .item-slot.rarity-Ascended { border-color: #fb3985 !important; box-shadow: inset 0 0 8px #fb3985; }

        .item-slot.is-zero { opacity: 0.2; filter: grayscale(1); }
        .item-slot.is-zero .item-count { color: #bdc3c7; text-shadow: none; display: none; }

        /* GLOBAL TOOLTIP */
        #global-tooltip {
            position: fixed;
            background: rgba(10, 10, 15, 0.95);
            border: 1px solid #3498db;
            border-radius: 4px;
            padding: 12px;
            z-index: 9999;
            pointer-events: none;
            display: none;
            width: 300px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .tt-head { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tt-icon { width: 48px; height: 48px; border-radius: 4px; border: 1px solid #555; }
        .tt-title { flex: 1; }
        .tt-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .tt-type { color: #bdc3c7; font-size: 0.8rem; }
        .tt-desc { color: #bdc3c7; font-style: italic; margin-bottom: 8px; font-size: 0.85rem; }
        .tt-stats { color: #2ecc71; font-size: 0.85rem; white-space: pre-line; }
        .tt-rarity-Ascended .tt-name { color: #fb3985; }
        .tt-rarity-Exotic .tt-name { color: #f39c12; }
        .tt-rarity-Rare .tt-name { color: #f1c40f; }

        /* Debug */
        .debug-container { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 10px; }
        #debug-output { width: 100%; height: 400px; background: #000; color: #2ecc71; font-family: 'Consolas', monospace; padding: 10px; border: 1px solid #3498db; overflow: auto; white-space: pre-wrap; margin-top: 10px; }

        .loading { text-align: center; padding: 30px; color: #95a5a6; font-style: italic; }
        .error-box { padding: 15px; background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.3); color: #e74c3c; text-align: center; border-radius: 5px; margin-top: 20px; }
        
        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #2c3e50; border: 1px solid #3498db; border-radius: 8px; width: 95%; max-width: 600px; padding: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.7); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px; font-size: 1.2rem; color: #3498db; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #ecf0f1; cursor: pointer; }
        .api-list-item { background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .roster-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .roster-table th { text-align: left; border-bottom: 1px solid #3498db; padding: 5px; color: #3498db; position: sticky; top: 0; background: #2c3e50; }
        .roster-table td { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 6px 5px; }
    </style>
</head>
<body>

<div id="global-tooltip"></div>

<div class="container">
    <header>
        <h1>Guild Dashboard</h1>
        <div class="subtitle">Bank • Consumables • Roster • Logs</div>
    </header>

    <div class="controls">
        <button onclick="openModal('api-modal')">Manage API Keys</button>
        <button onclick="refreshData()">Refresh Data</button>
        <span id="status-msg" style="color: #f1c40f; font-size: 0.9rem;"></span>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="selectTab('stash')">Guild Vault</div>
        <div class="nav-tab" onclick="selectTab('consumables')">Consumables & Storage</div>
        <div class="nav-tab" onclick="selectTab('roster')">Roster</div>
        <div class="nav-tab" onclick="selectTab('log')">Guild Log</div>
        <div class="nav-tab debug-tab" onclick="selectTab('debug')">Debug</div>
    </div>

    <div id="tab-stash" class="tab-content active">
        <div id="stash-grid" class="guild-grid"></div>
    </div>

    <div id="tab-consumables" class="tab-content">
        <div class="filter-bar">
            <div class="filter-group">
                <input type="text" id="storage-search" class="filter-input" placeholder="Search names..." onkeyup="applyStorageFilter()">
            </div>
            <div class="filter-group">
                <select id="storage-filter" class="filter-input" onchange="applyStorageFilter()">
                    <option value="all">Show All Types</option>
                    <option value="Consumable">Consumables (All)</option>
                    <option value="AscendedFeast">Ascended Feasts</option>
                    <option value="Decoration">Decorations</option>
                    <option value="Claimable">WvW/Claimable</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">
                    <input type="checkbox" id="show-empty" onchange="applyStorageFilter()"> Show Empty
                </label>
            </div>
        </div>
        <div id="consumables-grid" class="guild-grid"></div>
    </div>

    <div id="tab-roster" class="tab-content">
        <div id="roster-grid" class="guild-grid"></div>
    </div>
    <div id="tab-log" class="tab-content">
        <div id="log-grid" class="guild-grid"></div>
    </div>

    <div id="tab-debug" class="tab-content">
        <div class="debug-container">
            <h3 style="color:#e74c3c; margin-bottom:10px;">Diagnostic Tools</h3>
            <div style="display:flex; gap:10px; margin-bottom:10px;">
                <button onclick="inspectStorage()">Inspect Storage Items</button>
                <button onclick="testItemLookup()">Test Item Lookup</button>
            </div>
            <textarea id="debug-output" readonly>Waiting...</textarea>
        </div>
    </div>
</div>

<!-- API MODAL -->
<div id="api-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span>API Configuration</span>
            <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
        </div>
        <div style="margin-bottom: 20px;">
            <p style="font-size: 0.85rem; color: #bdc3c7; margin-bottom: 8px;">
                Enter a GW2 API Key. <br>
                <strong>Required Scopes:</strong> <span style="color: #2ecc71; font-family: monospace;">account, guilds, inventories</span>
            </p>
            <div style="display: flex; gap: 10px;">
                <input type="text" id="api-key-input" placeholder="Paste key here..." style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #3498db; color: white; border-radius: 4px;">
                <button onclick="addKey()">Add</button>
            </div>
        </div>
        <div id="api-list"></div>
    </div>
</div>

<!-- ROSTER MODAL -->
<div id="roster-modal" class="modal-overlay">
    <div class="modal-content" style="max-width: 800px; height: 80vh;">
        <div class="modal-header">
            <span id="roster-title">Guild Roster</span>
            <button class="modal-close" onclick="closeModal('roster-modal')">&times;</button>
        </div>
        <div style="flex: 1; overflow-y: auto;" id="roster-body"></div>
    </div>
</div>

<script>
    let apiKeys = [];
    let guildData = {}; 
    let itemDetails = new Map();
    let upgradeDetails = new Map(); 
    let nameToIdMap = new Map();
    const GW2_API = 'https://api.guildwars2.com/v2';

    // Tooltip
    const tooltipEl = document.getElementById('global-tooltip');

    document.addEventListener('DOMContentLoaded', () => {
        const stored = localStorage.getItem('gw2_dash_keys');
        if(stored) try { apiKeys = JSON.parse(stored); } catch(e) {}
        renderKeyList();
        if(apiKeys.length > 0) refreshData();
    });

    // --- DIAGNOSTIC: ITEM LOOKUP ---
    async function testItemLookup() {
        const out = document.getElementById('debug-output');
        out.value = "--- Testing Item Lookup ---\n";
        
        // 1. Check if map is loaded
        out.value += `Name to ID Map Size: ${nameToIdMap.size}\n`;
        if(nameToIdMap.size === 0) {
            out.value += "ERROR: nameToIdMap is empty. 'items-names.json' likely failed to load.\n";
            return;
        }

        // 2. Test Sample Upgrade Names
        // These names come from your previous debug output
        const samples = [
            "Bowl of Fruit Salad with Mint Garnish",
            "Peppercorn-Crusted Sous-Vide Steak",
            "Peppered Cured Meat Flatbread",
            "Plate of Coq Au Vin with Salsa"
        ];

        const idsToFetch = [];

        samples.forEach(name => {
            const id = nameToIdMap.get(name);
            out.value += `Lookup "${name}": ${id ? "FOUND ID " + id : "NOT FOUND in JSON"}\n`;
            if(id) idsToFetch.push(id);
        });

        // 3. Fetch API Rarity for found IDs
        if(idsToFetch.length > 0) {
            out.value += `\nFetching API info for ${idsToFetch.join(',')}...\n`;
            try {
                const res = await fetch(`https://api.guildwars2.com/v2/items?ids=${idsToFetch.join(',')}`);
                const items = await res.json();
                items.forEach(i => {
                    out.value += `API ID ${i.id} (${i.name}) -> Rarity: ${i.rarity} | Type: ${i.type}\n`;
                });
            } catch(e) {
                out.value += `API Fetch Error: ${e.message}\n`;
            }
        }
        out.value += "--- End Test ---";
    }

    // --- DIAGNOSTIC: STORAGE ---
    async function inspectStorage() {
        const out = document.getElementById('debug-output');
        out.value = "Inspecting Storage (with merged metadata)...\n";
        Object.keys(guildData).forEach(gid => {
            const g = guildData[gid];
            out.value += `\n=== ${g.name} ===\n`;
            if(!g.storage) return;
            g.storage.forEach(s => {
                const u = upgradeDetails.get(s.id);
                // Merge logic from render to verify
                let rarity = 'Unknown';
                if(u && nameToIdMap.has(u.name)) {
                    const realId = nameToIdMap.get(u.name);
                    const realItem = itemDetails.get(realId);
                    if(realItem) rarity = realItem.rarity;
                }
                out.value += `[ID:${s.id}] Qty:${s.count} Name:${u?u.name:'Unknown'} Rarity:${rarity}\n`;
            });
        });
    }

    // --- GLOBAL TOOLTIP ---
    function showTooltip(e, data) {
        const { name, type, desc, stats, rarity, count, icon } = data;
        tooltipEl.innerHTML = `
            <div class="tt-head tt-rarity-${rarity}">
                <img src="${icon}" class="tt-icon">
                <div class="tt-title">
                    <div class="tt-name">${name}</div>
                    <div class="tt-type">${type} ${rarity ? '• '+rarity : ''}</div>
                </div>
            </div>
            <div class="tt-desc">${desc || ''}</div>
            ${stats ? `<div class="tt-stats">${stats}</div>` : ''}
            <div style="margin-top:5px;font-weight:bold;color:${count>0?'#2ecc71':'#7f8c8d'}">Count: ${count}</div>
        `;
        tooltipEl.style.display = 'block';
        moveTooltip(e);
    }

    function moveTooltip(e) {
        const w = tooltipEl.offsetWidth;
        const h = tooltipEl.offsetHeight;
        const pad = 15;
        let left = e.pageX + pad;
        let top = e.pageY + pad;
        if(left + w > window.innerWidth) left = e.pageX - w - pad;
        if(top + h > window.innerHeight + window.scrollY) top = e.pageY - h - pad;
        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
    }

    function hideTooltip() { tooltipEl.style.display = 'none'; }

    // --- DATA LOADING ---
    async function loadItemNames() {
        if(nameToIdMap.size > 0) return;
        updateStatus("Loading item index...");
        try {
            const res = await fetch('items-names.json');
            if(!res.ok) throw new Error("File missing");
            const json = await res.json();
            // json.items is [[id, name], [id, name]...]
            json.items.forEach(pair => {
                // We map Name -> ID
                nameToIdMap.set(pair[1], pair[0]);
            });
        } catch(e) {
            console.warn("JSON load failed", e);
        }
    }

    async function loadGlobalLibrary() {
        if(upgradeDetails.size > 500) return;
        updateStatus("Downloading global upgrade library...");
        try {
            const allIds = await fetch(`${GW2_API}/guild/upgrades`).then(r=>r.json());
            for(let i=0; i<allIds.length; i+=200) {
                const chunk = allIds.slice(i, i+200);
                const res = await fetch(`${GW2_API}/guild/upgrades?ids=${chunk.join(',')}`);
                const data = await res.json();
                data.forEach(u => {
                    upgradeDetails.set(u.id, {
                        name: u.name, icon: u.icon, description: u.description, type: u.type 
                    });
                });
                updateStatus(`Loading library... ${Math.min(i+200, allIds.length)}/${allIds.length}`);
            }
        } catch(e) { console.error(e); }
    }

    async function enrichLibraryWithStats() {
        updateStatus("Mapping upgrades to game items...");
        const itemIdsToFetch = new Set();
        const upgradeIdToItemId = new Map();

        // 1. Identify Matches
        upgradeDetails.forEach((u, uid) => {
            if(u.type === 'Consumable') {
                const itemId = nameToIdMap.get(u.name);
                if(itemId) {
                    itemIdsToFetch.add(itemId);
                    upgradeIdToItemId.set(uid, itemId);
                }
            }
        });

        // 2. Fetch Game Item Details
        if(itemIdsToFetch.size > 0) {
            updateStatus(`Fetching details for ${itemIdsToFetch.size} linked items...`);
            const arr = Array.from(itemIdsToFetch);
            for(let i=0; i<arr.length; i+=200) {
                const chunk = arr.slice(i, i+200);
                try {
                    const res = await fetch(`${GW2_API}/items?ids=${chunk.join(',')}`);
                    const items = await res.json();
                    items.forEach(item => {
                        // Parse stats from description or details
                        let stats = "";
                        if(item.details && item.details.description) stats = item.details.description;
                        else if(item.description) stats = item.description; // often contains stats for food

                        itemDetails.set(item.id, {
                            rarity: item.rarity,
                            stats: stats
                        });
                    });
                } catch(e) {}
            }

            // 3. Apply to Upgrades
            upgradeIdToItemId.forEach((itemId, upgradeId) => {
                const u = upgradeDetails.get(upgradeId);
                const i = itemDetails.get(itemId);
                if(u && i) {
                    u.rarity = i.rarity;
                    u.stats = i.stats; // Attach game stats
                }
            });
        }
    }

    // --- MAIN REFRESH ---
    async function refreshData() {
        guildData = {};
        await loadItemNames();
        await loadGlobalLibrary();
        await enrichLibraryWithStats();

        updateStatus('Discovering guilds...');
        const grids = ['stash-grid', 'consumables-grid', 'roster-grid', 'log-grid'];
        grids.forEach(id => document.getElementById(id).innerHTML = '<div class="loading">Loading guild data...</div>');

        const accessibleGuilds = []; 
        for(const cred of apiKeys) {
            try {
                const accRes = await fetch(`${GW2_API}/account?access_token=${cred.key}`);
                if(!accRes.ok) continue;
                const accInfo = await accRes.json();
                if(accInfo.guild_leader) {
                    accInfo.guild_leader.forEach(gid => {
                        if(!guildData[gid]) {
                            guildData[gid] = { id: gid, key: cred.key, name: 'Unknown', tag: '...' };
                            accessibleGuilds.push(gid);
                        }
                    });
                }
            } catch(e) {}
        }

        if(accessibleGuilds.length === 0) {
            updateStatus('');
            grids.forEach(id => document.getElementById(id).innerHTML = '<div class="error-box">No accessible guilds found.</div>');
            return;
        }

        updateStatus('Fetching specific guild data...');
        const itemIds = new Set();

        await Promise.all(accessibleGuilds.map(async (gid) => {
            const g = guildData[gid];
            const tokenStr = `?access_token=${g.key}`;
            try {
                const info = await fetch(`${GW2_API}/guild/${gid}${tokenStr}`).then(r=>r.json());
                g.name = info.name; g.tag = info.tag;

                try {
                    const stash = await fetch(`${GW2_API}/guild/${gid}/stash${tokenStr}`).then(r => { if(!r.ok) throw new Error(); return r.json(); });
                    g.stash = stash;
                    stash.forEach(tab => { if(tab.inventory) tab.inventory.forEach(i => { if(i) itemIds.add(i.id); }); });
                } catch(err) { g.stashError = true; }

                try {
                    g.storage = await fetch(`${GW2_API}/guild/${gid}/storage${tokenStr}`).then(r => r.ok ? r.json() : []);
                } catch(e) {}

                try { g.roster = await fetch(`${GW2_API}/guild/${gid}/members${tokenStr}`).then(r => r.ok ? r.json() : []); } catch(e) {}
                try { 
                    g.log = await fetch(`${GW2_API}/guild/${gid}/log${tokenStr}`).then(r => r.ok ? r.json() : []); 
                    g.log = g.log.slice(0, 50);
                    g.log.forEach(l => { if(l.item_id) itemIds.add(l.item_id); });
                } catch(e) {}
            } catch(e) {}
        }));

        if(itemIds.size > 0) {
            updateStatus('Resolving items...');
            const missing = Array.from(itemIds).filter(id => !itemDetails.has(id));
            if(missing.length > 0) {
                for(let i=0; i<missing.length; i+=200) {
                    const chunk = missing.slice(i, i+200);
                    try {
                        const res = await fetch(`${GW2_API}/items?ids=${chunk.join(',')}`);
                        const data = await res.json();
                        data.forEach(item => {
                            itemDetails.set(item.id, { name: item.name, icon: item.icon, rarity: item.rarity });
                        });
                    } catch(e){}
                }
            }
        }

        updateStatus('');
        renderAll();
    }

    function renderAll() {
        const grids = ['stash-grid', 'consumables-grid', 'roster-grid', 'log-grid'];
        grids.forEach(id => document.getElementById(id).innerHTML = '');
        Object.keys(guildData).forEach(gid => {
            const g = guildData[gid];
            renderStashCard(g);
            renderStorageCard(g);
            renderRosterCard(g);
            renderLogCard(g);
        });
        applyStorageFilter(); 
    }

    function renderStorageCard(g) {
        const ui = createCard(g, 'Storage');
        const grid = document.createElement('div');
        grid.className = 'item-grid'; 

        // Guild Inventory
        const guildCounts = new Map();
        if(g.storage) g.storage.forEach(s => guildCounts.set(s.id, s.count));

        // Iterate Global Library
        let cardItems = [];
        upgradeDetails.forEach((u, id) => {
            if(!['Consumable','Decoration','Claimable'].includes(u.type)) return;
            
            cardItems.push({
                id: id,
                name: u.name,
                icon: u.icon,
                type: u.type,
                desc: u.description, // Original guild description
                stats: u.stats, // Enriched stats from game item
                rarity: u.rarity || 'Basic',
                count: guildCounts.has(id) ? guildCounts.get(id) : 0
            });
        });

        cardItems.sort((a,b) => a.type.localeCompare(b.type) || a.name.localeCompare(b.name));

        cardItems.forEach(item => {
            const d = document.createElement('div');
            let classes = `item-slot storage-slot type-${item.type.toLowerCase()} rarity-${item.rarity}`;
            if(item.count === 0) classes += ' is-zero';
            
            d.className = classes;
            d.dataset.type = item.type;
            d.dataset.name = item.name.toLowerCase();
            d.dataset.count = item.count;
            d.dataset.rarity = item.rarity; 

            d.innerHTML = `<img src="${item.icon}"><div class="item-count">${item.count}</div>`;
            d.addEventListener('mousemove', (e) => showTooltip(e, item));
            d.addEventListener('mouseleave', hideTooltip);

            grid.appendChild(d);
        });

        ui.body.appendChild(grid);
        document.getElementById('consumables-grid').appendChild(ui.card);
    }

    function applyStorageFilter() {
        const search = document.getElementById('storage-search').value.toLowerCase();
        const filter = document.getElementById('storage-filter').value;
        const showEmpty = document.getElementById('show-empty').checked;
        
        document.querySelectorAll('.storage-slot').forEach(slot => {
            const type = slot.dataset.type; 
            const name = slot.dataset.name;
            const count = parseInt(slot.dataset.count);
            const rarity = slot.dataset.rarity;

            let visible = true;

            if(search && !name.includes(search)) visible = false;
            
            if(visible) {
                if(filter === 'AscendedFeast') {
                    if(rarity !== 'Ascended' || type !== 'Consumable') visible = false;
                } else if (filter !== 'all') {
                    if(type !== filter) visible = false;
                }
            }

            if(visible && !showEmpty && count === 0) visible = false;

            slot.style.display = visible ? 'block' : 'none';
        });
    }

    // --- BOILERPLATE ---
    function createCard(g, titleSuffix) {
        const div = document.createElement('div');
        div.className = 'guild-card';
        div.innerHTML = `
            <div class="guild-header">
                <div><span class="guild-name">${g.name}</span> <span class="guild-tag">[${g.tag}]</span></div>
                <div style="font-size:0.8rem; opacity:0.7">${titleSuffix}</div>
            </div>
            <div class="guild-body"></div>
        `;
        return { card: div, body: div.querySelector('.guild-body') };
    }

    function renderStashCard(g) {
        const ui = createCard(g, 'Vault');
        if(g.stashError) ui.body.innerHTML = '<div style="text-align:center;margin-top:20px;color:#e74c3c">Access Denied</div>';
        else if(!g.stash || !g.stash.length) ui.body.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d">Empty</div>';
        else {
            g.stash.forEach(tab => {
                const grid = document.createElement('div');
                grid.className = 'item-grid';
                const title = document.createElement('div');
                title.className = 'stash-section-title';
                let name = "Stash";
                if(tab.upgrade_id===58) name="Stash"; if(tab.upgrade_id===377) name="Trove"; if(tab.upgrade_id===59) name="Cave";
                title.innerText = `${name} (${tab.inventory.filter(x=>x).length})`;
                ui.body.appendChild(title);
                (tab.inventory||[]).forEach(slot => {
                    const d = document.createElement('div');
                    if(!slot) d.className = 'item-slot empty-slot';
                    else {
                        d.className = 'item-slot';
                        const info = itemDetails.get(slot.id) || {icon:''};
                        d.innerHTML = `<img src="${info.icon}"><div class="item-count">${slot.count}</div>`;
                    }
                    grid.appendChild(d);
                });
                ui.body.appendChild(grid);
            });
        }
        document.getElementById('stash-grid').appendChild(ui.card);
    }

    function renderRosterCard(g) {
        const ui = createCard(g, 'Roster');
        ui.body.innerHTML = `<div style="text-align:center;margin:20px 0;"><div style="font-size:2.5rem;color:#3498db;font-weight:bold;">${g.roster?g.roster.length:0}</div><div style="color:#bdc3c7">Members</div></div><button style="width:100%;margin-top:10px" onclick="openRoster('${g.id}')">View</button>`;
        document.getElementById('roster-grid').appendChild(ui.card);
    }

    function renderLogCard(g) {
        const ui = createCard(g, 'Log');
        const list = document.createElement('div');
        list.className = 'log-list';
        (g.log||[]).forEach(l => {
            const row = document.createElement('div');
            row.className = 'log-entry';
            let txt = `<span class="log-time">${new Date(l.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span> <span class="log-user">${l.user||''}</span> `;
            if(l.type==='stash'||l.type==='treasury') {
                const i = itemDetails.get(l.item_id);
                txt += `${l.operation||'deposit'} <span class="log-val">${l.count}x ${i?i.name:'Item '+l.item_id}</span>`;
            } else { txt += l.type; }
            row.innerHTML = txt;
            list.appendChild(row);
        });
        ui.body.appendChild(list);
        document.getElementById('log-grid').appendChild(ui.card);
    }

    function openRoster(gid) {
        const g = guildData[gid];
        document.getElementById('roster-title').innerText = `${g.name} Members`;
        let h = `<table class="roster-table"><thead><tr><th>Name</th><th>Rank</th><th>Joined</th></tr></thead><tbody>`;
        (g.roster||[]).sort((a,b)=>a.rank.localeCompare(b.rank)).forEach(m => {
            h += `<tr><td>${m.name}</td><td>${m.rank}</td><td>${new Date(m.joined).toLocaleDateString()}</td></tr>`;
        });
        h += `</tbody></table>`;
        document.getElementById('roster-body').innerHTML = h;
        openModal('roster-modal');
    }

    // --- UTILS ---
    function addKey() { 
        const v = document.getElementById('api-key-input').value.trim();
        if(v) { apiKeys.push({key:v}); localStorage.setItem('gw2_dash_keys',JSON.stringify(apiKeys)); renderKeyList(); refreshData(); } 
    }
    function removeKey(i) { 
        apiKeys.splice(i,1); localStorage.setItem('gw2_dash_keys',JSON.stringify(apiKeys)); renderKeyList(); refreshData(); 
    }
    function renderKeyList() { 
        document.getElementById('api-list').innerHTML = apiKeys.map((k,i)=>`<div class="api-list-item"><span style="font-family:monospace">${k.key.substr(0,10)}...</span><button style="background:#e74c3c;padding:5px" onclick="removeKey(${i})">Del</button></div>`).join(''); 
    }
    function selectTab(id) {
        document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        const idx=['stash','consumables','roster','log','debug'].indexOf(id);
        if(idx>-1) document.querySelectorAll('.nav-tab')[idx].classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
    }
    function updateStatus(m) { document.getElementById('status-msg').innerText = m; }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
</script>
</body>
</html>
