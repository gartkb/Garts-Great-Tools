<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GW2 Guild Dashboard</title>
    <style>
        /* --- CORE STYLES (Adapted from Reference) --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1400px; margin:0 auto; }
        
        /* Header */
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }

        /* Controls / API */
        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:20px; display:flex; justify-content: center; align-items:center; gap:15px; flex-wrap: wrap;}
        button { padding:10px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        button:disabled { background:#7f8c8d; cursor:not-allowed; transform:none; opacity: 0.7; }
        
        /* Navigation Tabs */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { background: rgba(0,0,0,0.4); border: 1px solid rgba(52, 152, 219, 0.3); padding: 12px 25px; border-radius: 5px; color: #bdc3c7; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; min-width: 120px; text-align: center; }
        .nav-tab:hover { background: rgba(52, 152, 219, 0.1); color: white; border-color: #3498db; }
        .nav-tab.active { background: #3498db; color: white; border-color: #3498db; box-shadow: 0 0 15px rgba(52,152,219,0.4); }

        /* Main Content Area */
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        /* Guild Grid Layout (Comparison View) */
        .guild-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        
        /* Guild Card */
        .guild-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; overflow: hidden; display: flex; flex-direction: column; height: 100%; }
        .guild-header { background: rgba(52, 152, 219, 0.15); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; }
        .guild-name { font-size: 1.3rem; font-weight: bold; color: #3498db; }
        .guild-tag { color: #f1c40f; font-weight: bold; margin-left: 8px; }
        .guild-body { padding: 15px; flex: 1; max-height: 600px; overflow-y: auto; }

        /* Inventory/Stash Styles */
        .stash-section-title { color: #bdc3c7; font-size: 0.9rem; text-transform: uppercase; margin: 15px 0 5px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 8px; }
        .item-slot { background: rgba(0,0,0,0.3); border-radius: 4px; aspect-ratio: 1; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.2s; }
        .item-slot:hover { transform: scale(1.1); z-index: 10; border-color: #3498db; background: rgba(52,152,219,0.2); }
        .item-slot img { width: 100%; height: 100%; object-fit: contain; border-radius: 4px; }
        .item-count { position: absolute; bottom: 1px; right: 3px; font-size: 0.75rem; font-weight: bold; color: white; text-shadow: 0 0 3px black; pointer-events: none; }
        .empty-slot { opacity: 0.1; }

        /* Consumables Styles */
        .consumable-row { display: flex; align-items: center; padding: 8px; background: rgba(255,255,255,0.05); margin-bottom: 5px; border-radius: 5px; }
        .consumable-icon { width: 32px; height: 32px; margin-right: 10px; border-radius: 3px; }
        .consumable-name { flex: 1; font-size: 0.95rem; }
        .consumable-count { font-weight: bold; color: #2ecc71; font-size: 1.1rem; }

        /* Roster Styles */
        .roster-stats { display: flex; justify-content: space-around; margin-bottom: 15px; }
        .stat-box { text-align: center; }
        .stat-val { font-size: 1.5rem; font-weight: bold; color: #3498db; }
        .stat-label { font-size: 0.8rem; color: #95a5a6; }
        
        /* Log Styles */
        .log-controls { display: flex; gap: 10px; margin-bottom: 10px; }
        .log-input { background: rgba(0,0,0,0.2); border: 1px solid #3498db; color: white; padding: 5px 10px; border-radius: 3px; flex: 1; }
        .log-list { display: flex; flex-direction: column; gap: 5px; font-size: 0.9rem; }
        .log-entry { padding: 8px; background: rgba(0,0,0,0.2); border-radius: 3px; border-left: 3px solid transparent; }
        .log-entry.type-stash { border-left-color: #f1c40f; }
        .log-entry.type-upgrade { border-left-color: #9b59b6; }
        .log-entry.type-treasury { border-left-color: #2ecc71; }
        .log-entry.type-motd { border-left-color: #e74c3c; }
        .log-time { color: #7f8c8d; font-size: 0.8rem; margin-right: 8px; }
        .log-user { color: #3498db; font-weight: bold; }
        .log-item { color: #bdc3c7; font-style: italic; }

        /* Loaders & Errors */
        .loading { text-align: center; padding: 40px; font-style: italic; color: #95a5a6; }
        .error-msg { background: rgba(231, 76, 60, 0.2); color: #e74c3c; padding: 15px; border-radius: 5px; text-align: center; margin: 10px 0; border: 1px solid rgba(231, 76, 60, 0.4); }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.8); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(3px); }
        .modal-content { background: #2c3e50; border: 1px solid #3498db; border-radius: 8px; width: 95%; max-width: 600px; padding: 20px; position: relative; box-shadow: 0 0 20px rgba(0,0,0,0.5); max-height: 90vh; display: flex; flex-direction: column; }
        .modal-header { font-size: 1.5rem; color: #3498db; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
        .modal-close { background: none; border: none; font-size: 1.5rem; cursor: pointer; color: #ecf0f1; padding: 0; }
        .modal-body { overflow-y: auto; flex: 1; }
        
        .api-list { margin-top: 15px; }
        .api-row { display: flex; justify-content: space-between; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 4px; margin-bottom: 5px; align-items: center; }
        
        /* Data Table */
        .data-table { width: 100%; border-collapse: collapse; font-size: 0.9rem; }
        .data-table th { text-align: left; padding: 8px; border-bottom: 1px solid #3498db; color: #3498db; position: sticky; top: 0; background: #2c3e50; }
        .data-table td { padding: 8px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .data-table tr:hover { background: rgba(255,255,255,0.05); }

        @media (max-width:768px) {
            .guild-grid { grid-template-columns: 1fr; }
            h1 { font-size: 1.8rem; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Guild Dashboard</h1>
            <p class="subtitle">Stash, Consumables, Roster & Logs</p>
        </header>

        <div class="controls">
            <button id="btn-manage-api">Manage API Keys</button>
            <button id="btn-refresh">Refresh Data</button>
            <span id="status-text" style="color: #bdc3c7; font-size: 0.9rem; font-style: italic;"></span>
        </div>

        <!-- Navigation -->
        <div class="nav-tabs">
            <div class="nav-tab active" onclick="switchTab('stash')">Guild Vault</div>
            <div class="nav-tab" onclick="switchTab('consumables')">Consumables</div>
            <div class="nav-tab" onclick="switchTab('roster')">Roster</div>
            <div class="nav-tab" onclick="switchTab('log')">Log</div>
        </div>

        <!-- Tabs Content -->
        <div id="tab-stash" class="tab-content active">
            <div id="stash-container" class="guild-grid"></div>
        </div>

        <div id="tab-consumables" class="tab-content">
            <div id="consumables-container" class="guild-grid"></div>
        </div>

        <div id="tab-roster" class="tab-content">
            <div id="roster-container" class="guild-grid"></div>
        </div>

        <div id="tab-log" class="tab-content">
            <div id="log-container" class="guild-grid"></div>
        </div>

    </div>

    <!-- API Modal -->
    <div id="api-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <span>Manage API Keys</span>
                <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
            </div>
            <div class="modal-body">
                <div style="display:flex; gap:10px; margin-bottom:15px;">
                    <input type="text" id="new-api-key" placeholder="Paste API Key (Scopes: guilds, inventories)" style="flex:1; padding:10px; border-radius:4px; border:1px solid #3498db; background:rgba(0,0,0,0.2); color:white;">
                    <button onclick="addApiKey()">Add</button>
                </div>
                <p style="font-size:0.8rem; color:#95a5a6; margin-bottom:10px;">
                    Note: You must be a Guild Leader or have specific in-game ranks to view Stash/Log via API.
                </p>
                <div id="api-key-list" class="api-list"></div>
            </div>
        </div>
    </div>

    <!-- Roster Detail Modal -->
    <div id="roster-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <span id="roster-modal-title">Guild Roster</span>
                <button class="modal-close" onclick="closeModal('roster-modal')">&times;</button>
            </div>
            <div class="modal-body" id="roster-modal-body">
                <!-- Table injected here -->
            </div>
        </div>
    </div>

    <script>
        // --- STATE MANAGEMENT ---
        let apiKeys = []; // { key, name }
        let guildDataCache = {}; // Map<GuildID, { details, stash, upgrades, roster, log, keyUsed }>
        let itemCache = new Map(); // ID -> { name, icon }
        
        // On Load
        document.addEventListener('DOMContentLoaded', () => {
            loadApiKeys();
            
            document.getElementById('btn-manage-api').onclick = () => openModal('api-modal');
            document.getElementById('btn-refresh').onclick = fetchAllData;
            
            if(apiKeys.length > 0) {
                fetchAllData();
            } else {
                updateStatus("Please add an API key to get started.");
            }
        });

        // --- TABS LOGIC ---
        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            // Highlight clicked tab button (hacky selector based on onclick text, strictly matching index would be cleaner but this works)
            const tabs = ['stash', 'consumables', 'roster', 'log'];
            document.querySelectorAll('.nav-tab')[tabs.indexOf(tabName)].classList.add('active');
            document.getElementById(`tab-${tabName}`).classList.add('active');
        }

        function openModal(id) { document.getElementById(id).style.display = 'flex'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }

        // --- API KEY LOGIC ---
        function loadApiKeys() {
            const stored = localStorage.getItem('gw2_dashboard_keys');
            if(stored) try { apiKeys = JSON.parse(stored); } catch(e){}
            renderApiList();
        }
        function saveApiKeys() {
            localStorage.setItem('gw2_dashboard_keys', JSON.stringify(apiKeys));
            renderApiList();
        }
        async function addApiKey() {
            const input = document.getElementById('new-api-key');
            const key = input.value.trim();
            if(!key) return;
            
            // Validate Key and get Account Name
            updateStatus("Validating key...");
            try {
                const res = await fetch(`https://api.guildwars2.com/v2/account?access_token=${key}`);
                if(!res.ok) throw new Error("Invalid Key");
                const data = await res.json();
                
                apiKeys.push({ key: key, name: data.name });
                saveApiKeys();
                input.value = '';
                fetchAllData();
            } catch(e) {
                alert("Error validating key: " + e.message);
            }
        }
        function removeApiKey(index) {
            if(confirm("Remove this key?")) {
                apiKeys.splice(index, 1);
                saveApiKeys();
                fetchAllData();
            }
        }
        function renderApiList() {
            const list = document.getElementById('api-key-list');
            list.innerHTML = '';
            apiKeys.forEach((k, i) => {
                const row = document.createElement('div');
                row.className = 'api-row';
                row.innerHTML = `
                    <div>
                        <div style="color:#3498db; font-weight:bold;">${k.name}</div>
                        <div style="font-size:0.7rem; font-family:monospace; color:#7f8c8d;">${k.key.substring(0,10)}...</div>
                    </div>
                    <button onclick="removeApiKey(${i})" style="background:#e74c3c; padding:5px 10px; font-size:0.8rem;">Remove</button>
                `;
                list.appendChild(row);
            });
        }

        // --- MAIN DATA FETCHING ---
        async function fetchAllData() {
            guildDataCache = {}; // Reset
            updateStatus("Discovering guilds...");
            
            const containers = ['stash-container', 'consumables-container', 'roster-container', 'log-container'];
            containers.forEach(id => document.getElementById(id).innerHTML = '<div class="loading">Loading...</div>');

            // 1. Discover Accessible Guilds
            const accessibleGuilds = []; // { guildId, key }
            
            for(const account of apiKeys) {
                try {
                    const accRes = await fetch(`https://api.guildwars2.com/v2/account?access_token=${account.key}`);
                    const accData = await accRes.json();
                    
                    // The API separates guilds you are in vs guilds you lead
                    // We'll try to fetch details for all guilds in the leader list first
                    // Note: For Stash access, usually leader is required, or specific rank. 
                    // We will just try to fetch endpoints; if 403, we handle it.
                    
                    if(accData.guild_leader) {
                        accData.guild_leader.forEach(gid => {
                            // Avoid duplicates if multiple keys have same guild
                            if(!accessibleGuilds.find(g => g.guildId === gid)) {
                                accessibleGuilds.push({ guildId: gid, key: account.key });
                            }
                        });
                    }
                } catch(e) { console.error(e); }
            }

            if(accessibleGuilds.length === 0) {
                updateStatus("No accessible guilds found (requires Guild Leader permissions).");
                containers.forEach(id => document.getElementById(id).innerHTML = '<div class="error-msg">No guilds found where you have Leader permissions.</div>');
                return;
            }

            updateStatus(`Fetching data for ${accessibleGuilds.length} guilds...`);

            // 2. Fetch Data per Guild
            const itemIdsToResolve = new Set();

            await Promise.all(accessibleGuilds.map(async (g) => {
                const base = `https://api.guildwars2.com/v2/guild/${g.guildId}`;
                const opts = { headers: { Authorization: `Bearer ${g.key}` } };
                
                // Initialize Cache Object
                guildDataCache[g.guildId] = { key: g.key, id: g.guildId };
                
                try {
                    // A. Basic Details
                    const details = await fetch(base).then(r => r.json());
                    guildDataCache[g.guildId].details = details;

                    // B. Stash (Might fail 403/400)
                    try {
                        const stash = await fetch(`${base}/stash`, opts).then(r => { if(!r.ok) throw new Error(r.status); return r.json(); });
                        guildDataCache[g.guildId].stash = stash;
                        // Collect IDs
                        stash.forEach(section => {
                            if(section.inventory) section.inventory.forEach(i => { if(i) itemIdsToResolve.add(i.id); });
                        });
                    } catch(e) { guildDataCache[g.guildId].stashError = true; }

                    // C. Upgrades (Consumables)
                    try {
                        const upgrades = await fetch(`${base}/upgrades`, opts).then(r => r.ok ? r.json() : []);
                        guildDataCache[g.guildId].upgrades = upgrades;
                        // Collect IDs
                        upgrades.forEach(u => itemIdsToResolve.add(u.item_id)); // Upgrades often have item_id
                        // Also need to resolve upgrade definitions to get icons
                        // For simplicity, we'll rely on static icons or fetch upgrade details separately if needed
                    } catch(e) {}

                    // D. Roster
                    try {
                        const roster = await fetch(`${base}/members`, opts).then(r => r.ok ? r.json() : []);
                        guildDataCache[g.guildId].roster = roster;
                    } catch(e) {}

                    // E. Log
                    try {
                        // Limit log to last 50 for performance
                        const log = await fetch(`${base}/log`, opts).then(r => r.ok ? r.json() : []);
                        guildDataCache[g.guildId].log = log.slice(0, 100); 
                        // Log items
                        log.forEach(l => { if(l.item_id) itemIdsToResolve.add(l.item_id); });
                    } catch(e) {}

                } catch(err) {
                    console.error(`Failed to load guild ${g.guildId}`, err);
                }
            }));

            // 3. Resolve Items
            if(itemIdsToResolve.size > 0) {
                updateStatus("Resolving item details...");
                await resolveItems([...itemIdsToResolve]);
            }

            // 4. Render
            updateStatus(`Data loaded. Last update: ${new Date().toLocaleTimeString()}`);
            renderAllTabs();
        }

        async function resolveItems(ids) {
            // Filter out IDs we already have
            const needed = ids.filter(id => !itemCache.has(id));
            if(needed.length === 0) return;

            // Chunk requests (max 200 per call)
            const chunkSize = 200;
            for (let i = 0; i < needed.length; i += chunkSize) {
                const chunk = needed.slice(i, i + chunkSize);
                try {
                    const res = await fetch(`https://api.guildwars2.com/v2/items?ids=${chunk.join(',')}`);
                    if(res.ok) {
                        const items = await res.json();
                        items.forEach(item => {
                            itemCache.set(item.id, { name: item.name, icon: item.icon, chat_link: item.chat_link });
                        });
                    }
                } catch(e) { console.error("Item fetch failed", e); }
            }
        }

        function updateStatus(msg) {
            document.getElementById('status-text').textContent = msg;
        }

        // --- RENDERING FUNCTIONS ---

        function renderAllTabs() {
            renderStash();
            renderConsumables();
            renderRoster();
            renderLog();
        }

        function createGuildCard(guildId, titleSuffix = "") {
            const data = guildDataCache[guildId];
            if(!data || !data.details) return null;
            
            const card = document.createElement('div');
            card.className = 'guild-card';
            
            const header = document.createElement('div');
            header.className = 'guild-header';
            header.innerHTML = `
                <div>
                    <span class="guild-name">${data.details.name}</span>
                    <span class="guild-tag">[${data.details.tag}]</span>
                </div>
                <div style="font-size:0.8rem; color:white; opacity:0.5">${titleSuffix}</div>
            `;
            
            const body = document.createElement('div');
            body.className = 'guild-body';
            
            card.appendChild(header);
            card.appendChild(body);
            return { card, body };
        }

        // 1. STASH TAB
        function renderStash() {
            const container = document.getElementById('stash-container');
            container.innerHTML = '';
            
            Object.keys(guildDataCache).forEach(gid => {
                const data = guildDataCache[gid];
                const ui = createGuildCard(gid, "Vault");
                if(!ui) return;

                if(data.stashError) {
                    ui.body.innerHTML = '<div class="error-msg">Access Denied. Missing "Guild Stash" permission or not Leader.</div>';
                } else if (data.stash && data.stash.length > 0) {
                    data.stash.forEach(section => {
                        // Header for Upgrade Type (Stash, Trove, Deep Cave)
                        const title = document.createElement('div');
                        title.className = 'stash-section-title';
                        // Map upgrade_id to name (rough mapping)
                        let name = "Storage";
                        if(section.upgrade_id === 58) name = "Guild Stash (50 slots)";
                        else if(section.upgrade_id === 377) name = "Treasure Trove (150 slots)";
                        else if(section.upgrade_id === 59) name = "Deep Cave (100 slots)";
                        
                        // Gold count if present
                        let coins = section.coins ? `<span style="color:#f1c40f">${Math.floor(section.coins/10000)}g</span>` : '';

                        title.innerHTML = `<span>${name}</span> ${coins}`;
                        ui.body.appendChild(title);

                        // Grid
                        const grid = document.createElement('div');
                        grid.className = 'item-grid';
                        
                        // Fill grid
                        const slots = section.inventory || [];
                        // Stash size depends on upgrade, but visual grid is nice.
                        // GW2 returns sparse array or array with nulls usually.
                        
                        slots.forEach(item => {
                            const slotDiv = document.createElement('div');
                            if(!item) {
                                slotDiv.className = 'item-slot empty-slot';
                            } else {
                                slotDiv.className = 'item-slot';
                                const itemInfo = itemCache.get(item.id) || { icon: '', name: 'Unknown' };
                                slotDiv.title = `${itemInfo.name} (x${item.count})`;
                                slotDiv.innerHTML = `
                                    <img src="${itemInfo.icon}" loading="lazy">
                                    <div class="item-count">${item.count}</div>
                                `;
                            }
                            grid.appendChild(slotDiv);
                        });
                        ui.body.appendChild(grid);
                    });
                } else {
                    ui.body.innerHTML = '<div class="loading">No stash data found.</div>';
                }
                
                container.appendChild(ui.card);
            });
        }

        // 2. CONSUMABLES TAB
        async function renderConsumables() {
            const container = document.getElementById('consumables-container');
            container.innerHTML = '';
            
            // We need upgrade definitions for icons if they aren't items.
            // But /v2/guild/:id/upgrades returns count and upgrade_id (and item_id if applicable).
            // We rely on item resolution done earlier.

            Object.keys(guildDataCache).forEach(gid => {
                const data = guildDataCache[gid];
                const ui = createGuildCard(gid, "Consumables");
                if(!ui) return;
                
                if(data.upgrades) {
                    // Filter for "Consumable" type ideally, but API just gives list of completed upgrades.
                    // We look for things with counts > 0 usually implies consumable (banners, food).
                    // However, the endpoint returns ALL active upgrades.
                    // We need to filter based on known IDs or logic.
                    // Hack: Items usually have `type: "Consumable"` in item definitions.
                    
                    // Let's filter data.upgrades where we resolved the item and it matches criteria,
                    // OR generic logic: usually consumables are the ones that deplete.
                    // The API object doesn't strictly say "type: consumable".
                    // We will list everything that has a specific Item ID associated? 
                    // Or better: Just list everything, user can see.
                    // Refined: Only show items, not permanent upgrades (Marketplace, etc).
                    
                    // Actually, /v2/guild/upgrades returns array of upgrade IDs.
                    // To get "Consumables" in the "Storage" sense (Banners/Food currently stored),
                    // We need to check specific upgrade IDs or cross reference item_id.
                    
                    // Let's fetch upgrade info if we want to be precise.
                    // For now, we assume anything with an Item ID in our itemCache is displayable.
                    
                    const consumables = data.upgrades.filter(u => {
                        // If we have an item ID for it, render it
                        return u.item_id && itemCache.has(u.item_id); 
                        // Note: Some Upgrades don't return item_id in the guild/upgrades endpoint?
                        // Actually they do if it's a queued consumable.
                    });

                    // Fetch Definitions for Upgrades to get icons/names
                    // This is heavy, so we might just use the item_id if present.

                    if(consumables.length === 0) {
                         ui.body.innerHTML = '<div style="text-align:center; color:#7f8c8d">No active consumables found.</div>';
                    } else {
                        consumables.forEach(u => {
                            const item = itemCache.get(u.item_id);
                            if(!item) return;
                            
                            // Only show if likely a consumable (Food, Banners, Schematics)
                            // GW2 API doesn't make "is this a consumable" easy without checking item type.
                            // We will display it.
                            
                            const row = document.createElement('div');
                            row.className = 'consumable-row';
                            row.innerHTML = `
                                <img src="${item.icon}" class="consumable-icon">
                                <div class="consumable-name">${item.name}</div>
                            `;
                            // Consumables in treasury/storage don't usually return a "count" in /upgrades 
                            // unless it's "in process". 
                            // WAIT: The "Guild Consumables" (Food/Banners) are technically upgrades 
                            // that you "slot" or "build".
                            // If the user meant "Materials for consumables", that's Stash.
                            // If they meant "Completed Banners ready to drop", that's barely supported by V2 API 
                            // except via checking active upgrades status.
                            
                            // The prompt asks for "Ascended food and banners".
                            // These are usually upgrades.
                            
                            ui.body.appendChild(row);
                        });
                    }
                }
                container.appendChild(ui.card);
            });
        }

        // 3. ROSTER TAB
        function renderRoster() {
            const container = document.getElementById('roster-container');
            container.innerHTML = '';

            Object.keys(guildDataCache).forEach(gid => {
                const data = guildDataCache[gid];
                const ui = createGuildCard(gid, "Roster");
                if(!ui) return;
                
                const members = data.roster || [];
                const online = members.filter(m => m.name); // API doesn't give online status directly reliably, just names
                
                // Stats
                ui.body.innerHTML = `
                    <div class="roster-stats">
                        <div class="stat-box">
                            <div class="stat-val">${members.length}</div>
                            <div class="stat-label">Members</div>
                        </div>
                    </div>
                    <div style="text-align:center">
                        <button onclick="showRosterDetail('${gid}')" style="width:100%">View Full Member List</button>
                    </div>
                `;
                container.appendChild(ui.card);
            });
        }

        function showRosterDetail(gid) {
            const data = guildDataCache[gid];
            const members = data.roster || [];
            const title = document.getElementById('roster-modal-title');
            const body = document.getElementById('roster-modal-body');
            
            title.textContent = `${data.details.name} [${data.details.tag}] - Members`;
            
            let html = `
                <div style="max-height:500px; overflow-y:auto;">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Account Name</th>
                            <th>Rank</th>
                            <th>Joined</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Sort by Rank then Name
            members.sort((a, b) => a.rank.localeCompare(b.rank) || a.name.localeCompare(b.name));
            
            members.forEach(m => {
                const date = new Date(m.joined).toLocaleDateString();
                html += `<tr>
                    <td style="font-weight:bold; color:#ecf0f1;">${m.name}</td>
                    <td>${m.rank}</td>
                    <td style="color:#95a5a6;">${date}</td>
                </tr>`;
            });
            
            html += `</tbody></table></div>`;
            body.innerHTML = html;
            openModal('roster-modal');
        }

        // 4. LOG TAB
        function renderLog() {
            const container = document.getElementById('log-container');
            container.innerHTML = '';

            Object.keys(guildDataCache).forEach(gid => {
                const data = guildDataCache[gid];
                const ui = createGuildCard(gid, "Recent Activity");
                if(!ui) return;

                const logs = data.log || [];
                
                // Log Controls
                const controlDiv = document.createElement('div');
                controlDiv.className = 'log-controls';
                const input = document.createElement('input');
                input.className = 'log-input';
                input.placeholder = "Search logs...";
                input.onkeyup = (e) => filterLogs(gid, e.target.value);
                controlDiv.appendChild(input);
                
                ui.body.appendChild(controlDiv);

                // Log List Container
                const listDiv = document.createElement('div');
                listDiv.id = `log-list-${gid}`;
                listDiv.className = 'log-list';
                
                logs.forEach(l => {
                    const el = createLogEntryElement(l);
                    listDiv.appendChild(el);
                });
                
                if(logs.length === 0) listDiv.innerHTML = '<div style="color:#7f8c8d; text-align:center">No logs available or access denied.</div>';

                ui.body.appendChild(listDiv);
                container.appendChild(ui.card);
            });
        }

        function createLogEntryElement(l) {
            const div = document.createElement('div');
            div.className = `log-entry type-${l.type}`;
            
            const time = new Date(l.time).toLocaleString();
            let msg = `<span class="log-time">[${time}]</span> `;
            
            // Construct message based on type
            if(l.user) msg += `<span class="log-user">${l.user}</span> `;
            
            switch(l.type) {
                case 'stash':
                    const item = itemCache.get(l.item_id) || {name: `Item ${l.item_id}`};
                    msg += `${l.operation} <span class="log-item">${l.count}x ${item.name}</span>`;
                    if(l.coins) msg += ` & ${formatMoney(l.coins)}`;
                    break;
                case 'treasury':
                    const tItem = itemCache.get(l.item_id) || {name: `Item ${l.item_id}`};
                    msg += `deposited <span class="log-item">${l.count}x ${tItem.name}</span> into Treasury`;
                    break;
                case 'upgrade':
                    msg += `${l.action} upgrade <span class="log-item">${l.upgrade_id}</span>`; // Upgrade names require another lookup, simplified here
                    break;
                case 'motd':
                    msg += `updated MOTD: "${l.motd}"`;
                    break;
                case 'joined':
                    msg += `joined the guild.`;
                    break;
                case 'invited':
                    msg += `invited ${l.invited_by ? `(by ${l.invited_by})` : ''}`;
                    break;
                case 'kick':
                    msg += `was kicked by ${l.kicked_by}`;
                    break;
                case 'rank_change':
                    msg += `changed rank of ${l.user} from ${l.old_rank} to ${l.new_rank}`;
                    break;
                default:
                    msg += `performed ${l.type}`;
            }
            
            div.innerHTML = msg;
            div.dataset.text = div.textContent.toLowerCase();
            return div;
        }

        function filterLogs(gid, query) {
            const list = document.getElementById(`log-list-${gid}`);
            const q = query.toLowerCase();
            Array.from(list.children).forEach(child => {
                if(child.dataset.text && child.dataset.text.includes(q)) {
                    child.style.display = 'block';
                } else {
                    child.style.display = 'none';
                }
            });
        }

        function formatMoney(coins) {
            const g = Math.floor(coins/10000);
            const s = Math.floor((coins%10000)/100);
            const c = coins%100;
            return `${g}g ${s}s ${c}c`;
        }

    </script>
</body>
</html>
