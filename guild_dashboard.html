<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>GW2 Guild Dashboard</title>
    <style>
        /* --- CORE STYLES --- */
        * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        body { background: linear-gradient(135deg,#1a2a6c,#2c3e50); color:#ecf0f1; padding:20px; min-height:100vh; }
        .container { max-width:1400px; margin:0 auto; }
        
        header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:2px solid #3498db; }
        h1 { font-size:2.5rem; color:#3498db; margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
        .subtitle { color:#bdc3c7; font-size:1.1rem; }

        .controls { background:rgba(0,0,0,0.3); padding:20px; border-radius:10px; margin-bottom:20px; display:flex; justify-content: center; align-items:center; gap:15px; flex-wrap: wrap; border: 1px solid rgba(52, 152, 219, 0.3); }
        button { padding:10px 20px; background:#3498db; color:white; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:all .3s; white-space:nowrap; }
        button:hover:not(:disabled) { background:#2980b9; transform:translateY(-2px); }
        
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .nav-tab { background: rgba(0,0,0,0.4); border: 1px solid rgba(52, 152, 219, 0.3); padding: 12px 25px; border-radius: 5px; color: #bdc3c7; cursor: pointer; font-size: 1.1rem; transition: all 0.2s; min-width: 120px; text-align: center; }
        .nav-tab:hover { background: rgba(52, 152, 219, 0.1); color: white; border-color: #3498db; }
        .nav-tab.active { background: #3498db; color: white; border-color: #3498db; box-shadow: 0 0 15px rgba(52,152,219,0.4); }
        .nav-tab.debug-tab { border-color: #e74c3c; color: #e74c3c; }
        .nav-tab.debug-tab.active { background: #c0392b; color: white; border-color: #c0392b; }

        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity:0; transform: translateY(10px); } to { opacity:1; transform: translateY(0); } }

        .filter-bar { margin-bottom: 15px; display: flex; flex-wrap: wrap; justify-content: flex-end; align-items: center; gap: 15px; background: rgba(0,0,0,0.2); padding: 10px 15px; border-radius: 5px; }
        .filter-group { display: flex; align-items: center; gap: 8px; }
        .filter-input { background: #2c3e50; color: white; border: 1px solid #3498db; padding: 6px 10px; border-radius: 4px; outline: none; }
        .filter-label { font-size: 0.9rem; color: #bdc3c7; cursor: pointer; display: flex; align-items: center; gap: 5px; }

        .guild-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .guild-card { background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.1); border-radius: 10px; overflow: visible; display: flex; flex-direction: column; height: 100%; min-height: 300px; }
        .guild-header { background: rgba(52, 152, 219, 0.15); padding: 15px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; align-items: center; border-radius: 10px 10px 0 0; }
        .guild-name { font-size: 1.3rem; font-weight: bold; color: #3498db; }
        .guild-tag { color: #f1c40f; font-weight: bold; margin-left: 8px; }
        .guild-body { padding: 15px; flex: 1; max-height: 600px; overflow-y: auto; position: relative; }

        .stash-section-title { color: #bdc3c7; font-size: 0.9rem; text-transform: uppercase; margin: 15px 0 5px 0; padding-bottom: 5px; border-bottom: 1px solid rgba(255,255,255,0.1); display: flex; justify-content: space-between; }
        
        .item-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(48px, 1fr)); gap: 8px; }
        
        .item-slot { background: rgba(0,0,0,0.3); border-radius: 4px; aspect-ratio: 1; position: relative; border: 1px solid rgba(255,255,255,0.05); transition: transform 0.1s; cursor: help; }
        .item-slot:hover { border-color: #3498db; background: rgba(52,152,219,0.2); z-index: 10; transform: scale(1.1); }
        .item-slot img { width: 100%; height: 100%; object-fit: contain; border-radius: 3px; }
        .item-count { position: absolute; bottom: 1px; right: 3px; font-size: 0.8rem; font-weight: bold; color: white; text-shadow: 1px 1px 0 #000, -1px -1px 0 #000, 1px -1px 0 #000, -1px 1px 0 #000; pointer-events: none; }
        .empty-slot { opacity: 0.1; }
        
        .item-slot.type-consumable { border-bottom: 3px solid #f1c40f; } 
        .item-slot.type-decoration { border-bottom: 3px solid #3498db; } 
        .item-slot.type-claimable { border-bottom: 3px solid #e74c3c; } 
        
        /* Rarity Borders */
        .item-slot.rarity-Ascended { border-color: #fb3985 !important; box-shadow: inset 0 0 8px #fb3985; }
        .item-slot.rarity-Exotic { border-color: #f39c12 !important; }
        .item-slot.rarity-Rare { border-color: #f1c40f !important; }

        .item-slot.is-zero { opacity: 0.2; filter: grayscale(1); }
        .item-slot.is-zero .item-count { display: none; }

        /* --- ROSTER TABLE STYLES --- */
        .roster-container { background: rgba(0,0,0,0.3); border-radius: 10px; padding: 15px; height: 100%; display: flex; flex-direction: column; }
        .roster-table { width: 100%; border-collapse: collapse; font-size: 0.95rem; }
        .roster-table th { text-align: left; border-bottom: 2px solid #3498db; padding: 10px; color: #3498db; background: rgba(44, 62, 80, 0.9); position: sticky; top: 0; z-index: 5; cursor: pointer; user-select: none; }
        .roster-table th:hover { color: #fff; background: #3498db; }
        .roster-table td { border-bottom: 1px solid rgba(255,255,255,0.05); padding: 8px 10px; color: #ecf0f1; }
        .roster-table tr:hover td { background: rgba(52, 152, 219, 0.1); }
        .sort-icon { font-size: 0.8em; margin-left: 5px; opacity: 0.5; }
        .rank-badge { display: inline-block; padding: 2px 6px; border-radius: 3px; font-size: 0.85em; background: rgba(255,255,255,0.05); }

        /* --- GLOBAL TOOLTIP --- */
        #global-tooltip {
            position: fixed;
            background: rgba(15, 15, 20, 0.98);
            border: 1px solid #3498db;
            border-radius: 4px;
            padding: 12px;
            z-index: 9999;
            pointer-events: none;
            display: none;
            width: 320px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.8);
            font-size: 0.9rem;
            line-height: 1.4;
        }
        .tt-head { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 8px; padding-bottom: 8px; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .tt-icon { width: 48px; height: 48px; border-radius: 4px; border: 1px solid #555; }
        .tt-title { flex: 1; }
        .tt-name { font-weight: bold; color: #fff; font-size: 1rem; }
        .tt-type { color: #bdc3c7; font-size: 0.8rem; }
        .tt-desc { color: #bdc3c7; font-style: italic; margin-bottom: 8px; font-size: 0.85rem; }
        .tt-stats { color: #2ecc71; font-size: 0.85rem; white-space: pre-line; margin-bottom: 5px; }
        .tt-rarity-Ascended .tt-name { color: #fb3985; }
        .tt-rarity-Exotic .tt-name { color: #f39c12; }
        .tt-rarity-Rare .tt-name { color: #f1c40f; }
        
        .debug-container { background: rgba(0,0,0,0.4); padding: 20px; border-radius: 10px; }
        #debug-output { width: 100%; height: 400px; background: #000; color: #2ecc71; font-family: 'Consolas', monospace; padding: 10px; border: 1px solid #3498db; overflow: auto; white-space: pre-wrap; margin-top: 10px; }

        .loading { text-align: center; padding: 30px; color: #95a5a6; font-style: italic; }
        .error-box { padding: 15px; background: rgba(231, 76, 60, 0.15); border: 1px solid rgba(231, 76, 60, 0.3); color: #e74c3c; text-align: center; border-radius: 5px; margin-top: 20px; }
        
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.85); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
        .modal-content { background: #2c3e50; border: 1px solid #3498db; border-radius: 8px; width: 95%; max-width: 600px; padding: 20px; box-shadow: 0 0 25px rgba(0,0,0,0.7); display: flex; flex-direction: column; max-height: 90vh; }
        .modal-header { display: flex; justify-content: space-between; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 15px; margin-bottom: 15px; font-size: 1.2rem; color: #3498db; }
        .modal-close { background: none; border: none; font-size: 1.5rem; color: #ecf0f1; cursor: pointer; }
        .api-list-item { background: rgba(0,0,0,0.2); padding: 10px; margin-bottom: 8px; border-radius: 4px; display: flex; justify-content: space-between; align-items: center; }
        .guild-list-item { background: rgba(0,0,0,0.2); padding: 8px 12px; margin-bottom: 8px; border-radius: 4px; display: flex; align-items: center; gap: 10px; border: 1px solid rgba(255,255,255,0.05); }
        .guild-list-item:hover { background: rgba(255,255,255,0.05); }
    </style>
</head>
<body>

<div id="global-tooltip"></div>

<div class="container">
    <header>
        <h1>Guild Dashboard</h1>
        <div class="subtitle">Bank • Consumables • Roster • Logs</div>
    </header>

    <div class="controls">
        <button onclick="openModal('api-modal')">Manage API</button>
        <button onclick="refreshData()">Refresh Data</button>
        <button onclick="clearCache()" style="background:#e67e22;font-size:0.8rem">Reset Cache</button>
        <span id="status-msg" style="color: #f1c40f; font-size: 0.9rem;"></span>
    </div>

    <div class="nav-tabs">
        <div class="nav-tab active" onclick="selectTab('stash')">Guild Vault</div>
        <div class="nav-tab" onclick="selectTab('consumables')">Consumables & Storage</div>
        <div class="nav-tab" onclick="selectTab('roster')">Roster</div>
        <div class="nav-tab" onclick="selectTab('log')">Guild Log</div>
        <div class="nav-tab debug-tab" onclick="selectTab('debug')">Debug</div>
    </div>

    <div id="tab-stash" class="tab-content active">
        <div class="filter-bar">
            <div class="filter-group">
                <input type="text" id="stash-search" class="filter-input" placeholder="Search stash items..." onkeyup="applyStashFilter()">
            </div>
            <div class="filter-group">
                <label class="filter-label" style="font-size:0.8rem; opacity:0.7;">
                    (Hides empty slots when searching)
                </label>
            </div>
        </div>
        <div id="stash-grid" class="guild-grid"></div>
    </div>

    <div id="tab-consumables" class="tab-content">
        <div class="filter-bar">
            <div class="filter-group">
                <input type="text" id="storage-search" class="filter-input" placeholder="Search names..." onkeyup="applyStorageFilter()">
            </div>
            <div class="filter-group">
                <select id="storage-filter" class="filter-input" onchange="applyStorageFilter()">
                    <option value="all">Show All Types</option>
                    <option value="Consumable">Consumables (All)</option>
                    <option value="AscendedFeast">Ascended Feasts</option>
                    <option value="Decoration">Decorations</option>
                    <option value="Claimable">WvW/Claimable</option>
                </select>
            </div>
            <div class="filter-group">
                <label class="filter-label">
                    <input type="checkbox" id="show-empty" onchange="applyStorageFilter()"> Show Empty
                </label>
            </div>
        </div>
        <div id="consumables-grid" class="guild-grid"></div>
    </div>

    <!-- ROSTER TAB -->
    <div id="tab-roster" class="tab-content">
        <div class="filter-bar">
             <div class="filter-group">
                <input type="text" id="roster-search" class="filter-input" placeholder="Search members..." onkeyup="applyRosterFilter()">
            </div>
            <div class="filter-group" style="color:#bdc3c7; font-size:0.9rem;">
                <span id="roster-total-count">0</span> Members found
            </div>
        </div>
        <div id="roster-grid" class="guild-grid" style="grid-template-columns: 1fr;"></div>
    </div>

    <div id="tab-log" class="tab-content">
        <div id="log-grid" class="guild-grid"></div>
    </div>

    <div id="tab-debug" class="tab-content">
        <div class="debug-container">
            <h3 style="color:#e74c3c; margin-bottom:10px;">Data Inspector</h3>
            <button onclick="inspectStorage()">Inspect Storage Items</button>
            <textarea id="debug-output" readonly>Waiting...</textarea>
        </div>
    </div>
</div>

<!-- API MODAL -->
<div id="api-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <span>API Configuration</span>
            <button class="modal-close" onclick="closeModal('api-modal')">&times;</button>
        </div>
        
        <!-- Keys Section -->
        <div style="margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 20px;">
            <h4 style="color:#3498db; margin-bottom:10px;">API Keys</h4>
            <p style="font-size: 0.85rem; color: #bdc3c7; margin-bottom: 8px;">
                Enter a GW2 API Key. <br>
                <strong>Required Scopes:</strong> <span style="color: #2ecc71; font-family: monospace;">account, guilds, inventories</span>
            </p>
            <div style="display: flex; gap: 10px; margin-bottom:10px;">
                <input type="text" id="api-key-input" placeholder="Paste key here..." style="flex: 1; padding: 10px; background: rgba(0,0,0,0.3); border: 1px solid #3498db; color: white; border-radius: 4px;">
                <button onclick="addKey()">Add Key</button>
            </div>
            <div id="api-list"></div>
        </div>

        <!-- Guild Selection Section -->
        <div style="flex: 1; overflow-y: auto;">
            <h4 style="color:#3498db; margin-bottom:10px;">Guild Visibility</h4>
            <p style="font-size: 0.85rem; color: #bdc3c7; margin-bottom: 8px;">
                Uncheck guilds to hide them from the dashboard.
            </p>
            <div id="guild-selection-list">
                <div style="text-align:center; color:#7f8c8d; font-style:italic; padding:10px;">
                    No guilds found. Add keys and refresh data.
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    let apiKeys = [];
    let guildData = {}; 
    let itemDetails = new Map(); // Cache for fetched Item API data
    let upgradeDetails = new Map(); // Cache for Guild Upgrade API data
    let nameToIdsMap = new Map(); 
    
    let disabledGuilds = new Set();
    let allDiscoveredGuilds = []; 
    
    // Global sort state for rosters
    let rosterSortState = { column: 'rank', asc: true };

    const GW2_API = 'https://api.guildwars2.com/v2';
    const JSON_URL = 'https://gartkb.github.io/Garts-Great-Tools/gw2-items.json';

    const tooltipEl = document.getElementById('global-tooltip');

    document.addEventListener('DOMContentLoaded', () => {
        const storedKeys = localStorage.getItem('gw2_dash_keys');
        if(storedKeys) try { apiKeys = JSON.parse(storedKeys); } catch(e) {}
        
        const storedDisabled = localStorage.getItem('gw2_dash_disabled_guilds');
        if(storedDisabled) try { disabledGuilds = new Set(JSON.parse(storedDisabled)); } catch(e) {}

        loadCache();
        renderKeyList();
        if(apiKeys.length > 0) refreshData();
    });

    // --- HELPERS (Ascended stats, Cache, Tooltip) ---
    // ... (Keeping these standard helpers from previous version) ...

    function getAscendedStats(name) {
        const baseBuffs = "+10% Karma\n+5% All Experience Gained\n+20% Magic Find\n+20% Gold Find\n+10% WXP Gained";
        let stats = "";
        let effect = "";
        const n = name.toLowerCase();

        if (n.includes("peppercorn") || n.includes("peppered")) effect = "-10% Incoming Damage";
        else if (n.includes("cilantro"))  effect = "66% Chance to Steal Life on Critical Hit";
        else if (n.includes("sesame"))    effect = "Gain Health on Kill";
        else if (n.includes("mint"))      effect = "+10% Outgoing Healing";
        else if (n.includes("clove"))     effect = "-20% Incoming Condition Duration";
        else if (n.includes("salsa"))     effect = "+20% Condition Duration";

        if (n.includes("steak"))            stats = "+100 Power\n+70 Ferocity";
        else if (n.includes("coq au vin"))  stats = "+100 Power\n+70 Precision";
        else if (n.includes("carpaccio"))   stats = "+100 Concentration\n+70 Power";
        else if (n.includes("aspic"))       stats = "+100 Concentration\n+70 Toughness";
        else if (n.includes("fruit salad")) stats = "+100 Healing Power\n+70 Concentration";
        else if (n.includes("creme") || n.includes("crème")) stats = "+100 Concentration\n+70 Healing Power"; 
        else if (n.includes("benedict"))    stats = "+100 Concentration\n+70 Expertise";
        else if (n.includes("ravioli"))     stats = "+100 Vitality\n+70 Toughness";
        else if (n.includes("oyster") || n.includes("spherified")) stats = "+45 to All Attributes"; 
        else if (n.includes("cheesecake"))  stats = "+100 Concentration\n+33% Chance to Gain Might on Critical Hit";
        else if (n.includes("veggie flatbread")) stats = "+100 Expertise\n+70 Condition Damage";
        else if (n.includes("flatbread"))        stats = "+100 Condition Damage\n+70 Expertise"; 

        let parts = [];
        if (effect) parts.push(effect);
        if (stats) parts.push(stats);
        
        if (parts.length === 0) return null;
        return `Nourishment (1h):\n${parts.join('\n')}\n${baseBuffs}`;
    }

    function loadCache() {
        const cached = localStorage.getItem('gw2_item_cache');
        if(cached) {
            try { JSON.parse(cached).forEach(e => itemDetails.set(Number(e[0]), e[1])); } catch(e){}
        }
    }
    function saveCache() {
        try { localStorage.setItem('gw2_item_cache', JSON.stringify(Array.from(itemDetails.entries()))); } catch(e){}
    }
    function clearCache() {
        localStorage.removeItem('gw2_item_cache');
        itemDetails.clear();
        alert("Cache cleared. Refreshing...");
        location.reload();
    }

    function showTooltip(e, data) {
        let { name, type, desc, stats, rarity, count, icon } = data;
        if(rarity === 'Ascended' && type === 'Consumable') {
            const ascendedDetails = getAscendedStats(name);
            if(ascendedDetails) { stats = ascendedDetails; desc = ""; }
        }
        if(stats && stats.includes("Double-click to serve")) {
            if(!desc) desc = stats;
            stats = ""; 
        }
        if (stats && desc && stats.trim() === desc.trim()) desc = "";

        tooltipEl.innerHTML = `
            <div class="tt-head tt-rarity-${rarity}">
                <img src="${icon}" class="tt-icon">
                <div class="tt-title">
                    <div class="tt-name">${name}</div>
                    <div class="tt-type">${type} ${rarity ? '• '+rarity : ''}</div>
                </div>
            </div>
            ${stats ? `<div class="tt-stats">${stats}</div>` : ''}
            ${desc ? `<div class="tt-desc">${desc}</div>` : ''}
            <div style="margin-top:5px;font-weight:bold;color:${count>0?'#2ecc71':'#7f8c8d'}">Count: ${count}</div>
        `;
        tooltipEl.style.display = 'block';
        moveTooltip(e);
    }

    function moveTooltip(e) {
        if(tooltipEl.style.display === 'none') return;
        const w = tooltipEl.offsetWidth;
        const h = tooltipEl.offsetHeight;
        const pad = 15;
        let left = e.pageX + pad;
        if(left + w > window.innerWidth) left = e.pageX - w - pad;
        let top = e.pageY + pad;
        if(top + h > window.innerHeight + window.scrollY) top = e.pageY - h - pad;
        tooltipEl.style.left = left + 'px';
        tooltipEl.style.top = top + 'px';
    }

    function hideTooltip() { tooltipEl.style.display = 'none'; }

    // --- DATA LOADING ---

    async function loadItemNameMap() {
        if(nameToIdsMap.size > 0) return;
        try {
            updateStatus("Downloading Item Database...");
            const res = await fetch(JSON_URL);
            if(!res.ok) throw new Error("Failed to load JSON");
            const json = await res.json();
            json.items.forEach(pair => {
                nameToIdsMap.set(String(pair[1]).trim().toLowerCase(), [Number(pair[0])]); // Simplified for existing logic
            });
        } catch(e) { console.error("JSON Error", e); }
    }

    async function loadGlobalLibrary() {
        if(upgradeDetails.size > 500) return;
        updateStatus("Downloading global upgrade library...");
        try {
            const allIds = await fetch(`${GW2_API}/guild/upgrades`).then(r=>r.json());
            for(let i=0; i<allIds.length; i+=200) {
                const chunk = allIds.slice(i, i+200);
                const res = await fetch(`${GW2_API}/guild/upgrades?ids=${chunk.join(',')}`);
                const data = await res.json();
                data.forEach(u => {
                    upgradeDetails.set(u.id, {
                        name: u.name, 
                        icon: u.icon, 
                        description: u.description, 
                        type: u.type 
                    });
                });
                updateStatus(`Loading library... ${Math.min(i+200, allIds.length)}/${allIds.length}`);
            }
        } catch(e) {}
    }

    async function enrichLibraryWithStats() {
        updateStatus("Linking Upgrades to Game Items...");
        const itemIdsToFetch = new Set();
        const upgradeCandidates = new Map();

        upgradeDetails.forEach((u, uid) => {
            if(['Consumable', 'Decoration', 'Claimable'].includes(u.type)) {
                const normName = u.name.trim().toLowerCase();
                const possibleIds = nameToIdsMap.get(normName);
                
                if(possibleIds && possibleIds.length > 0) {
                    upgradeCandidates.set(uid, possibleIds);
                    possibleIds.forEach(pid => {
                        if(!itemDetails.has(pid)) itemIdsToFetch.add(pid);
                    });
                }
            }
        });

        if(itemIdsToFetch.size > 0) {
            updateStatus(`Fetching stats for ${itemIdsToFetch.size} possible items...`);
            const arr = Array.from(itemIdsToFetch);
            for(let i=0; i<arr.length; i+=200) {
                const chunk = arr.slice(i, i+200);
                try {
                    const res = await fetch(`${GW2_API}/items?ids=${chunk.join(',')}`);
                    const items = await res.json();
                    items.forEach(item => {
                        itemDetails.set(item.id, {
                            rarity: item.rarity,
                            desc: item.description,
                            details: item.details,
                            type: item.type
                        });
                    });
                } catch(e) {}
            }
            saveCache();
        }

        upgradeCandidates.forEach((candidates, upgradeId) => {
            const u = upgradeDetails.get(upgradeId);
            let bestMatch = null;
            candidates.forEach(cid => {
                const item = itemDetails.get(cid);
                if(!item) return;
                if(!bestMatch) {
                    bestMatch = item;
                } else {
                    if(item.rarity === 'Ascended' && bestMatch.rarity !== 'Ascended') bestMatch = item;
                    else if(item.rarity === bestMatch.rarity && item.type === 'Consumable' && bestMatch.type !== 'Consumable') bestMatch = item;
                }
            });
            if(bestMatch) {
                u.rarity = bestMatch.rarity;
                if(bestMatch.desc) u.stats = bestMatch.desc; 
                if(bestMatch.details && bestMatch.details.description) {
                    u.stats = (u.stats ? u.stats + "\n" : "") + bestMatch.details.description;
                }
            }
        });
        renderAll();
    }

    // --- MAIN ---
    async function refreshData() {
        guildData = {};
        allDiscoveredGuilds = []; 
        
        await loadItemNameMap();
        await loadGlobalLibrary();
        await fetchGuildData();
        
        renderAll(); 
        enrichLibraryWithStats().then(() => { updateStatus(''); renderAll(); });
    }

    async function fetchGuildData() {
        const potentialGuilds = new Map(); 

        for(const cred of apiKeys) {
            try {
                const accRes = await fetch(`${GW2_API}/account?access_token=${cred.key}`);
                if(!accRes.ok) continue;
                const accInfo = await accRes.json();
                if(accInfo.guild_leader) {
                    accInfo.guild_leader.forEach(gid => {
                        if(!potentialGuilds.has(gid)) {
                            potentialGuilds.set(gid, { id: gid, key: cred.key, name: 'Loading...', tag: '...' });
                        }
                    });
                }
            } catch(e) {}
        }

        if(potentialGuilds.size === 0) {
            document.getElementById('stash-grid').innerHTML = '<div class="error-box">No accessible guilds found.</div>';
            renderGuildSelectionList();
            return;
        }

        const guildIds = Array.from(potentialGuilds.keys());
        await Promise.all(guildIds.map(async (gid) => {
            const g = potentialGuilds.get(gid);
            const tokenStr = `?access_token=${g.key}`;
            try {
                const info = await fetch(`${GW2_API}/guild/${gid}${tokenStr}`).then(r=>r.json());
                g.name = info.name;
                g.tag = info.tag;
            } catch(e) {
                g.name = "Unknown Guild";
            }
        }));

        allDiscoveredGuilds = Array.from(potentialGuilds.values());
        renderGuildSelectionList();

        const activeGuildIds = guildIds.filter(gid => !disabledGuilds.has(gid));

        if(activeGuildIds.length === 0) {
             document.getElementById('stash-grid').innerHTML = '<div class="error-box">All guilds are hidden. Enable them in "Manage API".</div>';
             return;
        }

        await Promise.all(activeGuildIds.map(async (gid) => {
            guildData[gid] = potentialGuilds.get(gid);
            const g = guildData[gid];
            const tokenStr = `?access_token=${g.key}`;

            try {
                // 1. Fetch Stash
                try {
                    const stash = await fetch(`${GW2_API}/guild/${gid}/stash${tokenStr}`).then(r => { if(!r.ok) throw new Error(); return r.json(); });
                    g.stash = stash;
                } catch(err) { g.stashError = true; }
                
                // 2. Fetch Storage
                try {
                    g.storage = await fetch(`${GW2_API}/guild/${gid}/storage${tokenStr}`).then(r => r.ok ? r.json() : []);
                } catch(e) {}
                
                // 3. Fetch Roster
                try { 
                    g.roster = await fetch(`${GW2_API}/guild/${gid}/members${tokenStr}`).then(r => r.ok ? r.json() : []); 
                } catch(e) {}
                
                // 4. Fetch Ranks (NEW - For Sorting)
                try {
                     const ranks = await fetch(`${GW2_API}/guild/${gid}/ranks${tokenStr}`).then(r => r.ok ? r.json() : []);
                     // Create simple map: { "Leader": 1, "Member": 5 } etc.
                     g.rankMap = {};
                     ranks.forEach(r => {
                         g.rankMap[r.id] = r.order;
                     });
                } catch(e) {
                    g.rankMap = {}; // Fallback
                }

                // 5. Fetch Log
                try { 
                    g.log = await fetch(`${GW2_API}/guild/${gid}/log${tokenStr}`).then(r => r.ok ? r.json() : []); 
                    g.log = g.log.slice(0, 50);
                } catch(e) {}
            } catch(e) {}
        }));
    }

    // --- UI RENDERING ---

    function renderGuildSelectionList() {
        const container = document.getElementById('guild-selection-list');
        if(allDiscoveredGuilds.length === 0) {
            container.innerHTML = '<div style="text-align:center; color:#7f8c8d; padding:10px;">No guilds found yet.</div>';
            return;
        }
        container.innerHTML = allDiscoveredGuilds.map(g => {
            const isChecked = !disabledGuilds.has(g.id);
            return `
            <div class="guild-list-item">
                <input type="checkbox" id="cb-${g.id}" ${isChecked ? 'checked' : ''} onchange="toggleGuild('${g.id}')" style="cursor:pointer; transform:scale(1.2)">
                <label for="cb-${g.id}" style="flex:1; cursor:pointer; color:#ecf0f1;">
                    <span style="font-weight:bold; color:#3498db;">[${g.tag}]</span> ${g.name}
                </label>
            </div>`;
        }).join('');
    }

    function toggleGuild(gid) {
        if(disabledGuilds.has(gid)) disabledGuilds.delete(gid);
        else disabledGuilds.add(gid);
        localStorage.setItem('gw2_dash_disabled_guilds', JSON.stringify(Array.from(disabledGuilds)));
        refreshData();
    }

    function renderAll() {
        const grids = ['stash-grid', 'consumables-grid', 'roster-grid', 'log-grid'];
        grids.forEach(id => document.getElementById(id).innerHTML = '');
        const activeGIDs = Object.keys(guildData);
        if(activeGIDs.length === 0 && allDiscoveredGuilds.length > 0) return;
        activeGIDs.forEach(gid => {
            const g = guildData[gid];
            renderStashCard(g);
            renderStorageCard(g);
            renderRosterCard(g);
            renderLogCard(g);
        });
        applyStorageFilter();
        applyStashFilter();
        applyRosterFilter();
    }

    function renderStorageCard(g) {
        const ui = createCard(g, 'Storage');
        const grid = document.createElement('div');
        grid.className = 'item-grid'; 
        const currentItemsMap = new Map();
        if(g.storage) g.storage.forEach(s => currentItemsMap.set(s.id, s.count));

        let cardItems = [];
        upgradeDetails.forEach((u, id) => {
            if(!['Consumable', 'Decoration', 'Claimable'].includes(u.type)) return;
            cardItems.push({
                id: id, name: u.name, icon: u.icon, type: u.type,
                desc: u.description, stats: u.stats || '', rarity: u.rarity || '',
                count: currentItemsMap.has(id) ? currentItemsMap.get(id) : 0
            });
        });
        cardItems.sort((a,b) => a.type.localeCompare(b.type) || a.name.localeCompare(b.name));
        cardItems.forEach(item => {
            const d = document.createElement('div');
            let classes = `item-slot storage-slot type-${item.type.toLowerCase()} rarity-${item.rarity}`;
            if(item.count === 0) classes += ' is-zero';
            d.className = classes;
            d.dataset.type = item.type;
            d.dataset.name = item.name.toLowerCase();
            d.dataset.count = item.count;
            d.dataset.rarity = item.rarity; 
            d.innerHTML = `<img src="${item.icon}"><div class="item-count">${item.count}</div>`;
            d.addEventListener('mousemove', (e) => showTooltip(e, item));
            d.addEventListener('mouseleave', hideTooltip);
            grid.appendChild(d);
        });
        ui.body.appendChild(grid);
        document.getElementById('consumables-grid').appendChild(ui.card);
    }

    function applyStorageFilter() {
        const search = document.getElementById('storage-search').value.toLowerCase();
        const filter = document.getElementById('storage-filter').value;
        const showEmpty = document.getElementById('show-empty').checked;
        document.querySelectorAll('.storage-slot').forEach(slot => {
            const type = slot.dataset.type; 
            const name = slot.dataset.name; 
            const count = parseInt(slot.dataset.count);
            const rarity = slot.dataset.rarity; 
            let visible = true;
            if(search && !name.includes(search)) visible = false;
            if(visible) {
                if(filter === 'AscendedFeast') {
                    if(type !== 'Consumable') visible = false;
                    else if(rarity !== 'Ascended' && !name.includes('feast')) visible = false;
                } else if(filter !== 'all') {
                    if(type !== filter) visible = false;
                }
            }
            if(visible && !showEmpty && count === 0) visible = false;
            slot.style.display = visible ? 'block' : 'none';
        });
    }

    // --- Roster Sorting & Filtering Logic ---
    
    function renderRosterCard(g) {
        const ui = createCard(g, 'Roster');
        if(!g.roster || g.roster.length === 0) {
            ui.body.innerHTML = `<div style="padding:20px; text-align:center; color:#7f8c8d;">No roster data available</div>`;
        } else {
            const container = document.createElement('div');
            container.className = 'roster-container';
            
            container.innerHTML = `
            <div style="flex:1; overflow:auto;">
                <table class="roster-table" id="rt-${g.id}">
                    <thead>
                        <tr>
                            <th onclick="sortRoster('${g.id}', 'name')">Name <span class="sort-icon">⇅</span></th>
                            <th onclick="sortRoster('${g.id}', 'rank')">Rank <span class="sort-icon">⇅</span></th>
                            <th onclick="sortRoster('${g.id}', 'joined')">Joined <span class="sort-icon">⇅</span></th>
                        </tr>
                    </thead>
                    <tbody class="roster-body">
                        ${generateRosterRows(g.roster)}
                    </tbody>
                </table>
            </div>
            <div style="margin-top:10px; font-size:0.85rem; color:#7f8c8d; text-align:right;">
                Total: <span class="roster-count">${g.roster.length}</span>
            </div>
            `;
            ui.body.appendChild(container);
            ui.body.style.padding = '0'; 
            ui.body.style.overflow = 'hidden'; 
        }
        
        document.getElementById('roster-grid').appendChild(ui.card);
        
        // Use 'rank' as initial sort to leverage the new order logic
        sortRoster(g.id, rosterSortState.column, false);
    }

    function generateRosterRows(members) {
        return members.map(m => `
            <tr class="roster-row" data-name="${m.name.toLowerCase()}" data-rank="${m.rank.toLowerCase()}">
                <td style="font-weight:bold; color:#ecf0f1;">${m.name}</td>
                <td style="color:#3498db;"><span class="rank-badge">${m.rank}</span></td>
                <td style="color:#bdc3c7;">${new Date(m.joined).toLocaleDateString()}</td>
            </tr>
        `).join('');
    }

    function sortRoster(gid, column, toggle = true) {
        if(toggle) {
            if(rosterSortState.column === column) {
                rosterSortState.asc = !rosterSortState.asc;
            } else {
                rosterSortState.column = column;
                rosterSortState.asc = true;
            }
        }
        
        const g = guildData[gid];
        if(!g || !g.roster) return;

        g.roster.sort((a, b) => {
            let valA = a[column];
            let valB = b[column];
            
            // CUSTOM RANK SORTING LOGIC
            if(column === 'rank' && g.rankMap) {
                // Lower number = Higher Rank (usually). 
                // We retrieve the order ID from our map. Default to 999 if not found.
                valA = g.rankMap[a.rank] || 999;
                valB = g.rankMap[b.rank] || 999;
            } 
            else if(column === 'joined') {
                valA = new Date(valA).getTime();
                valB = new Date(valB).getTime();
            } else {
                valA = String(valA).toLowerCase();
                valB = String(valB).toLowerCase();
            }
            
            if(valA < valB) return rosterSortState.asc ? -1 : 1;
            if(valA > valB) return rosterSortState.asc ? 1 : -1;
            return 0;
        });

        const table = document.querySelector(`#rt-${gid} .roster-body`);
        if(table) {
            table.innerHTML = generateRosterRows(g.roster);
            applyRosterFilter();
        }
    }

    function applyRosterFilter() {
        const search = document.getElementById('roster-search').value.toLowerCase().trim();
        let totalVisible = 0;

        document.querySelectorAll('.roster-row').forEach(row => {
            const name = row.dataset.name;
            const rank = row.dataset.rank;
            
            if(search === '' || name.includes(search) || rank.includes(search)) {
                row.style.display = '';
                totalVisible++;
            } else {
                row.style.display = 'none';
            }
        });

        document.getElementById('roster-total-count').innerText = totalVisible;
    }

    function createCard(g, titleSuffix) {
        const div = document.createElement('div');
        div.className = 'guild-card';
        div.innerHTML = `<div class="guild-header"><div><span class="guild-name">${g.name}</span> <span class="guild-tag">[${g.tag}]</span></div><div style="font-size:0.8rem; opacity:0.7">${titleSuffix}</div></div><div class="guild-body"></div>`;
        return { card: div, body: div.querySelector('.guild-body') };
    }

    function renderStashCard(g) {
        const ui = createCard(g, 'Vault');
        if(g.stashError) ui.body.innerHTML = '<div style="text-align:center;margin-top:20px;color:#e74c3c">Access Denied</div>';
        else if(!g.stash || !g.stash.length) ui.body.innerHTML = '<div style="text-align:center;padding:20px;color:#7f8c8d">Empty</div>';
        else {
            g.stash.forEach(tab => {
                const grid = document.createElement('div');
                grid.className = 'item-grid';
                const title = document.createElement('div');
                title.className = 'stash-section-title';
                let name = "Stash";
                if(tab.upgrade_id===58) name="Stash"; if(tab.upgrade_id===377) name="Trove"; if(tab.upgrade_id===59) name="Cave";
                
                const inventory = tab.inventory || [];
                title.innerText = `${name} (${inventory.filter(x=>x).length})`;
                
                ui.body.appendChild(title);
                inventory.forEach(slot => {
                    const d = document.createElement('div');
                    if(!slot) {
                        d.className = 'item-slot empty-slot';
                    } else {
                        d.className = 'item-slot';
                        const info = itemDetails.get(slot.id) || {icon:'', name: 'Loading...'};
                        d.innerHTML = `<img src="${info.icon || 'https://render.guildwars2.com/file/0000000000000000000000000000000000000000/1.png'}"><div class="item-count">${slot.count}</div>`;
                        d.title = `${info.name} (x${slot.count})`;
                        if(info.name) d.dataset.name = info.name.toLowerCase();
                        fetchItemIcon(slot.id, d); 
                    }
                    grid.appendChild(d);
                });
                ui.body.appendChild(grid);
            });
        }
        document.getElementById('stash-grid').appendChild(ui.card);
    }
    
    async function fetchItemIcon(id, el) {
        if(itemDetails.has(id)) {
            const data = itemDetails.get(id);
            el.innerHTML = `<img src="${data.icon}"><div class="item-count">${el.innerText}</div>`;
            el.title = data.name;
            if(data.name) el.dataset.name = data.name.toLowerCase();
            return;
        }
        try {
            const res = await fetch(`${GW2_API}/items/${id}`);
            const data = await res.json();
            itemDetails.set(id, {name: data.name, icon: data.icon, rarity: data.rarity}); 
            el.innerHTML = `<img src="${data.icon}"><div class="item-count">${el.innerText}</div>`;
            el.title = data.name;
            if(data.name) el.dataset.name = data.name.toLowerCase();
            const searchInput = document.getElementById('stash-search');
            if(searchInput && searchInput.value) applyStashFilter();
        } catch(e){}
    }

    function applyStashFilter() {
        const searchInput = document.getElementById('stash-search');
        if(!searchInput) return;
        const search = searchInput.value.toLowerCase().trim();
        const slots = document.querySelectorAll('#stash-grid .item-slot');
        slots.forEach(slot => {
            if(search === '') { slot.style.display = ''; return; }
            if(slot.classList.contains('empty-slot')) { slot.style.display = 'none'; } 
            else {
                const name = slot.dataset.name || '';
                slot.style.display = name.includes(search) ? 'block' : 'none';
            }
        });
    }

    function renderLogCard(g) {
        const ui = createCard(g, 'Log');
        const list = document.createElement('div');
        list.className = 'log-list';
        (g.log||[]).forEach(l => {
            const row = document.createElement('div');
            row.className = 'log-entry';
            let txt = `<span class="log-time">${new Date(l.time).toLocaleTimeString([],{hour:'2-digit',minute:'2-digit'})}</span> <span class="log-user">${l.user||''}</span> `;
            if(l.type==='stash'||l.type==='treasury') {
                txt += `${l.operation||'deposit'} <span class="log-val">${l.count}x (Item ${l.item_id})</span>`;
            } else { txt += l.type; }
            row.innerHTML = txt;
            list.appendChild(row);
        });
        ui.body.appendChild(list);
        document.getElementById('log-grid').appendChild(ui.card);
    }

    function addKey() { 
        const v = document.getElementById('api-key-input').value.trim();
        if(v) { apiKeys.push({key:v}); localStorage.setItem('gw2_dash_keys',JSON.stringify(apiKeys)); renderKeyList(); refreshData(); } 
    }
    function removeKey(i) { 
        apiKeys.splice(i,1); localStorage.setItem('gw2_dash_keys',JSON.stringify(apiKeys)); renderKeyList(); refreshData(); 
    }
    function renderKeyList() { 
        document.getElementById('api-list').innerHTML = apiKeys.map((k,i)=>`<div class="api-list-item"><span style="font-family:monospace">${k.key.substr(0,10)}...</span><button style="background:#e74c3c;padding:5px" onclick="removeKey(${i})">Del</button></div>`).join(''); 
    }
    function selectTab(id) {
        document.querySelectorAll('.nav-tab').forEach(e=>e.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(e=>e.classList.remove('active'));
        const idx=['stash','consumables','roster','log','debug'].indexOf(id);
        if(idx>-1) document.querySelectorAll('.nav-tab')[idx].classList.add('active');
        document.getElementById(`tab-${id}`).classList.add('active');
    }
    function updateStatus(m) { document.getElementById('status-msg').innerText = m; }
    function openModal(id) { document.getElementById(id).style.display = 'flex'; }
    function closeModal(id) { document.getElementById(id).style.display = 'none'; }
    
    async function inspectStorage() {
        const out = document.getElementById('debug-output');
        out.value = "Inspecting...\n";
        out.value += `Name Map Size: ${nameToIdsMap.size}\n`;
        Object.keys(guildData).forEach(gid => {
            const g = guildData[gid];
            out.value += `\n=== ${g.name} ===\n`;
            if(!g.storage) return;
            g.storage.forEach(s => {
                const u = upgradeDetails.get(s.id);
                out.value += `[ID:${s.id}] Qty:${s.count} Name:${u?u.name:'Unknown'} Rarity:${u?u.rarity:'Unknown'}\n`;
            });
        });
    }
</script>
</body>
</html>
