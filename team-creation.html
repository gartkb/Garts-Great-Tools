<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GW2 Team Builder V7</title>
  
  <style>
    /* --- CORE STYLES --- */
    :root {
      --bg-gradient: linear-gradient(135deg, #1a2a6c, #2c3e50);
      --glass-dark: rgba(0, 0, 0, 0.4);
      --glass-lighter: rgba(0, 0, 0, 0.2);
      --accent-blue: #3498db;
      --accent-hover: #2980b9;
      --accent-red: #e74c3c;
      --border-color: rgba(52, 152, 219, 0.3);
      --text-main: #ecf0f1;
      --text-muted: #bdc3c7;
      --card-bg: #2a3b4c;
    }

    * { margin:0; padding:0; box-sizing:border-box; font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
    
    body { 
      background: var(--bg-gradient); 
      color: var(--text-main); 
      padding: 20px; 
      min-height: 100vh; 
    }

    .container { max-width: 1600px; margin: 0 auto; }
    
    header { text-align:center; padding:20px 0; margin-bottom:30px; border-bottom:1px solid var(--border-color); }
    h1 { font-size:2.5rem; color:var(--accent-blue); margin-bottom:10px; text-shadow:0 0 10px rgba(52,152,219,0.5); }
    
    /* --- CONTROLS --- */
    .controls-area {
      background: var(--glass-dark);
      padding: 20px;
      border-radius: 10px;
      margin-bottom: 20px;
      border: 1px solid var(--border-color);
      display: flex; flex-direction: column; gap: 15px;
    }
    
    .roster-actions {
      display: flex; gap: 10px; flex-wrap: wrap; align-items: center;
      padding-bottom: 15px; border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    textarea {
      width: 100%; height: 120px;
      background: rgba(0,0,0,0.3); border: 1px solid var(--border-color);
      color: #fff; padding: 10px; border-radius: 5px;
      resize: vertical; font-family: monospace; font-size: 0.9em;
    }
    textarea:focus { outline: none; border-color: var(--accent-blue); background: rgba(0,0,0,0.5); }

    input[type="text"], select {
      background: rgba(0,0,0,0.3); border: 1px solid #555;
      color: white; padding: 8px 12px; border-radius: 4px;
    }

    button { 
      padding:10px 20px; background:var(--accent-blue); color:white; border:none; border-radius:5px; 
      cursor:pointer; font-weight:bold; transition:all .3s; 
      display: inline-flex; align-items: center; gap: 5px;
    }
    button:hover { background:var(--accent-hover); transform:translateY(-2px); }
    button.btn-danger { background: var(--accent-red); }
    button.btn-danger:hover { background: #c0392b; }

    /* --- LAYOUT --- */
    .builder-layout {
      display: grid; grid-template-columns: 380px 1fr; gap: 20px; align-items: start;
    }
    @media (max-width: 1100px) { .builder-layout { grid-template-columns: 1fr; } }

    /* --- BENCH (SCROLLABLE & STICKY UPDATES) --- */
    .bench-panel {
      background: var(--glass-dark); 
      border: 1px solid var(--border-color);
      border-radius: 10px; 
      padding: 15px;
      
      /* STICKY & SCROLL LOGIC */
      position: sticky;
      top: 20px; /* Sticks 20px from top of window */
      height: calc(100vh - 40px); /* Max height fits viewport */
      display: flex;
      flex-direction: column;
      z-index: 10;
    }

    .panel-header {
      font-size: 1.2rem; color: var(--accent-blue); margin-bottom: 15px;
      display: flex; justify-content: space-between; align-items: center;
      flex-shrink: 0; /* Prevents header from shrinking */
    }

    /* Target the bench drop zone specifically for scrolling */
    #bench-zone {
      overflow-y: auto;
      flex-grow: 1; /* Takes remaining space */
      padding-right: 5px;
      min-height: 200px;
    }

    /* Custom Scrollbar for Bench */
    #bench-zone::-webkit-scrollbar { width: 8px; }
    #bench-zone::-webkit-scrollbar-track { background: rgba(0,0,0,0.2); border-radius: 4px; }
    #bench-zone::-webkit-scrollbar-thumb { background: var(--accent-blue); border-radius: 4px; }
    #bench-zone::-webkit-scrollbar-thumb:hover { background: var(--accent-hover); }

    /* GRID */
    .squad-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px;
    }

    .subgroup {
      background: rgba(255,255,255,0.03); border: 1px solid #444; border-radius: 8px;
      display: flex; flex-direction: column;
    }
    .subgroup-header {
      background: rgba(0,0,0,0.3); padding: 8px 12px; font-weight: bold;
      border-bottom: 1px solid #444; font-size: 0.9rem; border-radius: 8px 8px 0 0;
    }
    .drop-zone {
      min-height: 60px; padding: 8px; transition: background 0.2s;
    }
    /* Bench zone handled by ID above, generic drop zones grow */
    .subgroup .drop-zone { flex-grow: 1; }

    .drop-zone.drag-over { background: rgba(52, 152, 219, 0.2); border: 1px dashed var(--accent-blue); }

    /* --- PLAYER CARD --- */
    .player-card {
      background: var(--card-bg); border: 1px solid #3d566e; border-radius: 6px;
      padding: 10px; margin-bottom: 10px; cursor: grab; user-select: none;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .player-card:active { cursor: grabbing; }
    
    .card-row { margin-bottom: 6px; }
    .card-row.name-row { font-weight: 700; font-size: 1rem; color: white; display:flex; justify-content:space-between; align-items: center;}
    .card-row.label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 3px; margin-top: 8px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 4px; }
    
    .remove-btn { color: #e74c3c; font-size: 1.2rem; cursor: pointer; padding: 0 5px; opacity: 0.6; }
    .remove-btn:hover { opacity: 1; }

    .emoji-container { display: flex; flex-wrap: wrap; gap: 4px; min-height: 28px; }

    .role-btn {
      padding: 3px 6px; border-radius: 4px; background: rgba(255,255,255,0.05);
      border: 1px solid transparent; cursor: pointer; opacity: 0.6; transition: all 0.2s;
      font-size: 1.2rem; display: flex; align-items: center; justify-content: center;
      min-width: 32px; min-height: 32px;
    }
    .role-btn:hover { opacity: 0.9; background: rgba(255,255,255,0.15); transform: scale(1.1); }
    .role-btn.active {
      opacity: 1; background: rgba(52, 152, 219, 0.25); border-color: var(--accent-blue);
      box-shadow: 0 0 8px rgba(52, 152, 219, 0.4);
    }
    .role-btn img { height: 24px; width:auto; pointer-events: none; }

    .output-section {
      margin-top: 30px; background: var(--glass-dark); padding: 20px;
      border-radius: 10px; border: 1px solid var(--border-color);
    }
    #finalOutput { height: 150px; font-family: monospace; }
  </style>
</head>
<body>

<div class="container">
  <header>
    <h1>GW2 Team Builder</h1>
  </header>

  <div class="controls-area">
    <div class="roster-actions">
      <input type="text" id="rosterName" placeholder="Roster Name">
      <button onclick="saveRoster()">üíæ Save</button>
      <select id="rosterList" onchange="if(this.value) loadRosterByName(this.value)">
        <option value="">-- Load Roster --</option>
      </select>
      <button class="btn-danger" onclick="deleteRoster()">üóëÔ∏è</button>
    </div>

    <p style="color:#aaa; font-size:0.9em; margin-bottom:5px;">Paste your player list below. (Drag & Drop sorting below)</p>
    <textarea id="inputPlayers" placeholder="Example:
<797945111794810930> DiscordUser#1234, üõ°Ô∏è :healheart:
1.Light109, üìß üí´ ‚öîÔ∏è üõ°Ô∏è
#2.Zojja, :QuickDPS: üî•
##3.NewPlayer.1234, :AlacHeal:
Gart Finderboom, üõ°Ô∏è üïµÔ∏è‚Äç‚ôÇÔ∏è"></textarea>
    <div>
      <button onclick="parseAndGenerate()">‚ö° Parse Players</button>
    </div>
  </div>

  <div class="builder-layout">
    <div class="bench-panel">
      <div class="panel-header">
        <span>The Bench</span>
        <span id="benchCount">0</span>
      </div>
      <div id="bench-zone" class="drop-zone" data-group="Unassigned"></div>
    </div>
    <div class="squad-grid" id="squadGrid"></div>
  </div>

  <div class="output-section">
    <div class="panel-header">
      <span>Output</span>
      <button onclick="generateOutput()">üîÑ Refresh Text</button>
    </div>
    <div style="margin-bottom:10px; display:flex; gap:15px;">
      <label><input type="checkbox" id="includeMentions" checked onchange="generateOutput()"> Include Mentions</label>
      <label><input type="checkbox" id="hideNames" onchange="generateOutput()"> Icons Only</label>
    </div>
    <textarea id="finalOutput" readonly onclick="this.select()"></textarea>
  </div>
</div>

<script>
  /* =========================================
     DATA & CONFIG
     ========================================= */
  
  const standardRoles = [
    { name: 'QuickDPS', discordtext: ':QuickDPS:', img: 'https://cdn.discordapp.com/emojis/1038159940164014090.png' },
    { name: 'QuickHeal', discordtext: ':QuickHeal:', img: 'https://cdn.discordapp.com/emojis/1038159941472620655.png' },
    { name: 'AlacHeal', discordtext: ':AlacHeal:', img: 'https://cdn.discordapp.com/emojis/1038159938335277140.png' },
    { name: 'AlacDPS', discordtext: ':AlacDPS:', img: 'https://cdn.discordapp.com/emojis/1038159937391562843.png' },
    { name: 'Heal', discordtext: ':healheart:', img: 'https://cdn.discordapp.com/emojis/1436465472509050982.png' },
    { name: 'Tank', text: 'üõ°Ô∏è' },
    { name: 'DPS', text: '‚öîÔ∏è' },
    { name: 'BoonDPS', text: '‚ö°' },
  ];

  // Strictly decorative (will be removed from NAME, but allowed in ROLES)
  const ignoredEmojis = ['üìß', 'üöπ', 'üö∫', 'üë•', 'üë§', 'üí´', 'üîç', 'üî∞', 'üÜî', 'üî±', 'üå†' ];

  let allPlayers = []; 

  /* =========================================
     INIT
     ========================================= */
  window.onload = function() {
    initSquadGrid();
    populateRosterList();
    const bench = document.getElementById('bench-zone');
    bench.ondragover = handleDragOver;
    bench.ondrop = handleDrop;
  };

  function initSquadGrid() {
    const grid = document.getElementById('squadGrid');
    grid.innerHTML = '';
    for (let i = 1; i <= 10; i++) {
      const col = document.createElement('div');
      col.className = 'subgroup';
      col.innerHTML = `
        <div class="subgroup-header">Group ${i}</div>
        <div class="drop-zone" data-group="Group ${i}" ondragover="handleDragOver(event)" ondrop="handleDrop(event)"></div>
      `;
      grid.appendChild(col);
    }
  }

  /* =========================================
     SMARTER PASTE HANDLER
     ========================================= */
  document.getElementById('inputPlayers').addEventListener('paste', function(e) {
    e.preventDefault();
    const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
    
    // 1. Normalize line endings
    const normalized = clipboardData.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
    const rawLines = normalized.split('\n');
    const outputLines = [];

    // REGEX HELPERS
    const startOfPlayerRegex = /^(\d+[\.\)]|#|‚Ä¢|‚û§)/;
    const continuationStartRegex = /^(\s*,|\s*<|:|[\u{10000}-\u{10FFFF}]|\p{Extended_Pictographic})/u;

    for (let i = 0; i < rawLines.length; i++) {
      let line = rawLines[i].trim();
      if (!line) continue;

      if (outputLines.length === 0) {
        outputLines.push(line);
        continue;
      }

      const prevIndex = outputLines.length - 1;
      const prevLine = outputLines[prevIndex];

      // --- LOGIC GATES ---

      // 1. If line starts with a COMMA, it is ALWAYS a continuation.
      if (line.startsWith(',')) {
        outputLines[prevIndex] = prevLine + line;
        continue;
      }

      // 2. Check for other Continuation Signals (Emojis, brackets)
      if (continuationStartRegex.test(line)) {
        // EDGE CASE: Name starts with Emoji (e.g. "üëë King, ‚öîÔ∏è")
        // If it starts with an emoji BUT has a comma later, assume it's a New Player.
        if (line.includes(',')) {
          outputLines.push(line); // Treat as New Player
        } else {
          outputLines[prevIndex] = prevLine + ' ' + line; // Treat as Merge
        }
        continue;
      }

      // 3. Explicit New Player (Numbers/Bullets)
      if (startOfPlayerRegex.test(line)) {
        outputLines.push(line);
        continue;
      }

      // 4. "Chie" Fix (Contextual Merge)
      if (startOfPlayerRegex.test(prevLine) && !prevLine.includes(',')) {
         outputLines[prevIndex] = prevLine + ' ' + line;
         continue;
      }

      // Default: New Line
      outputLines.push(line);
    }

    const processedText = outputLines.join('\n');
    
    // Insert text
    const input = e.target;
    const start = input.selectionStart;
    const end = input.selectionEnd;
    const currentVal = input.value;
    input.value = currentVal.substring(0, start) + processedText + currentVal.substring(end);
  });

  /* =========================================
     PARSING LOGIC
     ========================================= */
  function parseAndGenerate() {
    const text = document.getElementById('inputPlayers').value.trim();
    if(!text) return;

    allPlayers = [];
    const lines = text.split('\n');
    const prefixRegex = /^(?:#*\d+\.?\s*)/;

    lines.forEach((line, index) => {
      let cleanLine = line.trim().replace(prefixRegex, '');
      if (!cleanLine) return;

      // Split by LAST comma
      const lastCommaIndex = cleanLine.lastIndexOf(',');
      let namePart = cleanLine;
      let rolePart = '';

      if (lastCommaIndex !== -1) {
        namePart = cleanLine.substring(0, lastCommaIndex).trim();
        rolePart = cleanLine.substring(lastCommaIndex + 1).trim();
      }

      // Extract ID & Name
      let discordMention = null;
      let displayName = namePart;

      // Robust ID search
      const idMatch = displayName.match(/(?:<@!?|<|)?(\d{17,20})(?:>|)?/);
      if (idMatch) {
        discordMention = `<@${idMatch[1]}>`;
        displayName = displayName.replace(idMatch[0], '').trim();
      }

      // Clean decorative emojis from Name
      ignoredEmojis.forEach(e => { displayName = displayName.replace(new RegExp(e, 'g'), ''); });
      displayName = displayName.replace(/\s+/g, ' ').trim() || 'Unknown';

      // Parse Offered Roles
      const offeredRoles = [];
      const emojiRegex = /<a?:[a-zA-Z0-9_]+:\d+>|:[a-zA-Z0-9_]+:|\p{Extended_Pictographic}/gu;
      let match;
      while ((match = emojiRegex.exec(rolePart)) !== null) {
        let token = match[0];
        if(!ignoredEmojis.includes(token)) {
          offeredRoles.push(token);
        }
      }

      allPlayers.push({
        id: 'p-' + index + '-' + Date.now(),
        name: displayName,
        discordMention: discordMention,
        offeredRoles: offeredRoles,
        activeRoles: new Set(),
        group: 'Unassigned'
      });
    });

    renderAllCards();
    generateOutput();
  }

  /* =========================================
     RENDERING (UPDATED FOR CUSTOM EMOJIS)
     ========================================= */
  function renderAllCards() {
    document.getElementById('bench-zone').innerHTML = '';
    document.querySelectorAll('.squad-grid .drop-zone').forEach(el => el.innerHTML = '');
    
    let benchCount = 0;
    allPlayers.forEach(player => {
      const card = createPlayerCard(player);
      if(player.group === 'Unassigned') {
        document.getElementById('bench-zone').appendChild(card);
        benchCount++;
      } else {
        const zone = document.querySelector(`.drop-zone[data-group="${player.group}"]`);
        if(zone) zone.appendChild(card);
        else document.getElementById('bench-zone').appendChild(card);
      }
    });
    document.getElementById('benchCount').innerText = benchCount;
  }

  function createPlayerCard(player) {
    const el = document.createElement('div');
    el.className = 'player-card';
    el.draggable = true;
    el.id = player.id;
    
    el.addEventListener('dragstart', (e) => {
      e.dataTransfer.setData('text/plain', player.id);
      el.style.opacity = '0.5';
    });
    el.addEventListener('dragend', () => {
      el.style.opacity = '1';
      generateOutput();
    });

    let html = `<div class="card-row name-row">
        <span>${player.name}</span>
        <span class="remove-btn" onclick="removePlayer('${player.id}')">√ó</span>
      </div>`;

    // Offered Roles
    if(player.offeredRoles.length > 0) {
      html += `<div class="card-row label">Offered</div><div class="emoji-container">`;
      player.offeredRoles.forEach((roleStr) => {
        
        // 1. Is it a specific Custom ID? <a:Name:123>
        const customIdMatch = roleStr.match(/<a?:.+:(\d+)>/);
        
        // 2. Try match standard role by full string OR by shortcode name
        let std = standardRoles.find(r => r.discordtext === roleStr || r.text === roleStr);
        if (!std && customIdMatch) {
           // Fallback: Check if the name inside the ID matches a standard role
           // e.g. < :QuickDPS: 123 >
           const shortCodeMatch = roleStr.match(/:[a-zA-Z0-9_]+:/);
           if (shortCodeMatch) {
              std = standardRoles.find(r => r.discordtext === shortCodeMatch[0]);
           }
        }

        let displayContent = roleStr;
        
        if (customIdMatch) {
           // Use Discord CDN for custom IDs
           const emojiId = customIdMatch[1];
           displayContent = `<img src="https://cdn.discordapp.com/emojis/${emojiId}.png">`;
        } else if (std && std.img) {
           // Use Predefined Standard Image
           displayContent = `<img src="${std.img}">`;
        } else if (roleStr.startsWith(':')) {
           // Text Shortcode
           displayContent = `<span style="font-size:0.7em;">${roleStr.replace(/:/g,'')}</span>`;
        }

        const isActive = player.activeRoles.has(roleStr) ? 'active' : '';
        html += `<div class="role-btn ${isActive}" onclick="toggleRole('${player.id}', '${roleStr}')" title="${roleStr}">${displayContent}</div>`;
      });
      html += `</div>`;
    }

    // Standard Roles
    html += `<div class="card-row label">Assign</div><div class="emoji-container">`;
    standardRoles.forEach(role => {
       const val = role.discordtext || role.text;
       const isActive = player.activeRoles.has(val) ? 'active' : '';
       const content = role.text ? role.text : `<img src="${role.img}">`;
       html += `<div class="role-btn ${isActive}" onclick="toggleRole('${player.id}', '${val}')" title="${role.name}">${content}</div>`;
    });
    html += `</div>`;

    el.innerHTML = html;
    return el;
  }

  function toggleRole(pid, roleValue) {
    const p = allPlayers.find(x => x.id === pid);
    if(!p) return;
    if(p.activeRoles.has(roleValue)) p.activeRoles.delete(roleValue);
    else p.activeRoles.add(roleValue);
    renderAllCards();
    generateOutput();
  }

  function removePlayer(pid) {
    if(!confirm('Remove player?')) return;
    allPlayers = allPlayers.filter(p => p.id !== pid);
    renderAllCards();
    generateOutput();
  }

  function handleDragOver(e) { e.preventDefault(); e.currentTarget.classList.add('drag-over'); }
  function handleDrop(e) {
    e.preventDefault();
    const zone = e.currentTarget;
    zone.classList.remove('drag-over');
    const pid = e.dataTransfer.getData('text/plain');
    const p = allPlayers.find(x => x.id === pid);
    if(p) {
      p.group = zone.dataset.group;
      renderAllCards();
      generateOutput();
    }
  }

  /* =========================================
     OUTPUT
     ========================================= */
  function generateOutput() {
    const includeMentions = document.getElementById('includeMentions').checked;
    const hideNames = document.getElementById('hideNames').checked;
    
    const groups = {};
    const unassigned = [];
    allPlayers.forEach(p => {
      if(p.group === 'Unassigned') unassigned.push(p);
      else {
        if(!groups[p.group]) groups[p.group] = [];
        groups[p.group].push(p);
      }
    });

    let out = '';
    const sortedKeys = Object.keys(groups).sort((a,b) => parseInt(a.replace(/\D/g,'')) - parseInt(b.replace(/\D/g,'')));

    sortedKeys.forEach(g => {
      out += `**${g}**\n`;
      groups[g].forEach(p => {
        let line = '';
        if(includeMentions && p.discordMention) line += p.discordMention + ' ';
        if(!hideNames) line += p.name;
        
        if(p.activeRoles.size > 0) {
          if(line.trim().length > 0) line += ' - ';
          line += Array.from(p.activeRoles).join(' ');
        }
        out += line.trim() + '\n';
      });
      out += '\n';
    });

    if(unassigned.length > 0) {
      out += `**Unassigned** (${unassigned.length})\n`;
      unassigned.forEach(p => out += `${p.name}\n`);
    }

    document.getElementById('finalOutput').value = out.trim();
  }

  /* =========================================
     STORAGE
     ========================================= */
  function getSaved() { return JSON.parse(localStorage.getItem('gw2_rosters_v7') || '{}'); }
  function saveStore(d) { localStorage.setItem('gw2_rosters_v7', JSON.stringify(d)); }
  
  function populateRosterList() {
    const s = document.getElementById('rosterList');
    s.innerHTML = '<option value="">-- Load Roster --</option>';
    const d = getSaved();
    Object.keys(d).forEach(k => {
      const opt = document.createElement('option');
      opt.value = k; opt.textContent = k;
      s.appendChild(opt);
    });
  }

  function saveRoster() {
    const n = document.getElementById('rosterName').value.trim();
    if(!n) return alert('Name required');
    const data = { players: allPlayers, rawText: document.getElementById('inputPlayers').value };
    const store = getSaved();
    store[n] = data;
    saveStore(store);
    populateRosterList();
    document.getElementById('rosterList').value = n;
  }

  function loadRosterByName(n) {
    const store = getSaved();
    if(store[n]) {
      const data = store[n];
      if(typeof data === 'string') {
        document.getElementById('inputPlayers').value = data;
        parseAndGenerate();
      } else {
        document.getElementById('inputPlayers').value = data.rawText || '';
        document.getElementById('rosterName').value = n;
        allPlayers = data.players.map(p => ({
            ...p,
            activeRoles: new Set(p.activeRoles),
        }));
        renderAllCards();
        generateOutput();
      }
    }
  }

  function deleteRoster() {
    const n = document.getElementById('rosterList').value;
    if(!n) return;
    if(!confirm('Delete?')) return;
    const s = getSaved();
    delete s[n];
    saveStore(s);
    populateRosterList();
    document.getElementById('rosterName').value = '';
  }

</script>
</body>
</html>
