<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GW2 Team Builder</title>
  

  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    textarea {
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
      font-family: monospace;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      margin-bottom: 20px;
      cursor: pointer;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
      white-space: nowrap;
    }
    button:hover {
      background: #0056b3;
    }
    
    .player-item {
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: grid;
      grid-template-columns: minmax(120px, 150px) 1fr auto;
      gap: 8px;
      align-items: center;
    }

    .player-name {
      font-weight: bold;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      min-width: 0;
      font-size: .8em;
    }
    
    .player-emojis {
      display: flex;
      gap: 4px;
      font-size: 20px;
      flex-wrap: wrap;
      justify-content: flex-end;
    }
    .player-emojis span {
      padding: 2px 3px;
      border-radius: 3px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 24px;
      min-height: 24px;
    }
    .player-emojis span.selected {
      background: #e6f2ff;
      border: 1px solid #007BFF;
    }

    .role-selector {
      display: flex;
      gap: 5px;
      align-items: center;
      justify-self: end;
    }
    .role-icon {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid transparent;
      padding: 1px;
      font-size: 22px;
      background: white;
      border-radius: 4px;
    }
    .role-icon.selected {
      border: 2px solid #007BFF;
      background: #e6f2ff;
    }
    .role-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    #groupSummary {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .group-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .group-container {
      flex: 1;
      min-width: 250px;
      background: #fafafa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #007BFF;
    }
    .group-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #222;
      font-size: 1.05em;
    }
    .assigned-player {
      padding: 3px 0;
      font-family: monospace;
      font-size: 0.95em;
      line-height: 1.4;
    }
    .assigned-player img {
      vertical-align: middle;
      height: 1em;
      width: auto;
      margin-right: 4px;
    }

    .options-row {
      margin: 20px 0 10px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
      padding: 10px 0;
      border-top: 1px solid #eee;
    }
    .options-row label {
      display: flex;
      align-items: center;
      gap: 5px;
      cursor: pointer;
    }

    select.unassigned {
      color: #888 !important;
      font-style: italic;
    }

    .roster-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin: 10px 0;
      align-items: center;
    }
    .roster-controls input,
    .roster-controls select {
      padding: 6px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .roster-controls input {
      flex: 1;
      min-width: 120px;
    }
    .roster-controls select {
      min-width: 140px;
    }

    @media (max-width: 768px) {
      .group-container {
        min-width: 100%;
      }
      .roster-controls {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öîÔ∏è Guild Wars 2 Team Builder</h2> 
    <p>Paste your player list below. Format: <code>[Optional &ltDiscordID with or without @&gt] Name, üõ°Ô∏è :healheart:</code></p>
    <p>Decorative emojis (üìß, üí´, üöπ, etc.) in names are auto-removed.</p>

    <textarea id="inputPlayers" placeholder="Example:
<797945111794810930> DiscordUser#1234, üõ°Ô∏è :healheart:
1.Light109, üìß üí´ ‚öîÔ∏è üõ°Ô∏è
#2.Zojja, :QuickDPS: üî•
##3.NewPlayer.1234, :AlacHeal:
Gart Finderboom, üõ°Ô∏è üïµÔ∏è‚Äç‚ôÇÔ∏è"></textarea>

    <div class="roster-controls">
      <input type="text" id="rosterName" placeholder="Roster name">
      <button onclick="saveRoster()">Save/Update Roster</button>
      
      <select id="rosterList" onchange="if(this.value) loadRosterByName(this.value)">
        <option value="">-- Saved Rosters --</option>
      </select>
      <button onclick="deleteRoster()">Delete</button>
    </div>

    <button onclick="parsePlayers()">Parse Players</button>

    <div id="outputContainer"></div>
    <small><a href="https://gartkb.github.io/Garts-Great-Tools/">Gart's Great Tools</a></small>
  </div>

  <script>
    /* =========================================
       SMART PASTE LOGIC (Fixes Discord Lines)
       ========================================= */
    document.getElementById('inputPlayers').addEventListener('paste', function(e) {
      // Prevent the default paste behavior so we can modify the text first
      e.preventDefault();

      // Get the text from the clipboard
      const clipboardData = (e.clipboardData || window.clipboardData).getData('text');
      
      // Run the cleaner function
      const cleanedText = cleanDiscordPaste(clipboardData);

      // Insert the cleaned text at the cursor position
      const input = e.target;
      const start = input.selectionStart;
      const end = input.selectionEnd;
      const currentText = input.value;
      
      const before = currentText.substring(0, start);
      const after = currentText.substring(end, currentText.length);
      
      input.value = before + cleanedText + after;
      
      // Restore cursor position after the inserted text
      input.selectionStart = input.selectionEnd = start + cleanedText.length;
    });

    function cleanDiscordPaste(text) {
      // Normalize line endings
      const normalized = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
      const lines = normalized.split('\n');
      const output = [];

      for (let i = 0; i < lines.length; i++) {
        let line = lines[i].trim();
        if (!line) continue; // Skip empty lines, but don't merge them

        // If this is the first line, just add it
        if (output.length === 0) {
          output.push(line);
          continue;
        }

        const prevLineIndex = output.length - 1;
        const prevLine = output[prevLineIndex];

        // --- CHECK 1: Line starts with a comma (e.g. ", üìß") ---
        if (line.startsWith(',')) {
          output[prevLineIndex] = prevLine + line;
          continue;
        }

        // --- CHECK 2: Line contains NO letters/numbers (Only emojis/symbols) ---
        // Discord often pushes emojis to a new line.
        // Matches if the line has no A-Z or 0-9 characters.
        if (!/[a-zA-Z0-9]/.test(line)) {
          output[prevLineIndex] = prevLine + ' ' + line;
          continue;
        }

        // --- CHECK 3: Previous line looks like a prefix (e.g. "10.üí´") ---
        // If the previous line was just a number+dot+symbols, and current line is text, merge UP.
        // Regex: Start -> Digits -> Dot -> Optional non-word chars -> End
        if (/^\d+\.[^\w]*$/.test(prevLine)) {
           output[prevLineIndex] = prevLine + ' ' + line;
           continue;
        }

        // If no merge conditions met, add as new line
        output.push(line);
      }

      return output.join('\n');
    }

    /* =========================================
       EXISTING LOGIC BELOW
       ========================================= */

    const predefinedRoles = [
      { name: 'QuickDPS', discordtext: ':QuickDPS:', img: 'https://cdn.discordapp.com/emojis/1038159940164014090.png' },
      { name: 'QuickHeal', discordtext: ':QuickHeal:', img: 'https://cdn.discordapp.com/emojis/1038159941472620655.png' },
      { name: 'AlacHeal', discordtext: ':AlacHeal:', img: 'https://cdn.discordapp.com/emojis/1038159938335277140.png' },
      { name: 'AlacDPS', discordtext: ':AlacDPS:', img: 'https://cdn.discordapp.com/emojis/1038159937391562843.png' },
      { name: 'DPS', text: '‚öîÔ∏è' },
      { name: 'Heals', discordtext: ':healheart:', img: 'https://cdn.discordapp.com/emojis/1436465472509050982.png' },
      { name: 'Tank', text: 'üõ°Ô∏è' },
      { name: 'BoonDPS', text: '‚ö°' },
    ];

    function getRoleDisplayHtml(roleName) {
      const role = predefinedRoles.find(r => r.name === roleName);
      if (!role) return roleName;

      if (role.text) {
        return `${role.text} ${role.name}`;
      } else {
        return `<img src="${role.img}" alt="${role.discordtext ?? role.name}" title="${role.name}"> ${role.name}`;
      }
    }

    let playerAssignments = [];
    const nonRoleEmojis = ['üöπ', 'üö∫', 'üë•', 'üë§', 'üí´', 'üìß'];

    function parsePlayers() {
      const text = document.getElementById('inputPlayers').value.trim();
      const lines = text.split('\n').filter(line => line.trim());

      const container = document.getElementById('outputContainer');
      container.innerHTML = '';
      playerAssignments = [];

      // Regex to remove optional numbered prefix like "1.", "#2.", "##10.", etc.
      const prefixRegex = /^(?:#*\d+\.?\s*)/;

      lines.forEach((line, index) => {
        let cleanLine = line.trim();
        if (!cleanLine) return;

        // Step 1: Remove optional prefix (e.g., "1.", "#3.", "##10.")
        cleanLine = cleanLine.replace(prefixRegex, '');

        // Step 2: Require a comma to split name and emojis
        const lastCommaIndex = cleanLine.lastIndexOf(',');
        if (lastCommaIndex === -1) {
          console.warn(`Skipping invalid line (no comma): "${line}"`);
          return;
        }

        const namePart = cleanLine.substring(0, lastCommaIndex).trim();
        const emojiPart = cleanLine.substring(lastCommaIndex + 1).trim();

        // Step 3: Extract Discord ID if present
        let discordMention = null;
        let name = namePart;
        const discordIdMatch = namePart.match(/^<@?(\d{17,20})>\s+(.+)$/);
        if (discordIdMatch) {
          const rawId = discordIdMatch[1];
          name = discordIdMatch[2];
          discordMention = `<@${rawId}>`;
        }

        // Step 4: Strip decorative emojis and normalize name
        nonRoleEmojis.forEach(e => {
          name = name.replace(new RegExp(e, 'g'), '');
        });
        name = name.replace(/\s+/g, ' ').trim() || 'Unknown';

        // Step 5: Tokenize emojiPart
        const tokens = emojiPart.split(/\s+/).filter(t => t);

        const assignment = {
          id: index,
          name: name,
          discordMention: discordMention,
          group: 'Unassigned',
          customRoles: new Set(),
          predefinedRoles: new Set()
        };
        playerAssignments.push(assignment);

        // --- Build UI element ---
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'player-name';
        nameDiv.textContent = name;

        const emojisDiv = document.createElement('div');
        emojisDiv.className = 'player-emojis';

        tokens.forEach(token => {
          if (nonRoleEmojis.includes(token) || token === 'üìß') return;

          const matchedRole = predefinedRoles.find(r => r.discordtext === token);
          if (matchedRole) {
            const span = document.createElement('span');
            span.title = matchedRole.name;
            if (matchedRole.text) {
              span.textContent = matchedRole.text;
            } else {
              const img = document.createElement('img');
              img.src = matchedRole.img;
              img.alt = matchedRole.name;
              span.appendChild(img);
            }
            span.addEventListener('click', () => {
              span.classList.toggle('selected');
              const set = assignment.predefinedRoles;
              if (span.classList.contains('selected')) {
                set.add(matchedRole.name);
              } else {
                set.delete(matchedRole.name);
              }
              renderGroups();
            });
            emojisDiv.appendChild(span);
            return;
          }

          // Check if it's a Unicode emoji
          if (/^\p{Extended_Pictographic}+(\uFE0F|\u200D\p{Extended_Pictographic})*$/u.test(token)) {
            const span = document.createElement('span');
            span.textContent = token;
            span.addEventListener('click', () => {
              span.classList.toggle('selected');
              const set = assignment.customRoles;
              if (span.classList.contains('selected')) {
                set.add(token);
              } else {
                set.delete(token);
              }
              renderGroups();
            });
            emojisDiv.appendChild(span);
          }
          // Silently ignore unrecognized tokens (e.g., typos)
        });

        // Group selector
        const groupSelect = document.createElement('select');
        const unassignedOpt = document.createElement('option');
        unassignedOpt.value = 'Unassigned';
        unassignedOpt.textContent = 'Unassigned';
        unassignedOpt.selected = true;
        groupSelect.appendChild(unassignedOpt);

        for (let i = 1; i <= 10; i++) {
          const opt = document.createElement('option');
          opt.value = `Group ${i}`;
          opt.textContent = `Group ${i}`;
          groupSelect.appendChild(opt);
        }

        groupSelect.className = 'unassigned';
        groupSelect.addEventListener('change', (e) => {
          assignment.group = e.target.value;
          e.target.className = e.target.value === 'Unassigned' ? 'unassigned' : '';
          renderGroups();
        });

        // Role selector (predefined)
        const roleSelector = document.createElement('div');
        roleSelector.className = 'role-selector';
        predefinedRoles.forEach(role => {
          const el = document.createElement('span');
          el.className = 'role-icon';
          el.title = role.name;
          if (role.text) {
            el.textContent = role.text;
          } else {
            const img = document.createElement('img');
            img.src = role.img;
            img.alt = role.name;
            el.appendChild(img);
          }
          el.addEventListener('click', () => {
            el.classList.toggle('selected');
            const set = assignment.predefinedRoles;
            if (el.classList.contains('selected')) {
              set.add(role.name);
            } else {
              set.delete(role.name);
            }
            renderGroups();
          });
          roleSelector.appendChild(el);
        });

        const groupWrapper = document.createElement('div');
        groupWrapper.style.display = 'flex';
        groupWrapper.style.alignItems = 'center';
        groupWrapper.style.gap = '4px';
        groupWrapper.appendChild(document.createTextNode('Group:'));
        groupWrapper.appendChild(groupSelect);
        
        const rightBlock = document.createElement('div');
        rightBlock.style.display = 'flex';
        rightBlock.style.alignItems = 'center';
        rightBlock.style.gap = '12px';
        rightBlock.appendChild(groupWrapper);
        rightBlock.appendChild(roleSelector);
        
        playerItem.appendChild(nameDiv);
        playerItem.appendChild(emojisDiv);
        playerItem.appendChild(rightBlock);
        container.appendChild(playerItem); 
      });

      // Options row
      const optionsDiv = document.createElement('div');
      optionsDiv.className = 'options-row';
      optionsDiv.innerHTML = `
        <label>
          <input type="checkbox" id="includeMentions"> Include discord mentions
        </label>
        <label>
          <input type="checkbox" id="hideNames"> Hide text names
        </label>
      `;
      container.appendChild(optionsDiv);

      document.getElementById('includeMentions').addEventListener('change', renderGroups);
      document.getElementById('hideNames').addEventListener('change', renderGroups);

      renderGroups();
    }

    function renderGroups() {
      const existing = document.getElementById('groupSummary');
      if (existing) existing.remove();

      const groups = {};
      playerAssignments.forEach(p => {
        if (p.group === 'Unassigned') return;
        const g = p.group;
        if (!groups[g]) groups[g] = [];
        groups[g].push(p);
      });

      const summaryDiv = document.createElement('div');
      summaryDiv.id = 'groupSummary';

      const groupNames = Array.from({length: 10}, (_, i) => `Group ${i + 1}`);
      const activeGroups = groupNames.filter(name => groups[name] && groups[name].length > 0);

      for (let i = 0; i < activeGroups.length; i += 2) {
        const row = document.createElement('div');
        row.className = 'group-row';

        const g1 = activeGroups[i];
        const col1 = createGroupElement(g1, groups[g1]);
        row.appendChild(col1);

        if (i + 1 < activeGroups.length) {
          const g2 = activeGroups[i + 1];
          const col2 = createGroupElement(g2, groups[g2]);
          row.appendChild(col2);
        }

        summaryDiv.appendChild(row);
      }

      document.getElementById('outputContainer').appendChild(summaryDiv);
    }

    function createGroupElement(groupName, players) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'group-container';

      const header = document.createElement('div');
      header.className = 'group-header';
      header.textContent = `${groupName} (${players.length} player${players.length !== 1 ? 's' : ''})`;
      groupDiv.appendChild(header);

      const includeMentions = document.getElementById('includeMentions')?.checked || false;
      const hideNames = document.getElementById('hideNames')?.checked || false;

      players.forEach(player => {
        const customRoles = Array.from(player.customRoles);
        const predefinedHtml = Array.from(player.predefinedRoles).map(name => getRoleDisplayHtml(name));
        const allParts = [...customRoles, ...predefinedHtml];
        const rolesHtml = allParts.length > 0 ? allParts.join(', ') : 'None';

        let displayName = '';

        if (includeMentions && player.discordMention) {
          displayName += player.discordMention;
          if (!hideNames) displayName += ' ';
        }

        if (!hideNames) {
          displayName += player.name;
        }

        const line = document.createElement('div');
        line.className = 'assigned-player';
        line.innerHTML = displayName ? `${displayName} ‚Üí ${rolesHtml}` : `‚Üí ${rolesHtml}`;
        groupDiv.appendChild(line);
      });

      return groupDiv;
    }

    // ================ ROSTER MANAGEMENT ================

    window.addEventListener('DOMContentLoaded', populateRosterList);

    function getSavedRosters() {
      const data = localStorage.getItem('gw2Rosters');
      return data ? JSON.parse(data) : {};
    }


    
    function saveRosters(rosters) {
      localStorage.setItem('gw2Rosters', JSON.stringify(rosters));
    }

    function populateRosterList() {
      const select = document.getElementById('rosterList');
      const current = select.value;
      select.innerHTML = '<option value="">-- Saved Rosters --</option>';
      const rosters = getSavedRosters();
      Object.keys(rosters).sort().forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        select.appendChild(opt);
      });
      if (current && rosters[current]) {
        select.value = current;
      }
    }

    function saveRoster() {
      const name = document.getElementById('rosterName').value.trim();
      if (!name) {
        alert('Please enter a roster name.');
        return;
      }
      const content = document.getElementById('inputPlayers').value;
      const rosters = getSavedRosters();
      rosters[name] = content;
      saveRosters(rosters);
      populateRosterList();
      document.getElementById('rosterList').value = name;
      alert(`Roster "${name}" saved.`);
    }

    function loadRosterByName(name) {
      const rosters = getSavedRosters();
      if (rosters[name] !== undefined) {
        document.getElementById('inputPlayers').value = rosters[name];
        document.getElementById('rosterName').value = name;
      }
    }

    
    

    function renameRoster() {
      const oldName = document.getElementById('rosterList').value;
      const newName = document.getElementById('rosterName').value.trim();
      if (!oldName) {
        alert('Select a roster to rename.');
        return;
      }
      if (!newName || newName === oldName) {
        alert('Enter a new, different roster name.');
        return;
      }
      const rosters = getSavedRosters();
      if (rosters[oldName] === undefined) {
        alert('Roster not found.');
        return;
      }
      rosters[newName] = rosters[oldName];
      delete rosters[oldName];
      saveRosters(rosters);
      populateRosterList();
      document.getElementById('rosterList').value = newName;
      alert(`Roster renamed to "${newName}".`);
    }

    function deleteRoster() {
      const name = document.getElementById('rosterList').value;
      if (!name) {
        alert('Select a roster to delete.');
        return;
      }
      if (!confirm(`Delete roster "${name}"? This cannot be undone.`)) return;
      const rosters = getSavedRosters();
      delete rosters[name];
      saveRosters(rosters);
      populateRosterList();
      document.getElementById('rosterName').value = '';
      alert(`Roster "${name}" deleted.`);
    }
  </script>
</body>

</html>
