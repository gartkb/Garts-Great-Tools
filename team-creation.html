<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>GW2 Team Builder</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background: #f5f5f5;
    }
    .container {
      max-width: 1000px;
      margin: auto;
    }
    textarea {
      width: 100%;
      height: 150px;
      margin-bottom: 10px;
      font-family: monospace;
      padding: 8px;
      box-sizing: border-box;
    }
    button {
      padding: 8px 16px;
      margin-bottom: 20px;
      cursor: pointer;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 4px;
    }
    button:hover {
      background: #0056b3;
    }

    .player-item {
      background: white;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 6px;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 8px;
    }
    .player-name {
      font-weight: bold;
      flex: 1;
      min-width: 180px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .player-emojis {
      display: flex;
      gap: 4px;
      font-size: 20px;
    }
    .player-emojis span {
      padding: 2px 3px;
      border-radius: 3px;
      cursor: pointer;
    }
    .player-emojis span.selected {
      background: #e6f2ff;
      border: 1px solid #007BFF;
    }

    .role-selector {
      display: flex;
      gap: 5px;
      align-items: center;
    }
    .role-icon {
      width: 34px;
      height: 34px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: 1px solid transparent;
      padding: 1px;
      font-size: 22px;
      background: white;
      border-radius: 4px;
    }
    .role-icon.selected {
      border: 2px solid #007BFF;
      background: #e6f2ff;
    }
    .role-icon img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    #groupSummary {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    .group-row {
      display: flex;
      gap: 20px;
      flex-wrap: wrap;
    }
    .group-container {
      flex: 1;
      min-width: 250px;
      background: #fafafa;
      padding: 12px;
      border-radius: 6px;
      border-left: 3px solid #007BFF;
    }
    .group-header {
      font-weight: bold;
      margin-bottom: 8px;
      color: #222;
      font-size: 1.05em;
    }
    .assigned-player {
      padding: 3px 0;
      font-family: monospace;
      font-size: 0.95em;
      line-height: 1.4;
    }
    .assigned-player img {
      vertical-align: middle;
      height: 1em;
      width: auto;
      margin-right: 4px;
    }

    @media (max-width: 768px) {
      .group-container {
        min-width: 100%;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>‚öîÔ∏è Guild Wars 2 Team Builder</h2>
    <p>Paste your player list below. Emojis after üìß (or at end) are shown and clickable.</p>

    <textarea id="inputPlayers" placeholder="Example:
1.DethKnighter666.8954 üöπ                              üìß
2.Terrence (Jason.2014) üöπ                         üìß  üê•
3.Zojja (Viblise.8417)                        üìß  üê•
4.light109 (humanfemale.9635) üöπ                       üìß  üî•
5.johnnytwotoes.8214                                 üìß  üî•
6.üí´Gart Finderboom.5020                       üìß  üõ°Ô∏è  üî•  üê•  üïµÔ∏è‚Äç‚ôÇÔ∏è
7.üí´SkielaBaby.4201                                üìß"></textarea>

    <button onclick="parsePlayers()">Parse Players</button>

    <div id="outputContainer"></div>
  </div>

  <script>
    const predefinedRoles = [
      { name: 'QuickDPS', img: 'https://cdn.discordapp.com/emojis/1038159940164014090.png' },
      { name: 'QuickHeal', img: 'https://cdn.discordapp.com/emojis/1038159941472620655.png' },
      { name: 'AlacHeal', img: 'https://cdn.discordapp.com/emojis/1038159938335277140.png' },
      { name: 'AlacDPS', img: 'https://cdn.discordapp.com/emojis/1038159937391562843.png' },
      { name: 'DPS', text: '‚öîÔ∏è' },
      { name: 'Heals', img: 'https://cdn.discordapp.com/emojis/1436465472509050982.png' },
      { name: 'Tank', text: 'üõ°Ô∏è' },
      { name: 'BoonDPS', text: '‚ûï' },
    ];

    // Create a function to get HTML for a role
    function getRoleDisplayHtml(roleName) {
      const role = predefinedRoles.find(r => r.name === roleName);
      if (!role) return roleName;

      if (role.text) {
        return `${role.text} ${role.name}`;
      } else {
        // Return image + name
        return `<img src="${role.img}" alt="${role.name}" title="${role.name}"> ${role.name}`;
      }
    }

    let playerAssignments = [];

    // Emojis to remove from the player name (but not from role selection)
    const nonRoleEmojis = ['üöπ', 'üö∫', 'üë•', 'üë§', 'üí´'];

    function parsePlayers() {
      const text = document.getElementById('inputPlayers').value.trim();
      const lines = text.split('\n').filter(line => line.trim());

      const container = document.getElementById('outputContainer');
      container.innerHTML = '';
      playerAssignments = [];

      lines.forEach((line, index) => {
        // Remove leading number and dot (e.g., "1.", "10.")
        let cleanLine = line.replace(/^\d+\.\s*/, '').trim();

        // Find üìß to split name and suffix
        const emailIndex = cleanLine.indexOf('üìß');
        let namePart, suffixPart;

        if (emailIndex !== -1) {
          namePart = cleanLine.substring(0, emailIndex).trim();
          suffixPart = cleanLine.substring(emailIndex); // Keep üìß and everything after
        } else {
          // If no üìß, treat last ~15 chars as potential emoji zone
          const cutoff = Math.max(0, cleanLine.length - 15);
          suffixPart = cleanLine.substring(cutoff);
          namePart = cleanLine.substring(0, cutoff).trim();
        }

        // Clean name: remove non-role emojis that are decorative
        let name = namePart;
        nonRoleEmojis.forEach(e => {
          // Remove all occurrences (some may appear in name)
          name = name.replace(new RegExp(e, 'g'), '');
        });
        name = name.replace(/\s+/g, ' ').trim() || 'Unknown';

        const assignment = {
          id: index,
          name: name,
          group: 'Group 1',
          customRoles: new Set(),
          predefinedRoles: new Set()
        };
        playerAssignments.push(assignment);

        // --- Build UI element ---
        const playerItem = document.createElement('div');
        playerItem.className = 'player-item';

        const nameDiv = document.createElement('div');
        nameDiv.className = 'player-name';
        nameDiv.textContent = name;

        const emojisDiv = document.createElement('div');
        emojisDiv.className = 'player-emojis';

        // üåü NEW: Extract FULL emoji sequences (including üõ°Ô∏è, üïµÔ∏è‚Äç‚ôÇÔ∏è, etc.)
        const emojiRegex = /\p{Extended_Pictographic}(?:\uFE0F|\u200D\p{Extended_Pictographic}|\u200D[\u2640\u2642]\uFE0F)*/gu;
        const emojiMatches = [...suffixPart.matchAll(emojiRegex)];

        emojiMatches.forEach(match => {
          const emoji = match[0];

          // Skip emojis that are just decorative (not roles)
          if (nonRoleEmojis.includes(emoji)) {
            return;
          }

          // Also skip üìß (we don't want it as a clickable role)
          if (emoji === 'üìß') {
            return;
          }

          const span = document.createElement('span');
          span.textContent = emoji;
          span.addEventListener('click', () => {
            span.classList.toggle('selected');
            if (span.classList.contains('selected')) {
              assignment.customRoles.add(emoji);
            } else {
              assignment.customRoles.delete(emoji);
            }
            renderGroups();
          });
          emojisDiv.appendChild(span);
        });

        // Group selector
        const groupSelect = document.createElement('select');
        for (let i = 1; i <= 10; i++) {
          const opt = document.createElement('option');
          opt.value = `Group ${i}`;
          opt.textContent = `Group ${i}`;
          if (i === 1) opt.selected = true;
          groupSelect.appendChild(opt);
        }
        groupSelect.addEventListener('change', (e) => {
          assignment.group = e.target.value;
          renderGroups();
        });

        // Predefined role selector
        const roleSelector = document.createElement('div');
        roleSelector.className = 'role-selector';
        predefinedRoles.forEach(role => {
          const el = document.createElement('span');
          el.className = 'role-icon';
          el.title = role.name;
          if (role.text) {
            el.textContent = role.text;
          } else {
            const img = document.createElement('img');
            img.src = role.img;
            img.alt = role.name;
            el.appendChild(img);
          }
          el.addEventListener('click', () => {
            el.classList.toggle('selected');
            if (el.classList.contains('selected')) {
              assignment.predefinedRoles.add(role.name);
            } else {
              assignment.predefinedRoles.delete(role.name);
            }
            renderGroups();
          });
          roleSelector.appendChild(el);
        });

        // Assemble player item
        playerItem.appendChild(nameDiv);
        playerItem.appendChild(emojisDiv);

        const groupLabel = document.createElement('span');
        groupLabel.textContent = 'Group:';
        playerItem.appendChild(groupLabel);
        playerItem.appendChild(groupSelect);
        playerItem.appendChild(roleSelector);

        container.appendChild(playerItem);
      });

      renderGroups();
    }

    function renderGroups() {
      const existing = document.getElementById('groupSummary');
      if (existing) existing.remove();

      const groups = {};
      playerAssignments.forEach(p => {
        const g = p.group || 'Group 1';
        if (!groups[g]) groups[g] = [];
        groups[g].push(p);
      });

      const summaryDiv = document.createElement('div');
      summaryDiv.id = 'groupSummary';

      const groupNames = Array.from({length: 10}, (_, i) => `Group ${i + 1}`);
      const activeGroups = groupNames.filter(name => groups[name] && groups[name].length > 0);

      for (let i = 0; i < activeGroups.length; i += 2) {
        const row = document.createElement('div');
        row.className = 'group-row';

        const g1 = activeGroups[i];
        const col1 = createGroupElement(g1, groups[g1]);
        row.appendChild(col1);

        if (i + 1 < activeGroups.length) {
          const g2 = activeGroups[i + 1];
          const col2 = createGroupElement(g2, groups[g2]);
          row.appendChild(col2);
        }

        summaryDiv.appendChild(row);
      }

      document.getElementById('outputContainer').appendChild(summaryDiv);
    }

    function createGroupElement(groupName, players) {
      const groupDiv = document.createElement('div');
      groupDiv.className = 'group-container';

      const header = document.createElement('div');
      header.className = 'group-header';
      header.textContent = `${groupName} (${players.length} player${players.length !== 1 ? 's' : ''})`;
      groupDiv.appendChild(header);

      players.forEach(player => {
        const customRoles = Array.from(player.customRoles); // e.g., ['üî•', 'üõ°Ô∏è']
        const predefinedHtml = Array.from(player.predefinedRoles).map(name => {
          return getRoleDisplayHtml(name);
        });

        const allParts = [...customRoles, ...predefinedHtml];
        const rolesHtml = allParts.length > 0 ? allParts.join(', ') : 'None';

        const line = document.createElement('div');
        line.className = 'assigned-player';
        line.innerHTML = `${player.name} ‚Üí ${rolesHtml}`;
        groupDiv.appendChild(line);
      });

      return groupDiv;
    }
  </script>
</body>
</html>
